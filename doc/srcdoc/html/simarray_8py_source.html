<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libStorageMgmt: simarray.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>simarray.py</h1><a href="simarray_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceplugin_1_1sim_1_1simarray.html">00001</a> <span class="comment"># Copyright (C) 2011-2015 Red Hat, Inc.</span>
<a name="l00002"></a>00002 <span class="comment"># This library is free software; you can redistribute it and/or</span>
<a name="l00003"></a>00003 <span class="comment"># modify it under the terms of the GNU Lesser General Public</span>
<a name="l00004"></a>00004 <span class="comment"># License as published by the Free Software Foundation; either</span>
<a name="l00005"></a>00005 <span class="comment"># version 2.1 of the License, or any later version.</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment"># This library is distributed in the hope that it will be useful,</span>
<a name="l00008"></a>00008 <span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00009"></a>00009 <span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00010"></a>00010 <span class="comment"># Lesser General Public License for more details.</span>
<a name="l00011"></a>00011 <span class="comment">#</span>
<a name="l00012"></a>00012 <span class="comment"># You should have received a copy of the GNU Lesser General Public</span>
<a name="l00013"></a>00013 <span class="comment"># License along with this library; If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00014"></a>00014 <span class="comment">#</span>
<a name="l00015"></a>00015 <span class="comment"># Author: tasleson</span>
<a name="l00016"></a>00016 <span class="comment">#         Gris Ge &lt;fge@redhat.com&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keyword">import</span> random
<a name="l00019"></a>00019 <span class="keyword">import</span> tempfile
<a name="l00020"></a>00020 <span class="keyword">import</span> os
<a name="l00021"></a>00021 <span class="keyword">import</span> time
<a name="l00022"></a>00022 <span class="keyword">import</span> sqlite3
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">from</span> lsm <span class="keyword">import</span> (size_human_2_size_bytes)
<a name="l00026"></a>00026 <span class="keyword">from</span> lsm <span class="keyword">import</span> (System, Volume, Disk, Pool, FileSystem, AccessGroup,
<a name="l00027"></a>00027                  FsSnapshot, NfsExport, md5, LsmError, TargetPort,
<a name="l00028"></a>00028                  ErrorNumber, JobStatus)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="keyword">def </span>_handle_errors(method):
<a name="l00032"></a>00032     <span class="keyword">def </span>wrapper(*args, **kargs):
<a name="l00033"></a>00033         <span class="keywordflow">try</span>:
<a name="l00034"></a>00034             <span class="keywordflow">return</span> method(*args, **kargs)
<a name="l00035"></a>00035         <span class="keywordflow">except</span> sqlite3.OperationalError <span class="keyword">as</span> sql_error:
<a name="l00036"></a>00036             <span class="keywordflow">if</span> type(args[0]) <span class="keywordflow">is</span> SimArray <span class="keywordflow">and</span> hasattr(args[0], <span class="stringliteral">&apos;bs_obj&apos;</span>):
<a name="l00037"></a>00037                 args[0].bs_obj.trans_rollback()
<a name="l00038"></a>00038             <span class="keywordflow">if</span> str(sql_error) == <span class="stringliteral">&apos;database is locked&apos;</span>:
<a name="l00039"></a>00039                 <span class="keywordflow">raise</span> LsmError(
<a name="l00040"></a>00040                     ErrorNumber.TIMEOUT,
<a name="l00041"></a>00041                     <span class="stringliteral">&quot;Timeout to require lock on state file&quot;</span>)
<a name="l00042"></a>00042             <span class="keywordflow">raise</span> LsmError(
<a name="l00043"></a>00043                 ErrorNumber.PLUGIN_BUG,
<a name="l00044"></a>00044                 <span class="stringliteral">&quot;Got unexpected error from sqlite3: %s&quot;</span> % str(sql_error))
<a name="l00045"></a>00045         <span class="keywordflow">except</span> LsmError:
<a name="l00046"></a>00046             <span class="keywordflow">if</span> type(args[0]) <span class="keywordflow">is</span> SimArray <span class="keywordflow">and</span> hasattr(args[0], <span class="stringliteral">&apos;bs_obj&apos;</span>):
<a name="l00047"></a>00047                 args[0].bs_obj.trans_rollback()
<a name="l00048"></a>00048             <span class="keywordflow">raise</span>
<a name="l00049"></a>00049         <span class="keywordflow">except</span> Exception <span class="keyword">as</span> base_error:
<a name="l00050"></a>00050             <span class="keywordflow">if</span> type(args[0]) <span class="keywordflow">is</span> SimArray <span class="keywordflow">and</span> hasattr(args[0], <span class="stringliteral">&apos;bs_obj&apos;</span>):
<a name="l00051"></a>00051                 args[0].bs_obj.trans_rollback()
<a name="l00052"></a>00052             <span class="keywordflow">raise</span> LsmError(
<a name="l00053"></a>00053                 ErrorNumber.PLUGIN_BUG,
<a name="l00054"></a>00054                 <span class="stringliteral">&quot;Got unexpected error: %s&quot;</span> % str(base_error))
<a name="l00055"></a>00055     <span class="keywordflow">return</span> wrapper
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">def </span>_random_vpd():
<a name="l00059"></a>00059     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00060"></a>00060 <span class="stringliteral">    Generate a random VPD83 NAA_Type3 ID</span>
<a name="l00061"></a>00061 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00062"></a>00062     vpd = [<span class="stringliteral">&apos;60&apos;</span>]
<a name="l00063"></a>00063     <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(0, 15):
<a name="l00064"></a>00064         vpd.append(str(<span class="stringliteral">&apos;%02x&apos;</span> % (random.randint(0, 255))))
<a name="l00065"></a>00065     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>.join(vpd)
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_pool_r_a_i_d.html">00068</a> <span class="keyword">class </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_pool_r_a_i_d.html">PoolRAID</a>(object):
<a name="l00069"></a>00069     _RAID_DISK_CHK = {
<a name="l00070"></a>00070         Volume.RAID_TYPE_JBOD: <span class="keyword">lambda</span> x: x &gt; 0,
<a name="l00071"></a>00071         Volume.RAID_TYPE_RAID0: <span class="keyword">lambda</span> x: x &gt; 0,
<a name="l00072"></a>00072         Volume.RAID_TYPE_RAID1: <span class="keyword">lambda</span> x: x == 2,
<a name="l00073"></a>00073         Volume.RAID_TYPE_RAID3: <span class="keyword">lambda</span> x: x &gt;= 3,
<a name="l00074"></a>00074         Volume.RAID_TYPE_RAID4: <span class="keyword">lambda</span> x: x &gt;= 3,
<a name="l00075"></a>00075         Volume.RAID_TYPE_RAID5: <span class="keyword">lambda</span> x: x &gt;= 3,
<a name="l00076"></a>00076         Volume.RAID_TYPE_RAID6: <span class="keyword">lambda</span> x: x &gt;= 4,
<a name="l00077"></a>00077         Volume.RAID_TYPE_RAID10: <span class="keyword">lambda</span> x: x &gt;= 4 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00078"></a>00078         Volume.RAID_TYPE_RAID15: <span class="keyword">lambda</span> x: x &gt;= 6 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00079"></a>00079         Volume.RAID_TYPE_RAID16: <span class="keyword">lambda</span> x: x &gt;= 8 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00080"></a>00080         Volume.RAID_TYPE_RAID50: <span class="keyword">lambda</span> x: x &gt;= 6 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00081"></a>00081         Volume.RAID_TYPE_RAID60: <span class="keyword">lambda</span> x: x &gt;= 8 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00082"></a>00082         Volume.RAID_TYPE_RAID51: <span class="keyword">lambda</span> x: x &gt;= 6 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00083"></a>00083         Volume.RAID_TYPE_RAID61: <span class="keyword">lambda</span> x: x &gt;= 8 <span class="keywordflow">and</span> x % 2 == 0,
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     _RAID_PARITY_DISK_COUNT_FUNC = {
<a name="l00087"></a>00087         Volume.RAID_TYPE_JBOD: <span class="keyword">lambda</span> x: x,
<a name="l00088"></a>00088         Volume.RAID_TYPE_RAID0: <span class="keyword">lambda</span> x: x,
<a name="l00089"></a>00089         Volume.RAID_TYPE_RAID1: <span class="keyword">lambda</span> x: 1,
<a name="l00090"></a>00090         Volume.RAID_TYPE_RAID3: <span class="keyword">lambda</span> x: x - 1,
<a name="l00091"></a>00091         Volume.RAID_TYPE_RAID4: <span class="keyword">lambda</span> x: x - 1,
<a name="l00092"></a>00092         Volume.RAID_TYPE_RAID5: <span class="keyword">lambda</span> x: x - 1,
<a name="l00093"></a>00093         Volume.RAID_TYPE_RAID6: <span class="keyword">lambda</span> x: x - 2,
<a name="l00094"></a>00094         Volume.RAID_TYPE_RAID10: <span class="keyword">lambda</span> x: x / 2,
<a name="l00095"></a>00095         Volume.RAID_TYPE_RAID15: <span class="keyword">lambda</span> x: x / 2 - 1,
<a name="l00096"></a>00096         Volume.RAID_TYPE_RAID16: <span class="keyword">lambda</span> x: x / 2 - 2,
<a name="l00097"></a>00097         Volume.RAID_TYPE_RAID50: <span class="keyword">lambda</span> x: x - 2,
<a name="l00098"></a>00098         Volume.RAID_TYPE_RAID60: <span class="keyword">lambda</span> x: x - 4,
<a name="l00099"></a>00099         Volume.RAID_TYPE_RAID51: <span class="keyword">lambda</span> x: x / 2 - 1,
<a name="l00100"></a>00100         Volume.RAID_TYPE_RAID61: <span class="keyword">lambda</span> x: x / 2 - 2,
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     @staticmethod
<a name="l00104"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_pool_r_a_i_d.html#ab1f2953084e562340cddc9dde2658c9f">00104</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_pool_r_a_i_d.html#ab1f2953084e562340cddc9dde2658c9f">data_disk_count</a>(raid_type, disk_count):
<a name="l00105"></a>00105         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00106"></a>00106 <span class="stringliteral">        Return a integer indicating how many disks should be used as</span>
<a name="l00107"></a>00107 <span class="stringliteral">        real data(not mirrored or parity) disks.</span>
<a name="l00108"></a>00108 <span class="stringliteral">        Treating RAID 5 and 6 using fixed parity disk.</span>
<a name="l00109"></a>00109 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00110"></a>00110         <span class="keywordflow">if</span> raid_type <span class="keywordflow">not</span> <span class="keywordflow">in</span> PoolRAID._RAID_DISK_CHK.keys():
<a name="l00111"></a>00111             <span class="keywordflow">raise</span> LsmError(
<a name="l00112"></a>00112                 ErrorNumber.PLUGIN_BUG,
<a name="l00113"></a>00113                 <span class="stringliteral">&quot;data_disk_count(): Got unsupported raid type(%d)&quot;</span> %
<a name="l00114"></a>00114                 raid_type)
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="keywordflow">if</span> PoolRAID._RAID_DISK_CHK[raid_type](disk_count) <span class="keywordflow">is</span> <span class="keyword">False</span>:
<a name="l00117"></a>00117             <span class="keywordflow">raise</span> LsmError(
<a name="l00118"></a>00118                 ErrorNumber.PLUGIN_BUG,
<a name="l00119"></a>00119                 <span class="stringliteral">&quot;data_disk_count(): Illegal disk count&quot;</span>
<a name="l00120"></a>00120                 <span class="stringliteral">&quot;(%d) for raid type(%d)&quot;</span> % (disk_count, raid_type))
<a name="l00121"></a>00121         <span class="keywordflow">return</span> PoolRAID._RAID_PARITY_DISK_COUNT_FUNC[raid_type](disk_count)
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html">00124</a> <span class="keyword">class </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html">BackStore</a>(object):
<a name="l00125"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a48e98402033e0f924454fedb735cddc5">00125</a>     VERSION = <span class="stringliteral">&quot;3.4&quot;</span>
<a name="l00126"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#adb6eefe0aa2fecadd002da21f3e14264">00126</a>     VERSION_SIGNATURE = <span class="stringliteral">&apos;LSM_SIMULATOR_DATA_%s_%s&apos;</span> % (VERSION, md5(VERSION))
<a name="l00127"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5a05c15152046f3a431e1336c36f4a64">00127</a>     JOB_DEFAULT_DURATION = 1
<a name="l00128"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a144b071baa606428b1132c103d3461f7">00128</a>     JOB_DATA_TYPE_VOL = 1
<a name="l00129"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3767ae7bab79c4d714c7151c6aa1be7c">00129</a>     JOB_DATA_TYPE_FS = 2
<a name="l00130"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a6e23272866df69d5ec0e9bc0bbba3748">00130</a>     JOB_DATA_TYPE_FS_SNAP = 3
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a412d8d129c3820c009b799cff85bd4b5">00132</a>     SYS_ID = <span class="stringliteral">&quot;sim-01&quot;</span>
<a name="l00133"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a1809830fe9297e6e9d7ce3b491c91247">00133</a>     SYS_NAME = <span class="stringliteral">&quot;LSM simulated storage plug-in&quot;</span>
<a name="l00134"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a584dba6ec86deaa36f4373b08ec27e52">00134</a>     BLK_SIZE = 512
<a name="l00135"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10137106de68207c57ea52da2a3fe8a3">00135</a>     DEFAULT_STRIP_SIZE = 128 * 1024  <span class="comment"># 128 KiB</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     _LIST_SPLITTER = <span class="stringliteral">&apos;#&apos;</span>
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae0e79699209cea93ff54f6df4c6f2cd4">00139</a>     SYS_KEY_LIST = [<span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;status&apos;</span>, <span class="stringliteral">&apos;status_info&apos;</span>, <span class="stringliteral">&apos;version&apos;</span>]
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3e86062f1d9a23a540ac99ae89e034c4">00141</a>     POOL_KEY_LIST = [
<a name="l00142"></a>00142         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;status&apos;</span>, <span class="stringliteral">&apos;status_info&apos;</span>,
<a name="l00143"></a>00143         <span class="stringliteral">&apos;element_type&apos;</span>, <span class="stringliteral">&apos;unsupported_actions&apos;</span>, <span class="stringliteral">&apos;raid_type&apos;</span>,
<a name="l00144"></a>00144         <span class="stringliteral">&apos;member_type&apos;</span>, <span class="stringliteral">&apos;parent_pool_id&apos;</span>, <span class="stringliteral">&apos;total_space&apos;</span>, <span class="stringliteral">&apos;free_space&apos;</span>,
<a name="l00145"></a>00145         <span class="stringliteral">&apos;strip_size&apos;</span>]
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aca8f0dc570347d92381e41ab1aaab02e">00147</a>     DISK_KEY_LIST = [
<a name="l00148"></a>00148         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;total_space&apos;</span>, <span class="stringliteral">&apos;disk_type&apos;</span>, <span class="stringliteral">&apos;status&apos;</span>,
<a name="l00149"></a>00149         <span class="stringliteral">&apos;owner_pool_id&apos;</span>, <span class="stringliteral">&apos;role&apos;</span>]
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a7e87dc6afd86b3fa338ce4b910601a4d">00151</a>     VOL_KEY_LIST = [
<a name="l00152"></a>00152         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;vpd83&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;total_space&apos;</span>, <span class="stringliteral">&apos;consumed_size&apos;</span>,
<a name="l00153"></a>00153         <span class="stringliteral">&apos;pool_id&apos;</span>, <span class="stringliteral">&apos;admin_state&apos;</span>, <span class="stringliteral">&apos;thinp&apos;</span>, <span class="stringliteral">&apos;is_hw_raid_vol&apos;</span>]
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#abcaf1fc36e1494b9e3d54f58a9dc3a69">00155</a>     TGT_KEY_LIST = [
<a name="l00156"></a>00156         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;port_type&apos;</span>, <span class="stringliteral">&apos;service_address&apos;</span>, <span class="stringliteral">&apos;network_address&apos;</span>,
<a name="l00157"></a>00157         <span class="stringliteral">&apos;physical_address&apos;</span>, <span class="stringliteral">&apos;physical_name&apos;</span>]
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a7e2c0c1ea576cdafff3d9f79ce422114">00159</a>     AG_KEY_LIST = [<span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;init_type&apos;</span>, <span class="stringliteral">&apos;init_ids_str&apos;</span>]
<a name="l00160"></a>00160 
<a name="l00161"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab41c7ef0296bc96fc097342150e3c538">00161</a>     JOB_KEY_LIST = [<span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;duration&apos;</span>, <span class="stringliteral">&apos;timestamp&apos;</span>, <span class="stringliteral">&apos;data_type&apos;</span>, <span class="stringliteral">&apos;data_id&apos;</span>]
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a18bd5ddec1b2d9204e141bd36d6afb55">00163</a>     FS_KEY_LIST = [
<a name="l00164"></a>00164         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;total_space&apos;</span>, <span class="stringliteral">&apos;free_space&apos;</span>, <span class="stringliteral">&apos;consumed_size&apos;</span>,
<a name="l00165"></a>00165         <span class="stringliteral">&apos;pool_id&apos;</span>]
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a4bb4ec4e9631f3749af29a51d0cd9c6c">00167</a>     FS_SNAP_KEY_LIST = [
<a name="l00168"></a>00168         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;fs_id&apos;</span>, <span class="stringliteral">&apos;name&apos;</span>, <span class="stringliteral">&apos;timestamp&apos;</span>]
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a2ecb19a53ba4484f1d9bd72efe0af420">00170</a>     EXP_KEY_LIST = [
<a name="l00171"></a>00171         <span class="stringliteral">&apos;id&apos;</span>, <span class="stringliteral">&apos;fs_id&apos;</span>, <span class="stringliteral">&apos;exp_path&apos;</span>, <span class="stringliteral">&apos;auth_type&apos;</span>, <span class="stringliteral">&apos;anon_uid&apos;</span>, <span class="stringliteral">&apos;anon_gid&apos;</span>,
<a name="l00172"></a>00172         <span class="stringliteral">&apos;options&apos;</span>, <span class="stringliteral">&apos;exp_root_hosts_str&apos;</span>, <span class="stringliteral">&apos;exp_rw_hosts_str&apos;</span>,
<a name="l00173"></a>00173         <span class="stringliteral">&apos;exp_ro_hosts_str&apos;</span>]
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aca0edcf9239d5541fb41cf38b7f3dc36">00175</a>     SUPPORTED_VCR_RAID_TYPES = [
<a name="l00176"></a>00176         Volume.RAID_TYPE_RAID0, Volume.RAID_TYPE_RAID1,
<a name="l00177"></a>00177         Volume.RAID_TYPE_RAID5, Volume.RAID_TYPE_RAID6,
<a name="l00178"></a>00178         Volume.RAID_TYPE_RAID10, Volume.RAID_TYPE_RAID50,
<a name="l00179"></a>00179         Volume.RAID_TYPE_RAID60]
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae66d710bf2f6fae324d51454fda567b2">00181</a>     SUPPORTED_VCR_STRIP_SIZES = [
<a name="l00182"></a>00182         8 * 1024, 16 * 1024, 32 * 1024, 64 * 1024, 128 * 1024, 256 * 1024,
<a name="l00183"></a>00183         512 * 1024, 1024 * 1024]
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ac775ee34451fdfa742b318538164070e">00185</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ac775ee34451fdfa742b318538164070e">__init__</a>(self, statefile, timeout):
<a name="l00186"></a>00186         <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(statefile):
<a name="l00187"></a>00187             os.close(os.open(statefile, os.O_WRONLY | os.O_CREAT))
<a name="l00188"></a>00188             <span class="comment"># Due to umask, os.open() created file migt not be 666 permission.</span>
<a name="l00189"></a>00189             os.chmod(statefile, 0o666)
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">00191</a>         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">statefile</a> = statefile
<a name="l00192"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">00192</a>         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a> = <span class="keywordtype">None</span>
<a name="l00193"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">00193</a>         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">sql_conn</a> = sqlite3.connect(
<a name="l00194"></a>00194             statefile, timeout=int(timeout/1000), isolation_level=<span class="stringliteral">&quot;IMMEDIATE&quot;</span>)
<a name="l00195"></a>00195         <span class="comment"># Create tables no matter exist or not. No lock required.</span>
<a name="l00196"></a>00196 
<a name="l00197"></a>00197         sql_cmd = <span class="stringliteral">&quot;PRAGMA foreign_keys = ON;\n&quot;</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         sql_cmd += (
<a name="l00200"></a>00200             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00201"></a>00201 <span class="stringliteral">            CREATE TABLE systems (</span>
<a name="l00202"></a>00202 <span class="stringliteral">            id TEXT PRIMARY KEY,</span>
<a name="l00203"></a>00203 <span class="stringliteral">            name TEXT NOT NULL,</span>
<a name="l00204"></a>00204 <span class="stringliteral">            status INTEGER NOT NULL,</span>
<a name="l00205"></a>00205 <span class="stringliteral">            status_info TEXT,</span>
<a name="l00206"></a>00206 <span class="stringliteral">            version TEXT NOT NULL);</span>
<a name="l00207"></a>00207 <span class="stringliteral">            &quot;&quot;&quot;</span>)
<a name="l00208"></a>00208             <span class="comment"># ^ version hold the signature of data</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         sql_cmd += (
<a name="l00211"></a>00211             <span class="stringliteral">&quot;CREATE TABLE tgts (&quot;</span>
<a name="l00212"></a>00212             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00213"></a>00213             <span class="stringliteral">&quot;port_type INTEGER NOT NULL, &quot;</span>
<a name="l00214"></a>00214             <span class="stringliteral">&quot;service_address TEXT NOT NULL, &quot;</span>
<a name="l00215"></a>00215             <span class="stringliteral">&quot;network_address TEXT NOT NULL, &quot;</span>
<a name="l00216"></a>00216             <span class="stringliteral">&quot;physical_address TEXT NOT NULL, &quot;</span>
<a name="l00217"></a>00217             <span class="stringliteral">&quot;physical_name TEXT NOT NULL);\n&quot;</span>)
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         sql_cmd += (
<a name="l00220"></a>00220             <span class="stringliteral">&quot;CREATE TABLE pools (&quot;</span>
<a name="l00221"></a>00221             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00222"></a>00222             <span class="stringliteral">&quot;name TEXT UNIQUE NOT NULL, &quot;</span>
<a name="l00223"></a>00223             <span class="stringliteral">&quot;status INTEGER NOT NULL, &quot;</span>
<a name="l00224"></a>00224             <span class="stringliteral">&quot;status_info TEXT, &quot;</span>
<a name="l00225"></a>00225             <span class="stringliteral">&quot;element_type INTEGER NOT NULL, &quot;</span>
<a name="l00226"></a>00226             <span class="stringliteral">&quot;unsupported_actions INTEGER, &quot;</span>
<a name="l00227"></a>00227             <span class="stringliteral">&quot;raid_type INTEGER NOT NULL, &quot;</span>
<a name="l00228"></a>00228             <span class="stringliteral">&quot;parent_pool_id INTEGER, &quot;</span>
<a name="l00229"></a>00229             <span class="comment"># ^ Indicate this pool is allocated from # other pool</span>
<a name="l00230"></a>00230             <span class="stringliteral">&quot;member_type INTEGER, &quot;</span>
<a name="l00231"></a>00231             <span class="stringliteral">&quot;strip_size INTEGER, &quot;</span>
<a name="l00232"></a>00232             <span class="stringliteral">&quot;total_space LONG);\n&quot;</span>)
<a name="l00233"></a>00233             <span class="comment"># ^ total_space here is only for sub-pool (pool from pool)</span>
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         sql_cmd += (
<a name="l00236"></a>00236             <span class="stringliteral">&quot;CREATE TABLE disks (&quot;</span>
<a name="l00237"></a>00237             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00238"></a>00238             <span class="stringliteral">&quot;total_space LONG NOT NULL, &quot;</span>
<a name="l00239"></a>00239             <span class="stringliteral">&quot;disk_type INTEGER NOT NULL, &quot;</span>
<a name="l00240"></a>00240             <span class="stringliteral">&quot;status INTEGER NOT NULL, &quot;</span>
<a name="l00241"></a>00241             <span class="stringliteral">&quot;disk_prefix TEXT NOT NULL, &quot;</span>
<a name="l00242"></a>00242             <span class="stringliteral">&quot;owner_pool_id INTEGER, &quot;</span>
<a name="l00243"></a>00243             <span class="comment"># ^ Indicate this disk is used to assemble a pool</span>
<a name="l00244"></a>00244             <span class="stringliteral">&quot;role TEXT,&quot;</span>
<a name="l00245"></a>00245             <span class="stringliteral">&quot;FOREIGN KEY(owner_pool_id) &quot;</span>
<a name="l00246"></a>00246             <span class="stringliteral">&quot;REFERENCES pools(id) ON DELETE CASCADE );\n&quot;</span>)
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         sql_cmd += (
<a name="l00249"></a>00249             <span class="stringliteral">&quot;CREATE TABLE volumes (&quot;</span>
<a name="l00250"></a>00250             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00251"></a>00251             <span class="stringliteral">&quot;vpd83 TEXT NOT NULL, &quot;</span>
<a name="l00252"></a>00252             <span class="stringliteral">&quot;name TEXT UNIQUE NOT NULL, &quot;</span>
<a name="l00253"></a>00253             <span class="stringliteral">&quot;total_space LONG NOT NULL, &quot;</span>
<a name="l00254"></a>00254             <span class="stringliteral">&quot;consumed_size LONG NOT NULL, &quot;</span>
<a name="l00255"></a>00255             <span class="comment"># ^ Reserved for future thinp support.</span>
<a name="l00256"></a>00256             <span class="stringliteral">&quot;admin_state INTEGER, &quot;</span>
<a name="l00257"></a>00257             <span class="stringliteral">&quot;thinp INTEGER NOT NULL, &quot;</span>
<a name="l00258"></a>00258             <span class="stringliteral">&quot;is_hw_raid_vol INTEGER, &quot;</span>
<a name="l00259"></a>00259             <span class="comment"># ^ Once its volume deleted, pool will be delete also.</span>
<a name="l00260"></a>00260             <span class="comment"># For HW RAID simulation only.</span>
<a name="l00261"></a>00261 
<a name="l00262"></a>00262             <span class="stringliteral">&quot;pool_id INTEGER NOT NULL, &quot;</span>
<a name="l00263"></a>00263             <span class="stringliteral">&quot;FOREIGN KEY(pool_id) &quot;</span>
<a name="l00264"></a>00264             <span class="stringliteral">&quot;REFERENCES pools(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         sql_cmd += (
<a name="l00267"></a>00267             <span class="stringliteral">&quot;CREATE TABLE ags (&quot;</span>
<a name="l00268"></a>00268             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00269"></a>00269             <span class="stringliteral">&quot;name TEXT UNIQUE NOT NULL);\n&quot;</span>)
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         sql_cmd += (
<a name="l00272"></a>00272             <span class="stringliteral">&quot;CREATE TABLE inits (&quot;</span>
<a name="l00273"></a>00273             <span class="stringliteral">&quot;id TEXT UNIQUE NOT NULL, &quot;</span>
<a name="l00274"></a>00274             <span class="stringliteral">&quot;init_type INTEGER NOT NULL, &quot;</span>
<a name="l00275"></a>00275             <span class="stringliteral">&quot;owner_ag_id INTEGER NOT NULL, &quot;</span>
<a name="l00276"></a>00276             <span class="stringliteral">&quot;FOREIGN KEY(owner_ag_id) &quot;</span>
<a name="l00277"></a>00277             <span class="stringliteral">&quot;REFERENCES ags(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         sql_cmd += (
<a name="l00280"></a>00280             <span class="stringliteral">&quot;CREATE TABLE vol_masks (&quot;</span>
<a name="l00281"></a>00281             <span class="stringliteral">&quot;vol_id INTEGER NOT NULL, &quot;</span>
<a name="l00282"></a>00282             <span class="stringliteral">&quot;ag_id INTEGER NOT NULL, &quot;</span>
<a name="l00283"></a>00283             <span class="stringliteral">&quot;FOREIGN KEY(vol_id) REFERENCES volumes(id) ON DELETE CASCADE, &quot;</span>
<a name="l00284"></a>00284             <span class="stringliteral">&quot;FOREIGN KEY(ag_id) REFERENCES ags(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         sql_cmd += (
<a name="l00287"></a>00287             <span class="stringliteral">&quot;CREATE TABLE vol_reps (&quot;</span>
<a name="l00288"></a>00288             <span class="stringliteral">&quot;rep_type INTEGER, &quot;</span>
<a name="l00289"></a>00289             <span class="stringliteral">&quot;src_vol_id INTEGER NOT NULL, &quot;</span>
<a name="l00290"></a>00290             <span class="stringliteral">&quot;dst_vol_id INTEGER NOT NULL, &quot;</span>
<a name="l00291"></a>00291             <span class="stringliteral">&quot;FOREIGN KEY(src_vol_id) &quot;</span>
<a name="l00292"></a>00292             <span class="stringliteral">&quot;REFERENCES volumes(id) ON DELETE CASCADE, &quot;</span>
<a name="l00293"></a>00293             <span class="stringliteral">&quot;FOREIGN KEY(dst_vol_id) &quot;</span>
<a name="l00294"></a>00294             <span class="stringliteral">&quot;REFERENCES volumes(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         sql_cmd += (
<a name="l00297"></a>00297             <span class="stringliteral">&quot;CREATE TABLE fss (&quot;</span>
<a name="l00298"></a>00298             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00299"></a>00299             <span class="stringliteral">&quot;name TEXT UNIQUE NOT NULL, &quot;</span>
<a name="l00300"></a>00300             <span class="stringliteral">&quot;total_space LONG NOT NULL, &quot;</span>
<a name="l00301"></a>00301             <span class="stringliteral">&quot;consumed_size LONG NOT NULL, &quot;</span>
<a name="l00302"></a>00302             <span class="stringliteral">&quot;free_space LONG, &quot;</span>
<a name="l00303"></a>00303             <span class="stringliteral">&quot;pool_id INTEGER NOT NULL, &quot;</span>
<a name="l00304"></a>00304             <span class="stringliteral">&quot;FOREIGN KEY(pool_id) &quot;</span>
<a name="l00305"></a>00305             <span class="stringliteral">&quot;REFERENCES pools(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         sql_cmd += (
<a name="l00308"></a>00308             <span class="stringliteral">&quot;CREATE TABLE fs_snaps (&quot;</span>
<a name="l00309"></a>00309             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00310"></a>00310             <span class="stringliteral">&quot;name TEXT UNIQUE NOT NULL, &quot;</span>
<a name="l00311"></a>00311             <span class="stringliteral">&quot;fs_id INTEGER NOT NULL, &quot;</span>
<a name="l00312"></a>00312             <span class="stringliteral">&quot;timestamp LONG NOT NULL, &quot;</span>
<a name="l00313"></a>00313             <span class="stringliteral">&quot;FOREIGN KEY(fs_id) &quot;</span>
<a name="l00314"></a>00314             <span class="stringliteral">&quot;REFERENCES fss(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         sql_cmd += (
<a name="l00317"></a>00317             <span class="stringliteral">&quot;CREATE TABLE fs_clones (&quot;</span>
<a name="l00318"></a>00318             <span class="stringliteral">&quot;src_fs_id INTEGER NOT NULL, &quot;</span>
<a name="l00319"></a>00319             <span class="stringliteral">&quot;dst_fs_id INTEGER NOT NULL, &quot;</span>
<a name="l00320"></a>00320             <span class="stringliteral">&quot;FOREIGN KEY(src_fs_id) &quot;</span>
<a name="l00321"></a>00321             <span class="stringliteral">&quot;REFERENCES fss(id) ON DELETE CASCADE, &quot;</span>
<a name="l00322"></a>00322             <span class="stringliteral">&quot;FOREIGN KEY(dst_fs_id) &quot;</span>
<a name="l00323"></a>00323             <span class="stringliteral">&quot;REFERENCES fss(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         sql_cmd += (
<a name="l00326"></a>00326             <span class="stringliteral">&quot;CREATE TABLE exps (&quot;</span>
<a name="l00327"></a>00327             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00328"></a>00328             <span class="stringliteral">&quot;fs_id INTEGER NOT NULL, &quot;</span>
<a name="l00329"></a>00329             <span class="stringliteral">&quot;exp_path TEXT UNIQUE NOT NULL, &quot;</span>
<a name="l00330"></a>00330             <span class="stringliteral">&quot;auth_type TEXT, &quot;</span>
<a name="l00331"></a>00331             <span class="stringliteral">&quot;anon_uid INTEGER, &quot;</span>
<a name="l00332"></a>00332             <span class="stringliteral">&quot;anon_gid INTEGER, &quot;</span>
<a name="l00333"></a>00333             <span class="stringliteral">&quot;options TEXT, &quot;</span>
<a name="l00334"></a>00334             <span class="stringliteral">&quot;FOREIGN KEY(fs_id) &quot;</span>
<a name="l00335"></a>00335             <span class="stringliteral">&quot;REFERENCES fss(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         sql_cmd += (
<a name="l00338"></a>00338             <span class="stringliteral">&quot;CREATE TABLE exp_root_hosts(&quot;</span>
<a name="l00339"></a>00339             <span class="stringliteral">&quot;host TEXT NOT NULL, &quot;</span>
<a name="l00340"></a>00340             <span class="stringliteral">&quot;exp_id INTEGER NOT NULL, &quot;</span>
<a name="l00341"></a>00341             <span class="stringliteral">&quot;FOREIGN KEY(exp_id) &quot;</span>
<a name="l00342"></a>00342             <span class="stringliteral">&quot;REFERENCES exps(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         sql_cmd += (
<a name="l00345"></a>00345             <span class="stringliteral">&quot;CREATE TABLE exp_rw_hosts(&quot;</span>
<a name="l00346"></a>00346             <span class="stringliteral">&quot;host TEXT NOT NULL, &quot;</span>
<a name="l00347"></a>00347             <span class="stringliteral">&quot;exp_id INTEGER NOT NULL, &quot;</span>
<a name="l00348"></a>00348             <span class="stringliteral">&quot;FOREIGN KEY(exp_id) &quot;</span>
<a name="l00349"></a>00349             <span class="stringliteral">&quot;REFERENCES exps(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         sql_cmd += (
<a name="l00352"></a>00352             <span class="stringliteral">&quot;CREATE TABLE exp_ro_hosts(&quot;</span>
<a name="l00353"></a>00353             <span class="stringliteral">&quot;host TEXT NOT NULL, &quot;</span>
<a name="l00354"></a>00354             <span class="stringliteral">&quot;exp_id INTEGER NOT NULL, &quot;</span>
<a name="l00355"></a>00355             <span class="stringliteral">&quot;FOREIGN KEY(exp_id) &quot;</span>
<a name="l00356"></a>00356             <span class="stringliteral">&quot;REFERENCES exps(id) ON DELETE CASCADE);\n&quot;</span>)
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         sql_cmd += (
<a name="l00359"></a>00359             <span class="stringliteral">&quot;CREATE TABLE jobs (&quot;</span>
<a name="l00360"></a>00360             <span class="stringliteral">&quot;id INTEGER PRIMARY KEY, &quot;</span>
<a name="l00361"></a>00361             <span class="stringliteral">&quot;duration INTEGER NOT NULL, &quot;</span>
<a name="l00362"></a>00362             <span class="stringliteral">&quot;timestamp TEXT NOT NULL, &quot;</span>
<a name="l00363"></a>00363             <span class="stringliteral">&quot;data_type INTEGER, &quot;</span>
<a name="l00364"></a>00364             <span class="stringliteral">&quot;data_id TEXT);\n&quot;</span>)
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <span class="comment"># Create views</span>
<a name="l00367"></a>00367         sql_cmd += (
<a name="l00368"></a>00368             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00369"></a>00369 <span class="stringliteral">            CREATE VIEW pools_view AS</span>
<a name="l00370"></a>00370 <span class="stringliteral">                SELECT</span>
<a name="l00371"></a>00371 <span class="stringliteral">                    pool0.id,</span>
<a name="l00372"></a>00372 <span class="stringliteral">                    pool0.name,</span>
<a name="l00373"></a>00373 <span class="stringliteral">                    pool0.status,</span>
<a name="l00374"></a>00374 <span class="stringliteral">                    pool0.status_info,</span>
<a name="l00375"></a>00375 <span class="stringliteral">                    pool0.element_type,</span>
<a name="l00376"></a>00376 <span class="stringliteral">                    pool0.unsupported_actions,</span>
<a name="l00377"></a>00377 <span class="stringliteral">                    pool0.raid_type,</span>
<a name="l00378"></a>00378 <span class="stringliteral">                    pool0.member_type,</span>
<a name="l00379"></a>00379 <span class="stringliteral">                    pool0.parent_pool_id,</span>
<a name="l00380"></a>00380 <span class="stringliteral">                    pool0.strip_size,</span>
<a name="l00381"></a>00381 <span class="stringliteral">                    pool1.total_space total_space,</span>
<a name="l00382"></a>00382 <span class="stringliteral">                    pool1.total_space -</span>
<a name="l00383"></a>00383 <span class="stringliteral">                    pool2.vol_consumed_size  -</span>
<a name="l00384"></a>00384 <span class="stringliteral">                    pool3.fs_consumed_size -</span>
<a name="l00385"></a>00385 <span class="stringliteral">                    pool4.sub_pool_consumed_size free_space</span>
<a name="l00386"></a>00386 <span class="stringliteral">                FROM</span>
<a name="l00387"></a>00387 <span class="stringliteral">                    pools pool0</span>
<a name="l00388"></a>00388 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00389"></a>00389 <span class="stringliteral">                            SELECT</span>
<a name="l00390"></a>00390 <span class="stringliteral">                                pool.id,</span>
<a name="l00391"></a>00391 <span class="stringliteral">                                    ifnull(pool.total_space,</span>
<a name="l00392"></a>00392 <span class="stringliteral">                                        ifnull(SUM(disk.total_space), 0))</span>
<a name="l00393"></a>00393 <span class="stringliteral">                                total_space</span>
<a name="l00394"></a>00394 <span class="stringliteral">                            FROM pools pool</span>
<a name="l00395"></a>00395 <span class="stringliteral">                                LEFT JOIN disks disk</span>
<a name="l00396"></a>00396 <span class="stringliteral">                                    ON pool.id = disk.owner_pool_id AND</span>
<a name="l00397"></a>00397 <span class="stringliteral">                                       disk.role = &apos;DATA&apos;</span>
<a name="l00398"></a>00398 <span class="stringliteral">                            GROUP BY</span>
<a name="l00399"></a>00399 <span class="stringliteral">                                pool.id</span>
<a name="l00400"></a>00400 <span class="stringliteral">                        ) pool1 ON pool0.id = pool1.id</span>
<a name="l00401"></a>00401 <span class="stringliteral"></span>
<a name="l00402"></a>00402 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00403"></a>00403 <span class="stringliteral">                            SELECT</span>
<a name="l00404"></a>00404 <span class="stringliteral">                                pool.id,</span>
<a name="l00405"></a>00405 <span class="stringliteral">                                ifnull(SUM(volume.consumed_size), 0)</span>
<a name="l00406"></a>00406 <span class="stringliteral">                                vol_consumed_size</span>
<a name="l00407"></a>00407 <span class="stringliteral">                            FROM pools pool</span>
<a name="l00408"></a>00408 <span class="stringliteral">                                LEFT JOIN volumes volume</span>
<a name="l00409"></a>00409 <span class="stringliteral">                                    ON volume.pool_id = pool.id</span>
<a name="l00410"></a>00410 <span class="stringliteral">                            GROUP BY</span>
<a name="l00411"></a>00411 <span class="stringliteral">                                pool.id</span>
<a name="l00412"></a>00412 <span class="stringliteral">                        ) pool2 ON pool0.id = pool2.id</span>
<a name="l00413"></a>00413 <span class="stringliteral"></span>
<a name="l00414"></a>00414 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00415"></a>00415 <span class="stringliteral">                            SELECT</span>
<a name="l00416"></a>00416 <span class="stringliteral">                                pool.id,</span>
<a name="l00417"></a>00417 <span class="stringliteral">                                ifnull(SUM(fs.consumed_size), 0)</span>
<a name="l00418"></a>00418 <span class="stringliteral">                                fs_consumed_size</span>
<a name="l00419"></a>00419 <span class="stringliteral">                            FROM pools pool</span>
<a name="l00420"></a>00420 <span class="stringliteral">                                LEFT JOIN fss fs</span>
<a name="l00421"></a>00421 <span class="stringliteral">                                    ON fs.pool_id = pool.id</span>
<a name="l00422"></a>00422 <span class="stringliteral">                            GROUP BY</span>
<a name="l00423"></a>00423 <span class="stringliteral">                                pool.id</span>
<a name="l00424"></a>00424 <span class="stringliteral">                        ) pool3 ON pool0.id = pool3.id</span>
<a name="l00425"></a>00425 <span class="stringliteral"></span>
<a name="l00426"></a>00426 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00427"></a>00427 <span class="stringliteral">                            SELECT</span>
<a name="l00428"></a>00428 <span class="stringliteral">                                pool.id,</span>
<a name="l00429"></a>00429 <span class="stringliteral">                                ifnull(SUM(sub_pool.total_space), 0)</span>
<a name="l00430"></a>00430 <span class="stringliteral">                                sub_pool_consumed_size</span>
<a name="l00431"></a>00431 <span class="stringliteral">                            FROM pools pool</span>
<a name="l00432"></a>00432 <span class="stringliteral">                                LEFT JOIN pools sub_pool</span>
<a name="l00433"></a>00433 <span class="stringliteral">                                    ON sub_pool.parent_pool_id = pool.id</span>
<a name="l00434"></a>00434 <span class="stringliteral">                            GROUP BY</span>
<a name="l00435"></a>00435 <span class="stringliteral">                                pool.id</span>
<a name="l00436"></a>00436 <span class="stringliteral">                        ) pool4 ON pool0.id = pool4.id</span>
<a name="l00437"></a>00437 <span class="stringliteral"></span>
<a name="l00438"></a>00438 <span class="stringliteral">                GROUP BY</span>
<a name="l00439"></a>00439 <span class="stringliteral">                    pool0.id;</span>
<a name="l00440"></a>00440 <span class="stringliteral">            &quot;&quot;&quot;</span>)
<a name="l00441"></a>00441         sql_cmd += (
<a name="l00442"></a>00442             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00443"></a>00443 <span class="stringliteral">            CREATE VIEW disks_view AS</span>
<a name="l00444"></a>00444 <span class="stringliteral">                SELECT</span>
<a name="l00445"></a>00445 <span class="stringliteral">                    id,</span>
<a name="l00446"></a>00446 <span class="stringliteral">                        disk_prefix || &apos;_&apos; || id</span>
<a name="l00447"></a>00447 <span class="stringliteral">                    name,</span>
<a name="l00448"></a>00448 <span class="stringliteral">                    total_space,</span>
<a name="l00449"></a>00449 <span class="stringliteral">                    disk_type,</span>
<a name="l00450"></a>00450 <span class="stringliteral">                    role,</span>
<a name="l00451"></a>00451 <span class="stringliteral">                    status,</span>
<a name="l00452"></a>00452 <span class="stringliteral">                    owner_pool_id</span>
<a name="l00453"></a>00453 <span class="stringliteral">                FROM</span>
<a name="l00454"></a>00454 <span class="stringliteral">                    disks</span>
<a name="l00455"></a>00455 <span class="stringliteral">            ;</span>
<a name="l00456"></a>00456 <span class="stringliteral">            &quot;&quot;&quot;</span>)
<a name="l00457"></a>00457         sql_cmd += (
<a name="l00458"></a>00458             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00459"></a>00459 <span class="stringliteral">            CREATE VIEW volumes_by_ag_view AS</span>
<a name="l00460"></a>00460 <span class="stringliteral">                SELECT</span>
<a name="l00461"></a>00461 <span class="stringliteral">                    vol.id,</span>
<a name="l00462"></a>00462 <span class="stringliteral">                    vol.vpd83,</span>
<a name="l00463"></a>00463 <span class="stringliteral">                    vol.name,</span>
<a name="l00464"></a>00464 <span class="stringliteral">                    vol.total_space,</span>
<a name="l00465"></a>00465 <span class="stringliteral">                    vol.consumed_size,</span>
<a name="l00466"></a>00466 <span class="stringliteral">                    vol.pool_id,</span>
<a name="l00467"></a>00467 <span class="stringliteral">                    vol.admin_state,</span>
<a name="l00468"></a>00468 <span class="stringliteral">                    vol.thinp,</span>
<a name="l00469"></a>00469 <span class="stringliteral">                    vol.is_hw_raid_vol,</span>
<a name="l00470"></a>00470 <span class="stringliteral">                    vol_mask.ag_id ag_id</span>
<a name="l00471"></a>00471 <span class="stringliteral">                FROM</span>
<a name="l00472"></a>00472 <span class="stringliteral">                    volumes vol</span>
<a name="l00473"></a>00473 <span class="stringliteral">                        LEFT JOIN vol_masks vol_mask</span>
<a name="l00474"></a>00474 <span class="stringliteral">                            ON vol_mask.vol_id = vol.id</span>
<a name="l00475"></a>00475 <span class="stringliteral">            ;</span>
<a name="l00476"></a>00476 <span class="stringliteral">            &quot;&quot;&quot;</span>)
<a name="l00477"></a>00477 
<a name="l00478"></a>00478         sql_cmd += (
<a name="l00479"></a>00479             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00480"></a>00480 <span class="stringliteral">            CREATE VIEW ags_view AS</span>
<a name="l00481"></a>00481 <span class="stringliteral">                SELECT</span>
<a name="l00482"></a>00482 <span class="stringliteral">                    ag.id,</span>
<a name="l00483"></a>00483 <span class="stringliteral">                    ag.name,</span>
<a name="l00484"></a>00484 <span class="stringliteral">                        CASE</span>
<a name="l00485"></a>00485 <span class="stringliteral">                            WHEN count(DISTINCT init.init_type) = 1</span>
<a name="l00486"></a>00486 <span class="stringliteral">                                THEN init.init_type</span>
<a name="l00487"></a>00487 <span class="stringliteral">                            WHEN count(DISTINCT init.init_type) = 2</span>
<a name="l00488"></a>00488 <span class="stringliteral">                                THEN %s</span>
<a name="l00489"></a>00489 <span class="stringliteral">                            ELSE %s</span>
<a name="l00490"></a>00490 <span class="stringliteral">                        END</span>
<a name="l00491"></a>00491 <span class="stringliteral">                    init_type,</span>
<a name="l00492"></a>00492 <span class="stringliteral">                    group_concat(init.id, &apos;%s&apos;) init_ids_str</span>
<a name="l00493"></a>00493 <span class="stringliteral">                FROM</span>
<a name="l00494"></a>00494 <span class="stringliteral">                    ags ag</span>
<a name="l00495"></a>00495 <span class="stringliteral">                        LEFT JOIN inits init</span>
<a name="l00496"></a>00496 <span class="stringliteral">                            ON ag.id = init.owner_ag_id</span>
<a name="l00497"></a>00497 <span class="stringliteral">                GROUP BY</span>
<a name="l00498"></a>00498 <span class="stringliteral">                    ag.id</span>
<a name="l00499"></a>00499 <span class="stringliteral">                ORDER BY</span>
<a name="l00500"></a>00500 <span class="stringliteral">                    init.init_type</span>
<a name="l00501"></a>00501 <span class="stringliteral">            ;</span>
<a name="l00502"></a>00502 <span class="stringliteral">            &quot;&quot;&quot;</span> % (
<a name="l00503"></a>00503             AccessGroup.INIT_TYPE_ISCSI_WWPN_MIXED,
<a name="l00504"></a>00504             AccessGroup.INIT_TYPE_UNKNOWN, BackStore._LIST_SPLITTER))
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         sql_cmd += (
<a name="l00507"></a>00507             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00508"></a>00508 <span class="stringliteral">            CREATE VIEW ags_by_vol_view AS</span>
<a name="l00509"></a>00509 <span class="stringliteral">                SELECT</span>
<a name="l00510"></a>00510 <span class="stringliteral">                    ag_new.id,</span>
<a name="l00511"></a>00511 <span class="stringliteral">                    ag_new.name,</span>
<a name="l00512"></a>00512 <span class="stringliteral">                    ag_new.init_type,</span>
<a name="l00513"></a>00513 <span class="stringliteral">                    ag_new.init_ids_str,</span>
<a name="l00514"></a>00514 <span class="stringliteral">                    vol_mask.vol_id vol_id</span>
<a name="l00515"></a>00515 <span class="stringliteral">                FROM</span>
<a name="l00516"></a>00516 <span class="stringliteral">                    (</span>
<a name="l00517"></a>00517 <span class="stringliteral">                        SELECT</span>
<a name="l00518"></a>00518 <span class="stringliteral">                            ag.id,</span>
<a name="l00519"></a>00519 <span class="stringliteral">                            ag.name,</span>
<a name="l00520"></a>00520 <span class="stringliteral">                                CASE</span>
<a name="l00521"></a>00521 <span class="stringliteral">                                    WHEN count(DISTINCT init.init_type) = 1</span>
<a name="l00522"></a>00522 <span class="stringliteral">                                        THEN init.init_type</span>
<a name="l00523"></a>00523 <span class="stringliteral">                                    WHEN count(DISTINCT init.init_type) = 2</span>
<a name="l00524"></a>00524 <span class="stringliteral">                                        THEN %s</span>
<a name="l00525"></a>00525 <span class="stringliteral">                                    ELSE %s</span>
<a name="l00526"></a>00526 <span class="stringliteral">                                END</span>
<a name="l00527"></a>00527 <span class="stringliteral">                            init_type,</span>
<a name="l00528"></a>00528 <span class="stringliteral">                            group_concat(init.id, &apos;%s&apos;) init_ids_str</span>
<a name="l00529"></a>00529 <span class="stringliteral">                        FROM</span>
<a name="l00530"></a>00530 <span class="stringliteral">                            ags ag</span>
<a name="l00531"></a>00531 <span class="stringliteral">                                LEFT JOIN inits init</span>
<a name="l00532"></a>00532 <span class="stringliteral">                                    ON ag.id = init.owner_ag_id</span>
<a name="l00533"></a>00533 <span class="stringliteral">                        GROUP BY</span>
<a name="l00534"></a>00534 <span class="stringliteral">                            ag.id</span>
<a name="l00535"></a>00535 <span class="stringliteral">                        ORDER BY</span>
<a name="l00536"></a>00536 <span class="stringliteral">                            init.init_type</span>
<a name="l00537"></a>00537 <span class="stringliteral">                    ) ag_new</span>
<a name="l00538"></a>00538 <span class="stringliteral">                        LEFT JOIN vol_masks vol_mask</span>
<a name="l00539"></a>00539 <span class="stringliteral">                            ON vol_mask.ag_id = ag_new.id</span>
<a name="l00540"></a>00540 <span class="stringliteral">            ;</span>
<a name="l00541"></a>00541 <span class="stringliteral">            &quot;&quot;&quot;</span> % (
<a name="l00542"></a>00542             AccessGroup.INIT_TYPE_ISCSI_WWPN_MIXED,
<a name="l00543"></a>00543             AccessGroup.INIT_TYPE_UNKNOWN, BackStore._LIST_SPLITTER))
<a name="l00544"></a>00544 
<a name="l00545"></a>00545         sql_cmd += (
<a name="l00546"></a>00546             <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00547"></a>00547 <span class="stringliteral">            CREATE VIEW exps_view AS</span>
<a name="l00548"></a>00548 <span class="stringliteral">                SELECT</span>
<a name="l00549"></a>00549 <span class="stringliteral">                    exp.id,</span>
<a name="l00550"></a>00550 <span class="stringliteral">                    exp.fs_id,</span>
<a name="l00551"></a>00551 <span class="stringliteral">                    exp.exp_path,</span>
<a name="l00552"></a>00552 <span class="stringliteral">                    exp.auth_type,</span>
<a name="l00553"></a>00553 <span class="stringliteral">                    exp.anon_uid,</span>
<a name="l00554"></a>00554 <span class="stringliteral">                    exp.anon_gid,</span>
<a name="l00555"></a>00555 <span class="stringliteral">                    exp.options,</span>
<a name="l00556"></a>00556 <span class="stringliteral">                    exp2.exp_root_hosts_str,</span>
<a name="l00557"></a>00557 <span class="stringliteral">                    exp3.exp_rw_hosts_str,</span>
<a name="l00558"></a>00558 <span class="stringliteral">                    exp4.exp_ro_hosts_str</span>
<a name="l00559"></a>00559 <span class="stringliteral">                FROM</span>
<a name="l00560"></a>00560 <span class="stringliteral">                    exps exp</span>
<a name="l00561"></a>00561 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00562"></a>00562 <span class="stringliteral">                            SELECT</span>
<a name="l00563"></a>00563 <span class="stringliteral">                                exp_t2.id,</span>
<a name="l00564"></a>00564 <span class="stringliteral">                                    group_concat(</span>
<a name="l00565"></a>00565 <span class="stringliteral">                                        exp_root_host.host, &apos;%s&apos;)</span>
<a name="l00566"></a>00566 <span class="stringliteral">                                exp_root_hosts_str</span>
<a name="l00567"></a>00567 <span class="stringliteral">                            FROM</span>
<a name="l00568"></a>00568 <span class="stringliteral">                                exps exp_t2</span>
<a name="l00569"></a>00569 <span class="stringliteral">                                LEFT JOIN exp_root_hosts exp_root_host</span>
<a name="l00570"></a>00570 <span class="stringliteral">                                    ON exp_t2.id = exp_root_host.exp_id</span>
<a name="l00571"></a>00571 <span class="stringliteral">                            GROUP BY</span>
<a name="l00572"></a>00572 <span class="stringliteral">                                exp_t2.id</span>
<a name="l00573"></a>00573 <span class="stringliteral">                        ) exp2</span>
<a name="l00574"></a>00574 <span class="stringliteral">                            ON exp.id = exp2.id</span>
<a name="l00575"></a>00575 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00576"></a>00576 <span class="stringliteral">                            SELECT</span>
<a name="l00577"></a>00577 <span class="stringliteral">                                exp_t3.id,</span>
<a name="l00578"></a>00578 <span class="stringliteral">                                    group_concat(</span>
<a name="l00579"></a>00579 <span class="stringliteral">                                        exp_rw_host.host, &apos;%s&apos;)</span>
<a name="l00580"></a>00580 <span class="stringliteral">                                exp_rw_hosts_str</span>
<a name="l00581"></a>00581 <span class="stringliteral">                            FROM</span>
<a name="l00582"></a>00582 <span class="stringliteral">                                exps exp_t3</span>
<a name="l00583"></a>00583 <span class="stringliteral">                                LEFT JOIN exp_rw_hosts exp_rw_host</span>
<a name="l00584"></a>00584 <span class="stringliteral">                                    ON exp_t3.id = exp_rw_host.exp_id</span>
<a name="l00585"></a>00585 <span class="stringliteral">                            GROUP BY</span>
<a name="l00586"></a>00586 <span class="stringliteral">                                exp_t3.id</span>
<a name="l00587"></a>00587 <span class="stringliteral">                        ) exp3</span>
<a name="l00588"></a>00588 <span class="stringliteral">                            ON exp.id = exp3.id</span>
<a name="l00589"></a>00589 <span class="stringliteral">                        LEFT JOIN (</span>
<a name="l00590"></a>00590 <span class="stringliteral">                            SELECT</span>
<a name="l00591"></a>00591 <span class="stringliteral">                                exp_t4.id,</span>
<a name="l00592"></a>00592 <span class="stringliteral">                                    group_concat(</span>
<a name="l00593"></a>00593 <span class="stringliteral">                                        exp_ro_host.host, &apos;%s&apos;)</span>
<a name="l00594"></a>00594 <span class="stringliteral">                                exp_ro_hosts_str</span>
<a name="l00595"></a>00595 <span class="stringliteral">                            FROM</span>
<a name="l00596"></a>00596 <span class="stringliteral">                                exps exp_t4</span>
<a name="l00597"></a>00597 <span class="stringliteral">                                LEFT JOIN exp_ro_hosts exp_ro_host</span>
<a name="l00598"></a>00598 <span class="stringliteral">                                    ON exp_t4.id = exp_ro_host.exp_id</span>
<a name="l00599"></a>00599 <span class="stringliteral">                            GROUP BY</span>
<a name="l00600"></a>00600 <span class="stringliteral">                                exp_t4.id</span>
<a name="l00601"></a>00601 <span class="stringliteral">                        ) exp4</span>
<a name="l00602"></a>00602 <span class="stringliteral">                            ON exp.id = exp4.id</span>
<a name="l00603"></a>00603 <span class="stringliteral">                GROUP BY</span>
<a name="l00604"></a>00604 <span class="stringliteral">                    exp.id;</span>
<a name="l00605"></a>00605 <span class="stringliteral">            ;</span>
<a name="l00606"></a>00606 <span class="stringliteral">            &quot;&quot;&quot;</span> % (
<a name="l00607"></a>00607             BackStore._LIST_SPLITTER, BackStore._LIST_SPLITTER,
<a name="l00608"></a>00608             BackStore._LIST_SPLITTER))
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         sql_cur = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">sql_conn</a>.cursor()
<a name="l00611"></a>00611         <span class="keywordflow">try</span>:
<a name="l00612"></a>00612             sql_cur.executescript(sql_cmd)
<a name="l00613"></a>00613         <span class="keywordflow">except</span> sqlite3.OperationalError <span class="keyword">as</span> sql_error:
<a name="l00614"></a>00614             <span class="keywordflow">if</span> <span class="stringliteral">&apos;already exists&apos;</span> <span class="keywordflow">in</span> str(sql_error):
<a name="l00615"></a>00615                 <span class="keywordflow">pass</span>
<a name="l00616"></a>00616             <span class="keywordflow">else</span>:
<a name="l00617"></a>00617                 <span class="keywordflow">raise</span> sql_error
<a name="l00618"></a>00618         <span class="keywordflow">except</span> sqlite3.DatabaseError <span class="keyword">as</span> sql_error:
<a name="l00619"></a>00619             <span class="keywordflow">raise</span> LsmError(
<a name="l00620"></a>00620                 ErrorNumber.INVALID_ARGUMENT,
<a name="l00621"></a>00621                 <span class="stringliteral">&quot;Stored simulator state incompatible with &quot;</span>
<a name="l00622"></a>00622                 <span class="stringliteral">&quot;simulator, please move or delete %s&quot;</span> % self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">statefile</a>)
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keyword">def </span>_check_version(self):
<a name="l00625"></a>00625         sim_syss = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a83990aecb73ed537a22f1f6ceb6acec0">sim_syss</a>()
<a name="l00626"></a>00626         <span class="keywordflow">if</span> len(sim_syss) == 0 <span class="keywordflow">or</span> <span class="keywordflow">not</span> sim_syss[0]:
<a name="l00627"></a>00627             <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00628"></a>00628         <span class="keywordflow">else</span>:
<a name="l00629"></a>00629             <span class="keywordflow">if</span> <span class="stringliteral">&apos;version&apos;</span> <span class="keywordflow">in</span> sim_syss[0] <span class="keywordflow">and</span> \
<a name="l00630"></a>00630                sim_syss[0][<span class="stringliteral">&apos;version&apos;</span>] == BackStore.VERSION_SIGNATURE:
<a name="l00631"></a>00631                 <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="keywordflow">raise</span> LsmError(
<a name="l00634"></a>00634             ErrorNumber.INVALID_ARGUMENT,
<a name="l00635"></a>00635             <span class="stringliteral">&quot;Stored simulator state incompatible with &quot;</span>
<a name="l00636"></a>00636             <span class="stringliteral">&quot;simulator, please move or delete %s&quot;</span> % self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">statefile</a>)
<a name="l00637"></a>00637 
<a name="l00638"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a751b04e4e6c3e6c81c55e49fcafb307c">00638</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a751b04e4e6c3e6c81c55e49fcafb307c">check_version_and_init</a>(self):
<a name="l00639"></a>00639         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00640"></a>00640 <span class="stringliteral">        Raise error if version not match.</span>
<a name="l00641"></a>00641 <span class="stringliteral">        If empty database found, initiate.</span>
<a name="l00642"></a>00642 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00643"></a>00643         <span class="comment"># The complex lock workflow is all caused by python sqlite3 do</span>
<a name="l00644"></a>00644         <span class="comment"># autocommit for &quot;CREATE TABLE&quot; command.</span>
<a name="l00645"></a>00645         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5eef5dbe16dc8155172b683df7824db5">trans_begin</a>()
<a name="l00646"></a>00646         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a02cc524638c329a5a15d41a7b0886a28">_check_version</a>():
<a name="l00647"></a>00647             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5c5af3de44f7f1c02498c70338865b3a">trans_commit</a>()
<a name="l00648"></a>00648             <span class="keywordflow">return</span>
<a name="l00649"></a>00649         <span class="keywordflow">else</span>:
<a name="l00650"></a>00650             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00651"></a>00651                 <span class="stringliteral">&apos;systems&apos;</span>,
<a name="l00652"></a>00652                 {
<a name="l00653"></a>00653                     <span class="stringliteral">&apos;id&apos;</span>: BackStore.SYS_ID,
<a name="l00654"></a>00654                     <span class="stringliteral">&apos;name&apos;</span>: BackStore.SYS_NAME,
<a name="l00655"></a>00655                     <span class="stringliteral">&apos;status&apos;</span>: System.STATUS_OK,
<a name="l00656"></a>00656                     <span class="stringliteral">&apos;status_info&apos;</span>: <span class="stringliteral">&quot;&quot;</span>,
<a name="l00657"></a>00657                     <span class="stringliteral">&apos;version&apos;</span>: BackStore.VERSION_SIGNATURE,
<a name="l00658"></a>00658                 })
<a name="l00659"></a>00659 
<a name="l00660"></a>00660             size_bytes_2t = size_human_2_size_bytes(<span class="stringliteral">&apos;2TiB&apos;</span>)
<a name="l00661"></a>00661             size_bytes_512g = size_human_2_size_bytes(<span class="stringliteral">&apos;512GiB&apos;</span>)
<a name="l00662"></a>00662             <span class="comment"># Add 2 SATA disks(2TiB)</span>
<a name="l00663"></a>00663             pool_1_disks = []
<a name="l00664"></a>00664             <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(0, 2):
<a name="l00665"></a>00665                 self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00666"></a>00666                     <span class="stringliteral">&apos;disks&apos;</span>,
<a name="l00667"></a>00667                     {
<a name="l00668"></a>00668                         <span class="stringliteral">&apos;disk_prefix&apos;</span>: <span class="stringliteral">&quot;2TiB SATA Disk&quot;</span>,
<a name="l00669"></a>00669                         <span class="stringliteral">&apos;total_space&apos;</span>: size_bytes_2t,
<a name="l00670"></a>00670                         <span class="stringliteral">&apos;disk_type&apos;</span>: Disk.TYPE_SATA,
<a name="l00671"></a>00671                         <span class="stringliteral">&apos;status&apos;</span>: Disk.STATUS_OK,
<a name="l00672"></a>00672                     })
<a name="l00673"></a>00673                 pool_1_disks.append(self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>)
<a name="l00674"></a>00674 
<a name="l00675"></a>00675             test_pool_disks = []
<a name="l00676"></a>00676             <span class="comment"># Add 6 SAS disks(2TiB)</span>
<a name="l00677"></a>00677             <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(0, 6):
<a name="l00678"></a>00678                 self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00679"></a>00679                     <span class="stringliteral">&apos;disks&apos;</span>,
<a name="l00680"></a>00680                     {
<a name="l00681"></a>00681                         <span class="stringliteral">&apos;disk_prefix&apos;</span>: <span class="stringliteral">&quot;2TiB SAS Disk&quot;</span>,
<a name="l00682"></a>00682                         <span class="stringliteral">&apos;total_space&apos;</span>: size_bytes_2t,
<a name="l00683"></a>00683                         <span class="stringliteral">&apos;disk_type&apos;</span>: Disk.TYPE_SAS,
<a name="l00684"></a>00684                         <span class="stringliteral">&apos;status&apos;</span>: Disk.STATUS_OK,
<a name="l00685"></a>00685                     })
<a name="l00686"></a>00686                 <span class="keywordflow">if</span> len(test_pool_disks) &lt; 2:
<a name="l00687"></a>00687                     test_pool_disks.append(self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>)
<a name="l00688"></a>00688 
<a name="l00689"></a>00689             ssd_pool_disks = []
<a name="l00690"></a>00690             <span class="comment"># Add 5 SSD disks(512GiB)</span>
<a name="l00691"></a>00691             <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(0, 5):
<a name="l00692"></a>00692                 self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00693"></a>00693                     <span class="stringliteral">&apos;disks&apos;</span>,
<a name="l00694"></a>00694                     {
<a name="l00695"></a>00695                         <span class="stringliteral">&apos;disk_prefix&apos;</span>: <span class="stringliteral">&quot;512GiB SSD Disk&quot;</span>,
<a name="l00696"></a>00696                         <span class="stringliteral">&apos;total_space&apos;</span>: size_bytes_512g,
<a name="l00697"></a>00697                         <span class="stringliteral">&apos;disk_type&apos;</span>: Disk.TYPE_SSD,
<a name="l00698"></a>00698                         <span class="stringliteral">&apos;status&apos;</span>: Disk.STATUS_OK,
<a name="l00699"></a>00699                     })
<a name="l00700"></a>00700                 <span class="keywordflow">if</span> len(ssd_pool_disks) &lt; 2:
<a name="l00701"></a>00701                     ssd_pool_disks.append(self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>)
<a name="l00702"></a>00702 
<a name="l00703"></a>00703             <span class="comment"># Add 7 SSD disks(2TiB)</span>
<a name="l00704"></a>00704             <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(0, 7):
<a name="l00705"></a>00705                 self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00706"></a>00706                     <span class="stringliteral">&apos;disks&apos;</span>,
<a name="l00707"></a>00707                     {
<a name="l00708"></a>00708                         <span class="stringliteral">&apos;disk_prefix&apos;</span>: <span class="stringliteral">&quot;2TiB SSD Disk&quot;</span>,
<a name="l00709"></a>00709                         <span class="stringliteral">&apos;total_space&apos;</span>: size_bytes_2t,
<a name="l00710"></a>00710                         <span class="stringliteral">&apos;disk_type&apos;</span>: Disk.TYPE_SSD,
<a name="l00711"></a>00711                         <span class="stringliteral">&apos;status&apos;</span>: Disk.STATUS_OK,
<a name="l00712"></a>00712                     })
<a name="l00713"></a>00713 
<a name="l00714"></a>00714             pool_1_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a27ad580d03c98414e15cb1452c179b6b">sim_pool_create_from_disk</a>(
<a name="l00715"></a>00715                 name=<span class="stringliteral">&apos;Pool 1&apos;</span>,
<a name="l00716"></a>00716                 raid_type=Volume.RAID_TYPE_RAID1,
<a name="l00717"></a>00717                 sim_disk_ids=pool_1_disks,
<a name="l00718"></a>00718                 element_type=Pool.ELEMENT_TYPE_POOL |
<a name="l00719"></a>00719                 Pool.ELEMENT_TYPE_FS |
<a name="l00720"></a>00720                 Pool.ELEMENT_TYPE_VOLUME |
<a name="l00721"></a>00721                 Pool.ELEMENT_TYPE_DELTA |
<a name="l00722"></a>00722                 Pool.ELEMENT_TYPE_SYS_RESERVED,
<a name="l00723"></a>00723                 unsupported_actions=Pool.UNSUPPORTED_VOLUME_GROW |
<a name="l00724"></a>00724                 Pool.UNSUPPORTED_VOLUME_SHRINK)
<a name="l00725"></a>00725 
<a name="l00726"></a>00726             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3fe13a90b76d72c1be6d7bcfa0f142fd">sim_pool_create_sub_pool</a>(
<a name="l00727"></a>00727                 name=<span class="stringliteral">&apos;Pool 2(sub pool of Pool 1)&apos;</span>,
<a name="l00728"></a>00728                 parent_pool_id=pool_1_id,
<a name="l00729"></a>00729                 element_type=Pool.ELEMENT_TYPE_FS |
<a name="l00730"></a>00730                 Pool.ELEMENT_TYPE_VOLUME |
<a name="l00731"></a>00731                 Pool.ELEMENT_TYPE_DELTA,
<a name="l00732"></a>00732                 size=size_bytes_512g)
<a name="l00733"></a>00733 
<a name="l00734"></a>00734             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a27ad580d03c98414e15cb1452c179b6b">sim_pool_create_from_disk</a>(
<a name="l00735"></a>00735                 name=<span class="stringliteral">&apos;Pool 3&apos;</span>,
<a name="l00736"></a>00736                 raid_type=Volume.RAID_TYPE_RAID1,
<a name="l00737"></a>00737                 sim_disk_ids=ssd_pool_disks,
<a name="l00738"></a>00738                 element_type=Pool.ELEMENT_TYPE_FS |
<a name="l00739"></a>00739                 Pool.ELEMENT_TYPE_VOLUME |
<a name="l00740"></a>00740                 Pool.ELEMENT_TYPE_DELTA)
<a name="l00741"></a>00741 
<a name="l00742"></a>00742             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a27ad580d03c98414e15cb1452c179b6b">sim_pool_create_from_disk</a>(
<a name="l00743"></a>00743                 name=<span class="stringliteral">&apos;lsm_test_aggr&apos;</span>,
<a name="l00744"></a>00744                 element_type=Pool.ELEMENT_TYPE_FS |
<a name="l00745"></a>00745                 Pool.ELEMENT_TYPE_VOLUME |
<a name="l00746"></a>00746                 Pool.ELEMENT_TYPE_DELTA,
<a name="l00747"></a>00747                 raid_type=Volume.RAID_TYPE_RAID0,
<a name="l00748"></a>00748                 sim_disk_ids=test_pool_disks)
<a name="l00749"></a>00749 
<a name="l00750"></a>00750             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00751"></a>00751                 <span class="stringliteral">&apos;tgts&apos;</span>,
<a name="l00752"></a>00752                 {
<a name="l00753"></a>00753                     <span class="stringliteral">&apos;port_type&apos;</span>: TargetPort.TYPE_FC,
<a name="l00754"></a>00754                     <span class="stringliteral">&apos;service_address&apos;</span>: <span class="stringliteral">&apos;50:0a:09:86:99:4b:8d:c5&apos;</span>,
<a name="l00755"></a>00755                     <span class="stringliteral">&apos;network_address&apos;</span>: <span class="stringliteral">&apos;50:0a:09:86:99:4b:8d:c5&apos;</span>,
<a name="l00756"></a>00756                     <span class="stringliteral">&apos;physical_address&apos;</span>: <span class="stringliteral">&apos;50:0a:09:86:99:4b:8d:c5&apos;</span>,
<a name="l00757"></a>00757                     <span class="stringliteral">&apos;physical_name&apos;</span>: <span class="stringliteral">&apos;FC_a_0b&apos;</span>,
<a name="l00758"></a>00758                 })
<a name="l00759"></a>00759 
<a name="l00760"></a>00760             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00761"></a>00761                 <span class="stringliteral">&apos;tgts&apos;</span>,
<a name="l00762"></a>00762                 {
<a name="l00763"></a>00763                     <span class="stringliteral">&apos;port_type&apos;</span>: TargetPort.TYPE_FCOE,
<a name="l00764"></a>00764                     <span class="stringliteral">&apos;service_address&apos;</span>: <span class="stringliteral">&apos;50:0a:09:86:99:4b:8d:c6&apos;</span>,
<a name="l00765"></a>00765                     <span class="stringliteral">&apos;network_address&apos;</span>: <span class="stringliteral">&apos;50:0a:09:86:99:4b:8d:c6&apos;</span>,
<a name="l00766"></a>00766                     <span class="stringliteral">&apos;physical_address&apos;</span>: <span class="stringliteral">&apos;50:0a:09:86:99:4b:8d:c6&apos;</span>,
<a name="l00767"></a>00767                     <span class="stringliteral">&apos;physical_name&apos;</span>: <span class="stringliteral">&apos;FCoE_b_0c&apos;</span>,
<a name="l00768"></a>00768                 })
<a name="l00769"></a>00769             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00770"></a>00770                 <span class="stringliteral">&apos;tgts&apos;</span>,
<a name="l00771"></a>00771                 {
<a name="l00772"></a>00772                     <span class="stringliteral">&apos;port_type&apos;</span>: TargetPort.TYPE_ISCSI,
<a name="l00773"></a>00773                     <span class="stringliteral">&apos;service_address&apos;</span>: <span class="stringliteral">&apos;iqn.1986-05.com.example:sim-tgt-03&apos;</span>,
<a name="l00774"></a>00774                     <span class="stringliteral">&apos;network_address&apos;</span>: <span class="stringliteral">&apos;sim-iscsi-tgt-3.example.com:3260&apos;</span>,
<a name="l00775"></a>00775                     <span class="stringliteral">&apos;physical_address&apos;</span>: <span class="stringliteral">&apos;a4:4e:31:47:f4:e0&apos;</span>,
<a name="l00776"></a>00776                     <span class="stringliteral">&apos;physical_name&apos;</span>: <span class="stringliteral">&apos;iSCSI_c_0d&apos;</span>,
<a name="l00777"></a>00777                 })
<a name="l00778"></a>00778             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00779"></a>00779                 <span class="stringliteral">&apos;tgts&apos;</span>,
<a name="l00780"></a>00780                 {
<a name="l00781"></a>00781                     <span class="stringliteral">&apos;port_type&apos;</span>: TargetPort.TYPE_ISCSI,
<a name="l00782"></a>00782                     <span class="stringliteral">&apos;service_address&apos;</span>: <span class="stringliteral">&apos;iqn.1986-05.com.example:sim-tgt-03&apos;</span>,
<a name="l00783"></a>00783                     <span class="stringliteral">&apos;network_address&apos;</span>: <span class="stringliteral">&apos;10.0.0.1:3260&apos;</span>,
<a name="l00784"></a>00784                     <span class="stringliteral">&apos;physical_address&apos;</span>: <span class="stringliteral">&apos;a4:4e:31:47:f4:e1&apos;</span>,
<a name="l00785"></a>00785                     <span class="stringliteral">&apos;physical_name&apos;</span>: <span class="stringliteral">&apos;iSCSI_c_0e&apos;</span>,
<a name="l00786"></a>00786                 })
<a name="l00787"></a>00787             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00788"></a>00788                 <span class="stringliteral">&apos;tgts&apos;</span>,
<a name="l00789"></a>00789                 {
<a name="l00790"></a>00790                     <span class="stringliteral">&apos;port_type&apos;</span>: TargetPort.TYPE_ISCSI,
<a name="l00791"></a>00791                     <span class="stringliteral">&apos;service_address&apos;</span>: <span class="stringliteral">&apos;iqn.1986-05.com.example:sim-tgt-03&apos;</span>,
<a name="l00792"></a>00792                     <span class="stringliteral">&apos;network_address&apos;</span>: <span class="stringliteral">&apos;[2001:470:1f09:efe:a64e:31ff::1]:3260&apos;</span>,
<a name="l00793"></a>00793                     <span class="stringliteral">&apos;physical_address&apos;</span>: <span class="stringliteral">&apos;a4:4e:31:47:f4:e1&apos;</span>,
<a name="l00794"></a>00794                     <span class="stringliteral">&apos;physical_name&apos;</span>: <span class="stringliteral">&apos;iSCSI_c_0e&apos;</span>,
<a name="l00795"></a>00795                 })
<a name="l00796"></a>00796 
<a name="l00797"></a>00797             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5c5af3de44f7f1c02498c70338865b3a">trans_commit</a>()
<a name="l00798"></a>00798             <span class="keywordflow">return</span>
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <span class="keyword">def </span>_sql_exec(self, sql_cmd, key_list=None):
<a name="l00801"></a>00801         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00802"></a>00802 <span class="stringliteral">        Execute sql command and get all output.</span>
<a name="l00803"></a>00803 <span class="stringliteral">        If key_list is not None, will convert returned sql data to a list of</span>
<a name="l00804"></a>00804 <span class="stringliteral">        dictionaries.</span>
<a name="l00805"></a>00805 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00806"></a>00806         sql_cur = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">sql_conn</a>.cursor()
<a name="l00807"></a>00807         sql_cur.execute(sql_cmd)
<a name="l00808"></a>00808         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a> = sql_cur.lastrowid
<a name="l00809"></a>00809         sql_output = sql_cur.fetchall()
<a name="l00810"></a>00810         <span class="keywordflow">if</span> key_list <span class="keywordflow">and</span> sql_output:
<a name="l00811"></a>00811             <span class="keywordflow">return</span> list(
<a name="l00812"></a>00812                 dict(zip(key_list, value_list))
<a name="l00813"></a>00813                 <span class="keywordflow">for</span> value_list <span class="keywordflow">in</span> sql_output
<a name="l00814"></a>00814                 <span class="keywordflow">if</span> value_list)
<a name="l00815"></a>00815         <span class="keywordflow">else</span>:
<a name="l00816"></a>00816             <span class="keywordflow">return</span> sql_output
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <span class="keyword">def </span>_get_table(self, table_name, key_list):
<a name="l00819"></a>00819         sql_cmd = <span class="stringliteral">&quot;SELECT %s FROM %s&quot;</span> % (<span class="stringliteral">&quot;,&quot;</span>.join(key_list), table_name)
<a name="l00820"></a>00820         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(sql_cmd, key_list)
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5eef5dbe16dc8155172b683df7824db5">00822</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5eef5dbe16dc8155172b683df7824db5">trans_begin</a>(self):
<a name="l00823"></a>00823         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">sql_conn</a>.execute(<span class="stringliteral">&quot;BEGIN IMMEDIATE TRANSACTION;&quot;</span>)
<a name="l00824"></a>00824 
<a name="l00825"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5c5af3de44f7f1c02498c70338865b3a">00825</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a5c5af3de44f7f1c02498c70338865b3a">trans_commit</a>(self):
<a name="l00826"></a>00826         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">sql_conn</a>.commit()
<a name="l00827"></a>00827 
<a name="l00828"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a640625d726c7e7b1b65a315c030b5b14">00828</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a640625d726c7e7b1b65a315c030b5b14">trans_rollback</a>(self):
<a name="l00829"></a>00829         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#af84d1d0c697fa274fda4c7b57bf1353d">sql_conn</a>.rollback()
<a name="l00830"></a>00830 
<a name="l00831"></a>00831     <span class="keyword">def </span>_data_add(self, table_name, data_dict):
<a name="l00832"></a>00832         keys = data_dict.keys()
<a name="l00833"></a>00833         values = [<span class="stringliteral">&apos;&apos;</span> <span class="keywordflow">if</span> v <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> str(v) <span class="keywordflow">for</span> v <span class="keywordflow">in</span> data_dict.values()]
<a name="l00834"></a>00834 
<a name="l00835"></a>00835         sql_cmd = <span class="stringliteral">&quot;INSERT INTO %s (%s) VALUES (%s);&quot;</span> % \
<a name="l00836"></a>00836                   (table_name,
<a name="l00837"></a>00837                    <span class="stringliteral">&quot;&apos;%s&apos;&quot;</span> % (<span class="stringliteral">&quot;&apos;, &apos;&quot;</span>.join(keys)),
<a name="l00838"></a>00838                    <span class="stringliteral">&quot;&apos;%s&apos;&quot;</span> % (<span class="stringliteral">&quot;&apos;, &apos;&quot;</span>.join(values)))
<a name="l00839"></a>00839         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(sql_cmd)
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="keyword">def </span>_data_find(self, table, condition, key_list, flag_unique=False):
<a name="l00842"></a>00842         sql_cmd = <span class="stringliteral">&quot;SELECT %s FROM %s WHERE %s&quot;</span> % (
<a name="l00843"></a>00843             <span class="stringliteral">&quot;,&quot;</span>.join(key_list), table, condition)
<a name="l00844"></a>00844         sim_datas = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(sql_cmd, key_list)
<a name="l00845"></a>00845         <span class="keywordflow">if</span> flag_unique:
<a name="l00846"></a>00846             <span class="keywordflow">if</span> len(sim_datas) == 0:
<a name="l00847"></a>00847                 <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00848"></a>00848             <span class="keywordflow">elif</span> len(sim_datas) == 1:
<a name="l00849"></a>00849                 <span class="keywordflow">return</span> sim_datas[0]
<a name="l00850"></a>00850             <span class="keywordflow">else</span>:
<a name="l00851"></a>00851                 <span class="keywordflow">raise</span> LsmError(
<a name="l00852"></a>00852                     ErrorNumber.PLUGIN_BUG,
<a name="l00853"></a>00853                     <span class="stringliteral">&quot;_data_find(): Got non-unique data: %s&quot;</span> % locals())
<a name="l00854"></a>00854         <span class="keywordflow">else</span>:
<a name="l00855"></a>00855             <span class="keywordflow">return</span> sim_datas
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="keyword">def </span>_data_update(self, table, data_id, column_name, value):
<a name="l00858"></a>00858         <span class="keywordflow">if</span> value <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00859"></a>00859             value = <span class="stringliteral">&apos;&apos;</span>
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         sql_cmd = <span class="stringliteral">&quot;UPDATE %s SET %s=&apos;%s&apos; WHERE id=&apos;%s&apos;&quot;</span> % \
<a name="l00862"></a>00862             (table, column_name, value, data_id)
<a name="l00863"></a>00863 
<a name="l00864"></a>00864         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(sql_cmd)
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="keyword">def </span>_data_delete(self, table, condition):
<a name="l00867"></a>00867         sql_cmd = <span class="stringliteral">&quot;DELETE FROM %s WHERE %s;&quot;</span> % (table, condition)
<a name="l00868"></a>00868         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(sql_cmd)
<a name="l00869"></a>00869 
<a name="l00870"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a1dbc55190099c54a8e16662eb79196e9">00870</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a1dbc55190099c54a8e16662eb79196e9">sim_job_create</a>(self, job_data_type=None, data_id=None):
<a name="l00871"></a>00871         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00872"></a>00872 <span class="stringliteral">        Return a job id(Integer)</span>
<a name="l00873"></a>00873 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00874"></a>00874         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00875"></a>00875             <span class="stringliteral">&quot;jobs&quot;</span>,
<a name="l00876"></a>00876             {
<a name="l00877"></a>00877                 <span class="stringliteral">&quot;duration&quot;</span>: os.getenv(
<a name="l00878"></a>00878                     <span class="stringliteral">&quot;LSM_SIM_TIME&quot;</span>, BackStore.JOB_DEFAULT_DURATION),
<a name="l00879"></a>00879                 <span class="stringliteral">&quot;timestamp&quot;</span>: time.time(),
<a name="l00880"></a>00880                 <span class="stringliteral">&quot;data_type&quot;</span>: job_data_type,
<a name="l00881"></a>00881                 <span class="stringliteral">&quot;data_id&quot;</span>: data_id,
<a name="l00882"></a>00882             })
<a name="l00883"></a>00883         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l00884"></a>00884 
<a name="l00885"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a12d0e3e09d65e610289e5ccee31f2938">00885</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a12d0e3e09d65e610289e5ccee31f2938">sim_job_delete</a>(self, sim_job_id):
<a name="l00886"></a>00886         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;jobs&apos;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_job_id)
<a name="l00887"></a>00887 
<a name="l00888"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a6680a5269dbc2e8b83e1a0bef5b3921a">00888</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a6680a5269dbc2e8b83e1a0bef5b3921a">sim_job_status</a>(self, sim_job_id):
<a name="l00889"></a>00889         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00890"></a>00890 <span class="stringliteral">        Return (progress, data_type, data) tuple.</span>
<a name="l00891"></a>00891 <span class="stringliteral">        progress is the integer of percent.</span>
<a name="l00892"></a>00892 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00893"></a>00893         sim_job = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l00894"></a>00894             <span class="stringliteral">&apos;jobs&apos;</span>, <span class="stringliteral">&apos;id=%s&apos;</span> % sim_job_id, BackStore.JOB_KEY_LIST,
<a name="l00895"></a>00895             flag_unique=<span class="keyword">True</span>)
<a name="l00896"></a>00896         <span class="keywordflow">if</span> sim_job <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00897"></a>00897             <span class="keywordflow">raise</span> LsmError(
<a name="l00898"></a>00898                 ErrorNumber.NOT_FOUND_JOB, <span class="stringliteral">&quot;Job not found&quot;</span>)
<a name="l00899"></a>00899 
<a name="l00900"></a>00900         progress = int(
<a name="l00901"></a>00901             (time.time() - float(sim_job[<span class="stringliteral">&apos;timestamp&apos;</span>])) /
<a name="l00902"></a>00902             sim_job[<span class="stringliteral">&apos;duration&apos;</span>] * 100)
<a name="l00903"></a>00903 
<a name="l00904"></a>00904         data = <span class="keywordtype">None</span>
<a name="l00905"></a>00905         data_type = <span class="keywordtype">None</span>
<a name="l00906"></a>00906 
<a name="l00907"></a>00907         <span class="keywordflow">if</span> progress &gt;= 100:
<a name="l00908"></a>00908             progress = 100
<a name="l00909"></a>00909             <span class="keywordflow">if</span> sim_job[<span class="stringliteral">&apos;data_type&apos;</span>] == BackStore.JOB_DATA_TYPE_VOL:
<a name="l00910"></a>00910                 data = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(sim_job[<span class="stringliteral">&apos;data_id&apos;</span>])
<a name="l00911"></a>00911                 data_type = sim_job[<span class="stringliteral">&apos;data_type&apos;</span>]
<a name="l00912"></a>00912             <span class="keywordflow">elif</span> sim_job[<span class="stringliteral">&apos;data_type&apos;</span>] == BackStore.JOB_DATA_TYPE_FS:
<a name="l00913"></a>00913                 data = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_job[<span class="stringliteral">&apos;data_id&apos;</span>])
<a name="l00914"></a>00914                 data_type = sim_job[<span class="stringliteral">&apos;data_type&apos;</span>]
<a name="l00915"></a>00915             <span class="keywordflow">elif</span> sim_job[<span class="stringliteral">&apos;data_type&apos;</span>] == BackStore.JOB_DATA_TYPE_FS_SNAP:
<a name="l00916"></a>00916                 data = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">sim_fs_snap_of_id</a>(sim_job[<span class="stringliteral">&apos;data_id&apos;</span>])
<a name="l00917"></a>00917                 data_type = sim_job[<span class="stringliteral">&apos;data_type&apos;</span>]
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         <span class="keywordflow">return</span> (progress, data_type, data)
<a name="l00920"></a>00920 
<a name="l00921"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a83990aecb73ed537a22f1f6ceb6acec0">00921</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a83990aecb73ed537a22f1f6ceb6acec0">sim_syss</a>(self):
<a name="l00922"></a>00922         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00923"></a>00923 <span class="stringliteral">        Return a list of sim_sys dict.</span>
<a name="l00924"></a>00924 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00925"></a>00925         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;systems&apos;</span>, BackStore.SYS_KEY_LIST)
<a name="l00926"></a>00926 
<a name="l00927"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46c217b0e08537e85e23a580087690f1">00927</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46c217b0e08537e85e23a580087690f1">sim_disk_ids_of_pool</a>(self, sim_pool_id):
<a name="l00928"></a>00928         <span class="keywordflow">return</span> list(
<a name="l00929"></a>00929             d[<span class="stringliteral">&apos;id&apos;</span>]
<a name="l00930"></a>00930             <span class="keywordflow">for</span> d <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l00931"></a>00931                 <span class="stringliteral">&apos;disks&apos;</span>, <span class="stringliteral">&apos;owner_pool_id=&quot;%s&quot;&apos;</span> % sim_pool_id, [<span class="stringliteral">&apos;id&apos;</span>]))
<a name="l00932"></a>00932 
<a name="l00933"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ad70f878083a3f5bf0f67ce021525a366">00933</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ad70f878083a3f5bf0f67ce021525a366">sim_disks</a>(self):
<a name="l00934"></a>00934         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00935"></a>00935 <span class="stringliteral">        Return a list of sim_disk dict.</span>
<a name="l00936"></a>00936 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00937"></a>00937         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;disks_view&apos;</span>, BackStore.DISK_KEY_LIST)
<a name="l00938"></a>00938 
<a name="l00939"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a8e77af76d75bea946bd84c7c469fbd57">00939</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a8e77af76d75bea946bd84c7c469fbd57">sim_pools</a>(self):
<a name="l00940"></a>00940         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00941"></a>00941 <span class="stringliteral">        Return a list of sim_pool dict.</span>
<a name="l00942"></a>00942 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00943"></a>00943         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;pools_view&apos;</span>, BackStore.POOL_KEY_LIST)
<a name="l00944"></a>00944 
<a name="l00945"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae1b560db8cc25d0b0b51b63cbf96687b">00945</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae1b560db8cc25d0b0b51b63cbf96687b">sim_pool_of_id</a>(self, sim_pool_id):
<a name="l00946"></a>00946         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a26cd46120d8fed1b8c45e58e38bdb23d">_sim_data_of_id</a>(
<a name="l00947"></a>00947             <span class="stringliteral">&quot;pools_view&quot;</span>, sim_pool_id, BackStore.POOL_KEY_LIST,
<a name="l00948"></a>00948             ErrorNumber.NOT_FOUND_POOL, <span class="stringliteral">&quot;Pool&quot;</span>)
<a name="l00949"></a>00949 
<a name="l00950"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a27ad580d03c98414e15cb1452c179b6b">00950</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a27ad580d03c98414e15cb1452c179b6b">sim_pool_create_from_disk</a>(self, name, sim_disk_ids, raid_type,
<a name="l00951"></a>00951                                   element_type, unsupported_actions=0,
<a name="l00952"></a>00952                                   strip_size=0):
<a name="l00953"></a>00953         <span class="keywordflow">if</span> strip_size == 0:
<a name="l00954"></a>00954             strip_size = BackStore.DEFAULT_STRIP_SIZE
<a name="l00955"></a>00955 
<a name="l00956"></a>00956         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00957"></a>00957             <span class="stringliteral">&apos;pools&apos;</span>,
<a name="l00958"></a>00958             {
<a name="l00959"></a>00959                 <span class="stringliteral">&apos;name&apos;</span>: name,
<a name="l00960"></a>00960                 <span class="stringliteral">&apos;status&apos;</span>: Pool.STATUS_OK,
<a name="l00961"></a>00961                 <span class="stringliteral">&apos;status_info&apos;</span>: <span class="stringliteral">&apos;&apos;</span>,
<a name="l00962"></a>00962                 <span class="stringliteral">&apos;element_type&apos;</span>: element_type,
<a name="l00963"></a>00963                 <span class="stringliteral">&apos;unsupported_actions&apos;</span>: unsupported_actions,
<a name="l00964"></a>00964                 <span class="stringliteral">&apos;raid_type&apos;</span>: raid_type,
<a name="l00965"></a>00965                 <span class="stringliteral">&apos;member_type&apos;</span>: Pool.MEMBER_TYPE_DISK,
<a name="l00966"></a>00966                 <span class="stringliteral">&apos;strip_size&apos;</span>: strip_size,
<a name="l00967"></a>00967             })
<a name="l00968"></a>00968 
<a name="l00969"></a>00969         data_disk_count = PoolRAID.data_disk_count(
<a name="l00970"></a>00970             raid_type, len(sim_disk_ids))
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <span class="comment"># update disk owner</span>
<a name="l00973"></a>00973         sim_pool_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l00974"></a>00974         <span class="keywordflow">for</span> sim_disk_id <span class="keywordflow">in</span> sim_disk_ids[:data_disk_count]:
<a name="l00975"></a>00975             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l00976"></a>00976                 <span class="stringliteral">&apos;disks&apos;</span>, sim_disk_id, <span class="stringliteral">&apos;owner_pool_id&apos;</span>, sim_pool_id)
<a name="l00977"></a>00977             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l00978"></a>00978                 <span class="stringliteral">&apos;disks&apos;</span>, sim_disk_id, <span class="stringliteral">&apos;role&apos;</span>, <span class="stringliteral">&apos;DATA&apos;</span>)
<a name="l00979"></a>00979 
<a name="l00980"></a>00980         <span class="keywordflow">for</span> sim_disk_id <span class="keywordflow">in</span> sim_disk_ids[data_disk_count:]:
<a name="l00981"></a>00981             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l00982"></a>00982                 <span class="stringliteral">&apos;disks&apos;</span>, sim_disk_id, <span class="stringliteral">&apos;owner_pool_id&apos;</span>, sim_pool_id)
<a name="l00983"></a>00983             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l00984"></a>00984                 <span class="stringliteral">&apos;disks&apos;</span>, sim_disk_id, <span class="stringliteral">&apos;role&apos;</span>, <span class="stringliteral">&apos;PARITY&apos;</span>)
<a name="l00985"></a>00985 
<a name="l00986"></a>00986         <span class="keywordflow">return</span> sim_pool_id
<a name="l00987"></a>00987 
<a name="l00988"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3fe13a90b76d72c1be6d7bcfa0f142fd">00988</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3fe13a90b76d72c1be6d7bcfa0f142fd">sim_pool_create_sub_pool</a>(self, name, parent_pool_id, size,
<a name="l00989"></a>00989                                  element_type, unsupported_actions=0):
<a name="l00990"></a>00990         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l00991"></a>00991             <span class="stringliteral">&apos;pools&apos;</span>,
<a name="l00992"></a>00992             {
<a name="l00993"></a>00993                 <span class="stringliteral">&apos;name&apos;</span>: name,
<a name="l00994"></a>00994                 <span class="stringliteral">&apos;status&apos;</span>: Pool.STATUS_OK,
<a name="l00995"></a>00995                 <span class="stringliteral">&apos;status_info&apos;</span>: <span class="stringliteral">&apos;&apos;</span>,
<a name="l00996"></a>00996                 <span class="stringliteral">&apos;element_type&apos;</span>: element_type,
<a name="l00997"></a>00997                 <span class="stringliteral">&apos;unsupported_actions&apos;</span>: unsupported_actions,
<a name="l00998"></a>00998                 <span class="stringliteral">&apos;raid_type&apos;</span>: Volume.RAID_TYPE_OTHER,
<a name="l00999"></a>00999                 <span class="stringliteral">&apos;member_type&apos;</span>: Pool.MEMBER_TYPE_POOL,
<a name="l01000"></a>01000                 <span class="stringliteral">&apos;parent_pool_id&apos;</span>: parent_pool_id,
<a name="l01001"></a>01001                 <span class="stringliteral">&apos;total_space&apos;</span>: size,
<a name="l01002"></a>01002             })
<a name="l01003"></a>01003         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l01004"></a>01004 
<a name="l01005"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab178f21a1c6b92974ab1d7d68488168b">01005</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab178f21a1c6b92974ab1d7d68488168b">sim_pool_disks_count</a>(self, sim_pool_id):
<a name="l01006"></a>01006         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(
<a name="l01007"></a>01007             <span class="stringliteral">&quot;SELECT COUNT(id) FROM disks WHERE owner_pool_id=%s;&quot;</span> %
<a name="l01008"></a>01008             sim_pool_id)[0][0]
<a name="l01009"></a>01009 
<a name="l01010"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a402765564ab70596f306bfe759a6a79d">01010</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a402765564ab70596f306bfe759a6a79d">sim_pool_data_disks_count</a>(self, sim_pool_id=None):
<a name="l01011"></a>01011         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(
<a name="l01012"></a>01012             <span class="stringliteral">&quot;SELECT COUNT(id) FROM disks WHERE &quot;</span>
<a name="l01013"></a>01013             <span class="stringliteral">&quot;owner_pool_id=%s and role=&apos;DATA&apos;;&quot;</span> % sim_pool_id)[0][0]
<a name="l01014"></a>01014 
<a name="l01015"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a2244f02b337c11db541ff19e42e48711">01015</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a2244f02b337c11db541ff19e42e48711">sim_vols</a>(self, sim_ag_id=None):
<a name="l01016"></a>01016         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01017"></a>01017 <span class="stringliteral">        Return a list of sim_vol dict.</span>
<a name="l01018"></a>01018 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01019"></a>01019         <span class="keywordflow">if</span> sim_ag_id:
<a name="l01020"></a>01020             <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01021"></a>01021                 <span class="stringliteral">&apos;volumes_by_ag_view&apos;</span>, <span class="stringliteral">&apos;ag_id=%s&apos;</span> % sim_ag_id,
<a name="l01022"></a>01022                 BackStore.VOL_KEY_LIST)
<a name="l01023"></a>01023         <span class="keywordflow">else</span>:
<a name="l01024"></a>01024             <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;volumes&apos;</span>, BackStore.VOL_KEY_LIST)
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     <span class="keyword">def </span>_sim_data_of_id(self, table_name, data_id, key_list, lsm_error_no,
<a name="l01027"></a>01027                         data_name):
<a name="l01028"></a>01028         sim_data = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01029"></a>01029             table_name, <span class="stringliteral">&apos;id=%s&apos;</span> % data_id, key_list, flag_unique=<span class="keyword">True</span>)
<a name="l01030"></a>01030         <span class="keywordflow">if</span> sim_data <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l01031"></a>01031             <span class="keywordflow">if</span> lsm_error_no:
<a name="l01032"></a>01032                 <span class="keywordflow">raise</span> LsmError(
<a name="l01033"></a>01033                     lsm_error_no, <span class="stringliteral">&quot;%s not found&quot;</span> % data_name)
<a name="l01034"></a>01034             <span class="keywordflow">else</span>:
<a name="l01035"></a>01035                 <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01036"></a>01036         <span class="keywordflow">return</span> sim_data
<a name="l01037"></a>01037 
<a name="l01038"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">01038</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(self, sim_vol_id):
<a name="l01039"></a>01039         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01040"></a>01040 <span class="stringliteral">        Return sim_vol if found. Raise error if not found.</span>
<a name="l01041"></a>01041 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01042"></a>01042         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a26cd46120d8fed1b8c45e58e38bdb23d">_sim_data_of_id</a>(
<a name="l01043"></a>01043             <span class="stringliteral">&quot;volumes&quot;</span>, sim_vol_id, BackStore.VOL_KEY_LIST,
<a name="l01044"></a>01044             ErrorNumber.NOT_FOUND_VOLUME,
<a name="l01045"></a>01045             <span class="stringliteral">&quot;Volume&quot;</span>)
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     <span class="keyword">def </span>_check_pool_free_space(self, sim_pool_id, size_bytes):
<a name="l01048"></a>01048         sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae1b560db8cc25d0b0b51b63cbf96687b">sim_pool_of_id</a>(sim_pool_id)
<a name="l01049"></a>01049 
<a name="l01050"></a>01050         <span class="keywordflow">if</span> (sim_pool[<span class="stringliteral">&apos;free_space&apos;</span>] &lt; size_bytes):
<a name="l01051"></a>01051             <span class="keywordflow">raise</span> LsmError(ErrorNumber.NOT_ENOUGH_SPACE,
<a name="l01052"></a>01052                            <span class="stringliteral">&quot;Insufficient space in pool&quot;</span>)
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     @staticmethod
<a name="l01055"></a>01055     <span class="keyword">def </span>_block_rounding(size_bytes):
<a name="l01056"></a>01056         <span class="keywordflow">return</span> (size_bytes + BackStore.BLK_SIZE - 1) / \
<a name="l01057"></a>01057             BackStore.BLK_SIZE * BackStore.BLK_SIZE
<a name="l01058"></a>01058 
<a name="l01059"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a0904b3033421343f4ab5503ef3a0e963">01059</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a0904b3033421343f4ab5503ef3a0e963">sim_vol_create</a>(self, name, size_bytes, sim_pool_id, thinp,
<a name="l01060"></a>01060                        is_hw_raid_vol=0):
<a name="l01061"></a>01061 
<a name="l01062"></a>01062         size_bytes = BackStore._block_rounding(size_bytes)
<a name="l01063"></a>01063         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a475f84c8b5484ee85533c8f8de9f14bf">_check_pool_free_space</a>(sim_pool_id, size_bytes)
<a name="l01064"></a>01064         sim_vol = dict()
<a name="l01065"></a>01065         sim_vol[<span class="stringliteral">&apos;vpd83&apos;</span>] = _random_vpd()
<a name="l01066"></a>01066         sim_vol[<span class="stringliteral">&apos;name&apos;</span>] = name
<a name="l01067"></a>01067         sim_vol[<span class="stringliteral">&apos;thinp&apos;</span>] = thinp
<a name="l01068"></a>01068         sim_vol[<span class="stringliteral">&apos;pool_id&apos;</span>] = sim_pool_id
<a name="l01069"></a>01069         sim_vol[<span class="stringliteral">&apos;total_space&apos;</span>] = size_bytes
<a name="l01070"></a>01070         sim_vol[<span class="stringliteral">&apos;consumed_size&apos;</span>] = size_bytes
<a name="l01071"></a>01071         sim_vol[<span class="stringliteral">&apos;admin_state&apos;</span>] = Volume.ADMIN_STATE_ENABLED
<a name="l01072"></a>01072         sim_vol[<span class="stringliteral">&apos;is_hw_raid_vol&apos;</span>] = is_hw_raid_vol
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <span class="keywordflow">try</span>:
<a name="l01075"></a>01075             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(<span class="stringliteral">&quot;volumes&quot;</span>, sim_vol)
<a name="l01076"></a>01076         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l01077"></a>01077             <span class="keywordflow">raise</span> LsmError(
<a name="l01078"></a>01078                 ErrorNumber.NAME_CONFLICT,
<a name="l01079"></a>01079                 <span class="stringliteral">&quot;Name &apos;%s&apos; is already in use by other volume&quot;</span> % name)
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l01082"></a>01082 
<a name="l01083"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aedb119d54e2fe6214efca6eb0716bb81">01083</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aedb119d54e2fe6214efca6eb0716bb81">sim_vol_delete</a>(self, sim_vol_id):
<a name="l01084"></a>01084         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01085"></a>01085 <span class="stringliteral">        This does not check whether volume exist or not.</span>
<a name="l01086"></a>01086 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01087"></a>01087         <span class="comment"># Check existence.</span>
<a name="l01088"></a>01088         sim_vol = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(sim_vol_id)
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aaf08f2b15a312a0a5b7641f7c251f5dd">_sim_ag_ids_of_masked_vol</a>(sim_vol_id):
<a name="l01091"></a>01091             <span class="keywordflow">raise</span> LsmError(
<a name="l01092"></a>01092                 ErrorNumber.IS_MASKED,
<a name="l01093"></a>01093                 <span class="stringliteral">&quot;Volume is masked to access group&quot;</span>)
<a name="l01094"></a>01094 
<a name="l01095"></a>01095         dst_sim_vol_ids = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a054df060a29bf14192604070d026b888">dst_sim_vol_ids_of_src</a>(sim_vol_id)
<a name="l01096"></a>01096         <span class="keywordflow">if</span> len(dst_sim_vol_ids) &gt;= 1:
<a name="l01097"></a>01097             <span class="keywordflow">for</span> dst_sim_vol_id <span class="keywordflow">in</span> dst_sim_vol_ids:
<a name="l01098"></a>01098                 <span class="keywordflow">if</span> dst_sim_vol_id != sim_vol_id:
<a name="l01099"></a>01099                     <span class="comment"># Don&apos;t raise error on volume internal replication.</span>
<a name="l01100"></a>01100                     <span class="keywordflow">raise</span> LsmError(
<a name="l01101"></a>01101                         ErrorNumber.PLUGIN_BUG,
<a name="l01102"></a>01102                         <span class="stringliteral">&quot;Requested volume is a replication source&quot;</span>)
<a name="l01103"></a>01103         <span class="keywordflow">if</span> sim_vol[<span class="stringliteral">&apos;is_hw_raid_vol&apos;</span>]:
<a name="l01104"></a>01104             <span class="comment"># Delete the parent pool instead if found a HW RAID volume.</span>
<a name="l01105"></a>01105             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&quot;pools&quot;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_vol[<span class="stringliteral">&apos;pool_id&apos;</span>])
<a name="l01106"></a>01106         <span class="keywordflow">else</span>:
<a name="l01107"></a>01107             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&quot;volumes&quot;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_vol_id)
<a name="l01108"></a>01108 
<a name="l01109"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a0339cc47627500025b6236cfd4dc4859">01109</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a0339cc47627500025b6236cfd4dc4859">sim_vol_mask</a>(self, sim_vol_id, sim_ag_id):
<a name="l01110"></a>01110         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(sim_vol_id)
<a name="l01111"></a>01111         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">sim_ag_of_id</a>(sim_ag_id)
<a name="l01112"></a>01112         exist_mask = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01113"></a>01113             <span class="stringliteral">&apos;vol_masks&apos;</span>, <span class="stringliteral">&apos;ag_id=&quot;%s&quot; AND vol_id=&quot;%s&quot;&apos;</span> %
<a name="l01114"></a>01114             (sim_ag_id, sim_vol_id), [<span class="stringliteral">&apos;vol_id&apos;</span>])
<a name="l01115"></a>01115         <span class="keywordflow">if</span> exist_mask:
<a name="l01116"></a>01116             <span class="keywordflow">raise</span> LsmError(
<a name="l01117"></a>01117                 ErrorNumber.NO_STATE_CHANGE,
<a name="l01118"></a>01118                 <span class="stringliteral">&quot;Volume is already masked to requested access group&quot;</span>)
<a name="l01119"></a>01119 
<a name="l01120"></a>01120         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01121"></a>01121             <span class="stringliteral">&quot;vol_masks&quot;</span>, {<span class="stringliteral">&apos;ag_id&apos;</span>: sim_ag_id, <span class="stringliteral">&apos;vol_id&apos;</span>: sim_vol_id})
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01124"></a>01124 
<a name="l01125"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a59d742a64a1d3c777cd5e4b49e0811f8">01125</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a59d742a64a1d3c777cd5e4b49e0811f8">sim_vol_unmask</a>(self, sim_vol_id, sim_ag_id):
<a name="l01126"></a>01126         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(sim_vol_id)
<a name="l01127"></a>01127         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">sim_ag_of_id</a>(sim_ag_id)
<a name="l01128"></a>01128         condition = <span class="stringliteral">&apos;ag_id=&quot;%s&quot; AND vol_id=&quot;%s&quot;&apos;</span> % (sim_ag_id, sim_vol_id)
<a name="l01129"></a>01129         exist_mask = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(<span class="stringliteral">&apos;vol_masks&apos;</span>, condition, [<span class="stringliteral">&apos;vol_id&apos;</span>])
<a name="l01130"></a>01130         <span class="keywordflow">if</span> exist_mask:
<a name="l01131"></a>01131             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;vol_masks&apos;</span>, condition)
<a name="l01132"></a>01132         <span class="keywordflow">else</span>:
<a name="l01133"></a>01133             <span class="keywordflow">raise</span> LsmError(
<a name="l01134"></a>01134                 ErrorNumber.NO_STATE_CHANGE,
<a name="l01135"></a>01135                 <span class="stringliteral">&quot;Volume is not masked to requested access group&quot;</span>)
<a name="l01136"></a>01136         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="keyword">def </span>_sim_vol_ids_of_masked_ag(self, sim_ag_id):
<a name="l01139"></a>01139         <span class="keywordflow">return</span> list(
<a name="l01140"></a>01140             m[<span class="stringliteral">&apos;vol_id&apos;</span>] <span class="keywordflow">for</span> m <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01141"></a>01141                 <span class="stringliteral">&apos;vol_masks&apos;</span>, <span class="stringliteral">&apos;ag_id=&quot;%s&quot;&apos;</span> % sim_ag_id, [<span class="stringliteral">&apos;vol_id&apos;</span>]))
<a name="l01142"></a>01142 
<a name="l01143"></a>01143     <span class="keyword">def </span>_sim_ag_ids_of_masked_vol(self, sim_vol_id):
<a name="l01144"></a>01144         <span class="keywordflow">return</span> list(
<a name="l01145"></a>01145             m[<span class="stringliteral">&apos;ag_id&apos;</span>] <span class="keywordflow">for</span> m <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01146"></a>01146                 <span class="stringliteral">&apos;vol_masks&apos;</span>, <span class="stringliteral">&apos;vol_id=&quot;%s&quot;&apos;</span> % sim_vol_id, [<span class="stringliteral">&apos;ag_id&apos;</span>]))
<a name="l01147"></a>01147 
<a name="l01148"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae248680ec47af379d3918e326693982b">01148</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae248680ec47af379d3918e326693982b">sim_vol_resize</a>(self, sim_vol_id, new_size_bytes):
<a name="l01149"></a>01149         org_new_size_bytes = new_size_bytes
<a name="l01150"></a>01150         new_size_bytes = BackStore._block_rounding(new_size_bytes)
<a name="l01151"></a>01151         sim_vol = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(sim_vol_id)
<a name="l01152"></a>01152         <span class="keywordflow">if</span> sim_vol[<span class="stringliteral">&apos;total_space&apos;</span>] == new_size_bytes:
<a name="l01153"></a>01153             <span class="keywordflow">if</span> org_new_size_bytes != new_size_bytes:
<a name="l01154"></a>01154                 <span class="comment"># Even volume size is identical to rounded size,</span>
<a name="l01155"></a>01155                 <span class="comment"># but it&apos;s not what user requested, hence we silently pass.</span>
<a name="l01156"></a>01156                 <span class="keywordflow">return</span>
<a name="l01157"></a>01157             <span class="keywordflow">else</span>:
<a name="l01158"></a>01158                 <span class="keywordflow">raise</span> LsmError(
<a name="l01159"></a>01159                     ErrorNumber.NO_STATE_CHANGE,
<a name="l01160"></a>01160                     <span class="stringliteral">&quot;Volume size is identical to requested&quot;</span>)
<a name="l01161"></a>01161 
<a name="l01162"></a>01162         sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae1b560db8cc25d0b0b51b63cbf96687b">sim_pool_of_id</a>(sim_vol[<span class="stringliteral">&apos;pool_id&apos;</span>])
<a name="l01163"></a>01163 
<a name="l01164"></a>01164         increment = new_size_bytes - sim_vol[<span class="stringliteral">&apos;total_space&apos;</span>]
<a name="l01165"></a>01165 
<a name="l01166"></a>01166         <span class="keywordflow">if</span> increment &gt; 0:
<a name="l01167"></a>01167 
<a name="l01168"></a>01168             <span class="keywordflow">if</span> sim_pool[<span class="stringliteral">&apos;unsupported_actions&apos;</span>] &amp; Pool.UNSUPPORTED_VOLUME_GROW:
<a name="l01169"></a>01169                 <span class="keywordflow">raise</span> LsmError(
<a name="l01170"></a>01170                     ErrorNumber.NO_SUPPORT,
<a name="l01171"></a>01171                     <span class="stringliteral">&quot;Requested pool does not allow volume size grow&quot;</span>)
<a name="l01172"></a>01172 
<a name="l01173"></a>01173             <span class="keywordflow">if</span> sim_pool[<span class="stringliteral">&apos;free_space&apos;</span>] &lt; increment:
<a name="l01174"></a>01174                 <span class="keywordflow">raise</span> LsmError(
<a name="l01175"></a>01175                     ErrorNumber.NOT_ENOUGH_SPACE, <span class="stringliteral">&quot;Insufficient space in pool&quot;</span>)
<a name="l01176"></a>01176 
<a name="l01177"></a>01177         <span class="keywordflow">elif</span> sim_pool[<span class="stringliteral">&apos;unsupported_actions&apos;</span>] &amp; Pool.UNSUPPORTED_VOLUME_SHRINK:
<a name="l01178"></a>01178             <span class="keywordflow">raise</span> LsmError(
<a name="l01179"></a>01179                 ErrorNumber.NO_SUPPORT,
<a name="l01180"></a>01180                 <span class="stringliteral">&quot;Requested pool does not allow volume size grow&quot;</span>)
<a name="l01181"></a>01181 
<a name="l01182"></a>01182         <span class="comment"># TODO(Gris Ge): If a volume is in a replication relationship, resize</span>
<a name="l01183"></a>01183         <span class="comment">#                should be handled properly.</span>
<a name="l01184"></a>01184         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l01185"></a>01185             <span class="stringliteral">&apos;volumes&apos;</span>, sim_vol_id, <span class="stringliteral">&quot;total_space&quot;</span>, new_size_bytes)
<a name="l01186"></a>01186         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l01187"></a>01187             <span class="stringliteral">&apos;volumes&apos;</span>, sim_vol_id, <span class="stringliteral">&quot;consumed_size&quot;</span>, new_size_bytes)
<a name="l01188"></a>01188 
<a name="l01189"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a054df060a29bf14192604070d026b888">01189</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a054df060a29bf14192604070d026b888">dst_sim_vol_ids_of_src</a>(self, src_sim_vol_id):
<a name="l01190"></a>01190         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01191"></a>01191 <span class="stringliteral">        Return a list of dst_vol_id for provided source volume ID.</span>
<a name="l01192"></a>01192 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01193"></a>01193         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(src_sim_vol_id)
<a name="l01194"></a>01194         <span class="keywordflow">return</span> list(
<a name="l01195"></a>01195             d[<span class="stringliteral">&apos;dst_vol_id&apos;</span>] <span class="keywordflow">for</span> d <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01196"></a>01196                 <span class="stringliteral">&apos;vol_reps&apos;</span>, <span class="stringliteral">&apos;src_vol_id=&quot;%s&quot;&apos;</span> % src_sim_vol_id,
<a name="l01197"></a>01197                 [<span class="stringliteral">&apos;dst_vol_id&apos;</span>]))
<a name="l01198"></a>01198 
<a name="l01199"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#afd64787de76f639ca4a5cc7c75fd9a76">01199</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#afd64787de76f639ca4a5cc7c75fd9a76">sim_vol_replica</a>(self, src_sim_vol_id, dst_sim_vol_id, rep_type,
<a name="l01200"></a>01200                         blk_ranges=<span class="keywordtype">None</span>):
<a name="l01201"></a>01201         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(src_sim_vol_id)
<a name="l01202"></a>01202         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(dst_sim_vol_id)
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         <span class="comment"># TODO(Gris Ge): Use consumed_size &lt; total_space to reflect the CLONE</span>
<a name="l01205"></a>01205         <span class="comment">#                type.</span>
<a name="l01206"></a>01206         cur_src_sim_vol_ids = list(
<a name="l01207"></a>01207             r[<span class="stringliteral">&apos;src_vol_id&apos;</span>] <span class="keywordflow">for</span> r <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01208"></a>01208                 <span class="stringliteral">&apos;vol_reps&apos;</span>, <span class="stringliteral">&apos;dst_vol_id=&quot;%s&quot;&apos;</span> % dst_sim_vol_id,
<a name="l01209"></a>01209                 [<span class="stringliteral">&apos;src_vol_id&apos;</span>]))
<a name="l01210"></a>01210         <span class="keywordflow">if</span> len(cur_src_sim_vol_ids) == 1 <span class="keywordflow">and</span> \
<a name="l01211"></a>01211            cur_src_sim_vol_ids[0] == src_sim_vol_id:
<a name="l01212"></a>01212             <span class="comment"># src and dst match. Maybe user are overriding old setting.</span>
<a name="l01213"></a>01213             <span class="keywordflow">pass</span>
<a name="l01214"></a>01214         <span class="keywordflow">elif</span> len(cur_src_sim_vol_ids) == 0:
<a name="l01215"></a>01215             <span class="keywordflow">pass</span>
<a name="l01216"></a>01216         <span class="keywordflow">else</span>:
<a name="l01217"></a>01217             <span class="comment"># TODO(Gris Ge): Need to introduce new API error</span>
<a name="l01218"></a>01218             <span class="keywordflow">raise</span> LsmError(
<a name="l01219"></a>01219                 ErrorNumber.PLUGIN_BUG,
<a name="l01220"></a>01220                 <span class="stringliteral">&quot;Target volume is already a replication target for other &quot;</span>
<a name="l01221"></a>01221                 <span class="stringliteral">&quot;source volume&quot;</span>)
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01224"></a>01224             <span class="stringliteral">&apos;vol_reps&apos;</span>,
<a name="l01225"></a>01225             {
<a name="l01226"></a>01226                 <span class="stringliteral">&apos;src_vol_id&apos;</span>: src_sim_vol_id,
<a name="l01227"></a>01227                 <span class="stringliteral">&apos;dst_vol_id&apos;</span>: dst_sim_vol_id,
<a name="l01228"></a>01228                 <span class="stringliteral">&apos;rep_type&apos;</span>: rep_type,
<a name="l01229"></a>01229             })
<a name="l01230"></a>01230 
<a name="l01231"></a>01231         <span class="comment"># No need to trace block range due to lack of query method.</span>
<a name="l01232"></a>01232 
<a name="l01233"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae2b40edb54ec8e573c25ed8c60f2b8e5">01233</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae2b40edb54ec8e573c25ed8c60f2b8e5">sim_vol_src_replica_break</a>(self, src_sim_vol_id):
<a name="l01234"></a>01234 
<a name="l01235"></a>01235         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a054df060a29bf14192604070d026b888">dst_sim_vol_ids_of_src</a>(src_sim_vol_id):
<a name="l01236"></a>01236             <span class="keywordflow">raise</span> LsmError(
<a name="l01237"></a>01237                 ErrorNumber.NO_STATE_CHANGE,
<a name="l01238"></a>01238                 <span class="stringliteral">&quot;Provided volume is not a replication source&quot;</span>)
<a name="l01239"></a>01239 
<a name="l01240"></a>01240         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(
<a name="l01241"></a>01241             <span class="stringliteral">&apos;vol_reps&apos;</span>, <span class="stringliteral">&apos;src_vol_id=&quot;%s&quot;&apos;</span> % src_sim_vol_id)
<a name="l01242"></a>01242 
<a name="l01243"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a588b4ce34e37409b826ed5f8a8cb9537">01243</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a588b4ce34e37409b826ed5f8a8cb9537">sim_vol_state_change</a>(self, sim_vol_id, new_admin_state):
<a name="l01244"></a>01244         sim_vol = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aa9dd8ca508fb5970be8d545992006641">sim_vol_of_id</a>(sim_vol_id)
<a name="l01245"></a>01245         <span class="keywordflow">if</span> sim_vol[<span class="stringliteral">&apos;admin_state&apos;</span>] == new_admin_state:
<a name="l01246"></a>01246             <span class="keywordflow">raise</span> LsmError(
<a name="l01247"></a>01247                 ErrorNumber.NO_STATE_CHANGE,
<a name="l01248"></a>01248                 <span class="stringliteral">&quot;Volume admin state is identical to requested&quot;</span>)
<a name="l01249"></a>01249 
<a name="l01250"></a>01250         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l01251"></a>01251             <span class="stringliteral">&apos;volumes&apos;</span>, sim_vol_id, <span class="stringliteral">&quot;admin_state&quot;</span>, new_admin_state)
<a name="l01252"></a>01252 
<a name="l01253"></a>01253     @staticmethod
<a name="l01254"></a>01254     <span class="keyword">def </span>_sim_ag_format(sim_ag):
<a name="l01255"></a>01255         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01256"></a>01256 <span class="stringliteral">        Update &apos;init_type&apos; and &apos;init_ids&apos; of sim_ag</span>
<a name="l01257"></a>01257 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01258"></a>01258         sim_ag[<span class="stringliteral">&apos;init_ids&apos;</span>] = sim_ag[<span class="stringliteral">&apos;init_ids_str&apos;</span>].split(
<a name="l01259"></a>01259             BackStore._LIST_SPLITTER)
<a name="l01260"></a>01260         del sim_ag[<span class="stringliteral">&apos;init_ids_str&apos;</span>]
<a name="l01261"></a>01261         <span class="keywordflow">return</span> sim_ag
<a name="l01262"></a>01262 
<a name="l01263"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a1fda77ccc608b4005f624e5e76ca0979">01263</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a1fda77ccc608b4005f624e5e76ca0979">sim_ags</a>(self, sim_vol_id=None):
<a name="l01264"></a>01264         <span class="keywordflow">if</span> sim_vol_id:
<a name="l01265"></a>01265             sim_ags = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01266"></a>01266                 <span class="stringliteral">&apos;ags_by_vol_view&apos;</span>, <span class="stringliteral">&apos;vol_id=%s&apos;</span> % sim_vol_id,
<a name="l01267"></a>01267                 BackStore.AG_KEY_LIST)
<a name="l01268"></a>01268         <span class="keywordflow">else</span>:
<a name="l01269"></a>01269             sim_ags = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;ags_view&apos;</span>, BackStore.AG_KEY_LIST)
<a name="l01270"></a>01270 
<a name="l01271"></a>01271         <span class="keywordflow">return</span> [BackStore._sim_ag_format(a) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> sim_ags]
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     <span class="keyword">def </span>_sim_init_create(self, init_type, init_id, sim_ag_id):
<a name="l01274"></a>01274         <span class="keywordflow">try</span>:
<a name="l01275"></a>01275             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01276"></a>01276                 <span class="stringliteral">&quot;inits&quot;</span>,
<a name="l01277"></a>01277                 {
<a name="l01278"></a>01278                     <span class="stringliteral">&apos;id&apos;</span>: init_id,
<a name="l01279"></a>01279                     <span class="stringliteral">&apos;init_type&apos;</span>: init_type,
<a name="l01280"></a>01280                     <span class="stringliteral">&apos;owner_ag_id&apos;</span>: sim_ag_id
<a name="l01281"></a>01281                 })
<a name="l01282"></a>01282         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l01283"></a>01283             <span class="keywordflow">raise</span> LsmError(
<a name="l01284"></a>01284                 ErrorNumber.EXISTS_INITIATOR,
<a name="l01285"></a>01285                 <span class="stringliteral">&quot;Initiator &apos;%s&apos; is already in use by other access group&quot;</span> %
<a name="l01286"></a>01286                 init_id)
<a name="l01287"></a>01287 
<a name="l01288"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aaed6fd5f5321eedaeb38d0e4becb3ac0">01288</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aaed6fd5f5321eedaeb38d0e4becb3ac0">iscsi_chap_auth_set</a>(self, init_id, in_user, in_pass, out_user,
<a name="l01289"></a>01289                             out_pass):
<a name="l01290"></a>01290         <span class="comment"># Currently, there is no API method to query status of iscsi CHAP.</span>
<a name="l01291"></a>01291         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01292"></a>01292 
<a name="l01293"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a58090e6b80aa25a531036d5c0a2c22ed">01293</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a58090e6b80aa25a531036d5c0a2c22ed">sim_ag_create</a>(self, name, init_type, init_id):
<a name="l01294"></a>01294         <span class="keywordflow">try</span>:
<a name="l01295"></a>01295             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(<span class="stringliteral">&quot;ags&quot;</span>, {<span class="stringliteral">&apos;name&apos;</span>: name})
<a name="l01296"></a>01296             sim_ag_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l01297"></a>01297         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l01298"></a>01298             <span class="keywordflow">raise</span> LsmError(
<a name="l01299"></a>01299                 ErrorNumber.NAME_CONFLICT,
<a name="l01300"></a>01300                 <span class="stringliteral">&quot;Name &apos;%s&apos; is already in use by other access group&quot;</span> %
<a name="l01301"></a>01301                 name)
<a name="l01302"></a>01302 
<a name="l01303"></a>01303         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a22b9d422dc9bbe448ae914be40f72d60">_sim_init_create</a>(init_type, init_id, sim_ag_id)
<a name="l01304"></a>01304 
<a name="l01305"></a>01305         <span class="keywordflow">return</span> sim_ag_id
<a name="l01306"></a>01306 
<a name="l01307"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a72687dfeecfb73ad75e60d66f3335d1b">01307</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a72687dfeecfb73ad75e60d66f3335d1b">sim_ag_delete</a>(self, sim_ag_id):
<a name="l01308"></a>01308         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">sim_ag_of_id</a>(sim_ag_id)
<a name="l01309"></a>01309         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a7e3eea6e9ec458761413cb875fd5ee28">_sim_vol_ids_of_masked_ag</a>(sim_ag_id):
<a name="l01310"></a>01310             <span class="keywordflow">raise</span> LsmError(
<a name="l01311"></a>01311                 ErrorNumber.IS_MASKED,
<a name="l01312"></a>01312                 <span class="stringliteral">&quot;Access group has volume masked to&quot;</span>)
<a name="l01313"></a>01313 
<a name="l01314"></a>01314         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;ags&apos;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_ag_id)
<a name="l01315"></a>01315 
<a name="l01316"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#adcfaaeda3aa101328a8962da5dc43bb5">01316</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#adcfaaeda3aa101328a8962da5dc43bb5">sim_ag_init_add</a>(self, sim_ag_id, init_id, init_type):
<a name="l01317"></a>01317         sim_ag = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">sim_ag_of_id</a>(sim_ag_id)
<a name="l01318"></a>01318         <span class="keywordflow">if</span> init_id <span class="keywordflow">in</span> sim_ag[<span class="stringliteral">&apos;init_ids&apos;</span>]:
<a name="l01319"></a>01319             <span class="keywordflow">raise</span> LsmError(
<a name="l01320"></a>01320                 ErrorNumber.NO_STATE_CHANGE,
<a name="l01321"></a>01321                 <span class="stringliteral">&quot;Initiator already in access group&quot;</span>)
<a name="l01322"></a>01322 
<a name="l01323"></a>01323         <span class="keywordflow">if</span> init_type != AccessGroup.INIT_TYPE_ISCSI_IQN <span class="keywordflow">and</span> \
<a name="l01324"></a>01324            init_type != AccessGroup.INIT_TYPE_WWPN:
<a name="l01325"></a>01325             <span class="keywordflow">raise</span> LsmError(
<a name="l01326"></a>01326                 ErrorNumber.NO_SUPPORT,
<a name="l01327"></a>01327                 <span class="stringliteral">&quot;Only support iSCSI IQN and WWPN initiator type&quot;</span>)
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a22b9d422dc9bbe448ae914be40f72d60">_sim_init_create</a>(init_type, init_id, sim_ag_id)
<a name="l01330"></a>01330         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01331"></a>01331 
<a name="l01332"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a9a2d87c65dd28c77d08e41ee37d20035">01332</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a9a2d87c65dd28c77d08e41ee37d20035">sim_ag_init_delete</a>(self, sim_ag_id, init_id):
<a name="l01333"></a>01333         sim_ag = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">sim_ag_of_id</a>(sim_ag_id)
<a name="l01334"></a>01334         <span class="keywordflow">if</span> init_id <span class="keywordflow">not</span> <span class="keywordflow">in</span> sim_ag[<span class="stringliteral">&apos;init_ids&apos;</span>]:
<a name="l01335"></a>01335             <span class="keywordflow">raise</span> LsmError(
<a name="l01336"></a>01336                 ErrorNumber.NO_STATE_CHANGE,
<a name="l01337"></a>01337                 <span class="stringliteral">&quot;Initiator is not in defined access group&quot;</span>)
<a name="l01338"></a>01338         <span class="keywordflow">if</span> len(sim_ag[<span class="stringliteral">&apos;init_ids&apos;</span>]) == 1:
<a name="l01339"></a>01339             <span class="keywordflow">raise</span> LsmError(
<a name="l01340"></a>01340                 ErrorNumber.LAST_INIT_IN_ACCESS_GROUP,
<a name="l01341"></a>01341                 <span class="stringliteral">&quot;Refused to remove the last initiator from access group&quot;</span>)
<a name="l01342"></a>01342 
<a name="l01343"></a>01343         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;inits&apos;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % init_id)
<a name="l01344"></a>01344 
<a name="l01345"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">01345</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a741bc4dc5793a4e3f6fc7ae0b0cc325a">sim_ag_of_id</a>(self, sim_ag_id):
<a name="l01346"></a>01346         sim_ag = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a26cd46120d8fed1b8c45e58e38bdb23d">_sim_data_of_id</a>(
<a name="l01347"></a>01347             <span class="stringliteral">&quot;ags_view&quot;</span>, sim_ag_id, BackStore.AG_KEY_LIST,
<a name="l01348"></a>01348             ErrorNumber.NOT_FOUND_ACCESS_GROUP,
<a name="l01349"></a>01349             <span class="stringliteral">&quot;Access Group&quot;</span>)
<a name="l01350"></a>01350         BackStore._sim_ag_format(sim_ag)
<a name="l01351"></a>01351         <span class="keywordflow">return</span> sim_ag
<a name="l01352"></a>01352 
<a name="l01353"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab11fd54aee8930ee9f216f3cb4b0ce8d">01353</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab11fd54aee8930ee9f216f3cb4b0ce8d">sim_fss</a>(self):
<a name="l01354"></a>01354         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01355"></a>01355 <span class="stringliteral">        Return a list of sim_fs dict.</span>
<a name="l01356"></a>01356 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01357"></a>01357         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;fss&apos;</span>, BackStore.FS_KEY_LIST)
<a name="l01358"></a>01358 
<a name="l01359"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">01359</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(self, sim_fs_id, raise_error=True):
<a name="l01360"></a>01360         lsm_error_no = ErrorNumber.NOT_FOUND_FS
<a name="l01361"></a>01361         <span class="keywordflow">if</span> <span class="keywordflow">not</span> raise_error:
<a name="l01362"></a>01362             lsm_error_no = <span class="keywordtype">None</span>
<a name="l01363"></a>01363 
<a name="l01364"></a>01364         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a26cd46120d8fed1b8c45e58e38bdb23d">_sim_data_of_id</a>(
<a name="l01365"></a>01365             <span class="stringliteral">&quot;fss&quot;</span>, sim_fs_id, BackStore.FS_KEY_LIST, lsm_error_no,
<a name="l01366"></a>01366             <span class="stringliteral">&quot;File System&quot;</span>)
<a name="l01367"></a>01367 
<a name="l01368"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a957474bf3183ca17a435efd304bafca8">01368</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a957474bf3183ca17a435efd304bafca8">sim_fs_create</a>(self, name, size_bytes, sim_pool_id):
<a name="l01369"></a>01369         size_bytes = BackStore._block_rounding(size_bytes)
<a name="l01370"></a>01370         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a475f84c8b5484ee85533c8f8de9f14bf">_check_pool_free_space</a>(sim_pool_id, size_bytes)
<a name="l01371"></a>01371         <span class="keywordflow">try</span>:
<a name="l01372"></a>01372             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01373"></a>01373                 <span class="stringliteral">&quot;fss&quot;</span>,
<a name="l01374"></a>01374                 {
<a name="l01375"></a>01375                     <span class="stringliteral">&apos;name&apos;</span>: name,
<a name="l01376"></a>01376                     <span class="stringliteral">&apos;total_space&apos;</span>: size_bytes,
<a name="l01377"></a>01377                     <span class="stringliteral">&apos;consumed_size&apos;</span>: size_bytes,
<a name="l01378"></a>01378                     <span class="stringliteral">&apos;free_space&apos;</span>: size_bytes,
<a name="l01379"></a>01379                     <span class="stringliteral">&apos;pool_id&apos;</span>: sim_pool_id,
<a name="l01380"></a>01380                 })
<a name="l01381"></a>01381         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l01382"></a>01382             <span class="keywordflow">raise</span> LsmError(
<a name="l01383"></a>01383                 ErrorNumber.NAME_CONFLICT,
<a name="l01384"></a>01384                 <span class="stringliteral">&quot;Name &apos;%s&apos; is already in use by other fs&quot;</span> % name)
<a name="l01385"></a>01385         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l01386"></a>01386 
<a name="l01387"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a222a754c13ff9d3223713b7dcf0781e5">01387</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a222a754c13ff9d3223713b7dcf0781e5">sim_fs_delete</a>(self, sim_fs_id):
<a name="l01388"></a>01388         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01389"></a>01389         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a93264721f7f3eeb5f9470faa00b1521a">clone_dst_sim_fs_ids_of_src</a>(sim_fs_id):
<a name="l01390"></a>01390             <span class="comment"># TODO(Gris Ge): API does not have dedicate error for this</span>
<a name="l01391"></a>01391             <span class="comment">#                scenario.</span>
<a name="l01392"></a>01392             <span class="keywordflow">raise</span> LsmError(
<a name="l01393"></a>01393                 ErrorNumber.PLUGIN_BUG,
<a name="l01394"></a>01394                 <span class="stringliteral">&quot;Requested file system is a clone source&quot;</span>)
<a name="l01395"></a>01395 
<a name="l01396"></a>01396         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab9ff1447d4c26d7074fd4469d14f187c">sim_fs_snaps</a>(sim_fs_id):
<a name="l01397"></a>01397             <span class="keywordflow">raise</span> LsmError(
<a name="l01398"></a>01398                 ErrorNumber.PLUGIN_BUG,
<a name="l01399"></a>01399                 <span class="stringliteral">&quot;Requested file system has snapshot attached&quot;</span>)
<a name="l01400"></a>01400 
<a name="l01401"></a>01401         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(<span class="stringliteral">&apos;exps&apos;</span>, <span class="stringliteral">&apos;fs_id=&quot;%s&quot;&apos;</span> % sim_fs_id, [<span class="stringliteral">&apos;id&apos;</span>]):
<a name="l01402"></a>01402             <span class="comment"># TODO(Gris Ge): API does not have dedicate error for this</span>
<a name="l01403"></a>01403             <span class="comment">#                scenario</span>
<a name="l01404"></a>01404             <span class="keywordflow">raise</span> LsmError(
<a name="l01405"></a>01405                 ErrorNumber.PLUGIN_BUG,
<a name="l01406"></a>01406                 <span class="stringliteral">&quot;Requested file system is exported via NFS&quot;</span>)
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&quot;fss&quot;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_fs_id)
<a name="l01409"></a>01409 
<a name="l01410"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aeb3b38aad39af1c64b9fc8bc262f6cc9">01410</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aeb3b38aad39af1c64b9fc8bc262f6cc9">sim_fs_resize</a>(self, sim_fs_id, new_size_bytes):
<a name="l01411"></a>01411         org_new_size_bytes = new_size_bytes
<a name="l01412"></a>01412         new_size_bytes = BackStore._block_rounding(new_size_bytes)
<a name="l01413"></a>01413         sim_fs = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01414"></a>01414 
<a name="l01415"></a>01415         <span class="keywordflow">if</span> sim_fs[<span class="stringliteral">&apos;total_space&apos;</span>] == new_size_bytes:
<a name="l01416"></a>01416             <span class="keywordflow">if</span> new_size_bytes != org_new_size_bytes:
<a name="l01417"></a>01417                 <span class="keywordflow">return</span>
<a name="l01418"></a>01418             <span class="keywordflow">else</span>:
<a name="l01419"></a>01419                 <span class="keywordflow">raise</span> LsmError(
<a name="l01420"></a>01420                     ErrorNumber.NO_STATE_CHANGE,
<a name="l01421"></a>01421                     <span class="stringliteral">&quot;File System size is identical to requested&quot;</span>)
<a name="l01422"></a>01422 
<a name="l01423"></a>01423         <span class="comment"># TODO(Gris Ge): If a fs is in a clone/snapshot relationship, resize</span>
<a name="l01424"></a>01424         <span class="comment">#                should be handled properly.</span>
<a name="l01425"></a>01425 
<a name="l01426"></a>01426         sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae1b560db8cc25d0b0b51b63cbf96687b">sim_pool_of_id</a>(sim_fs[<span class="stringliteral">&apos;pool_id&apos;</span>])
<a name="l01427"></a>01427 
<a name="l01428"></a>01428         <span class="keywordflow">if</span> new_size_bytes &gt; sim_fs[<span class="stringliteral">&apos;total_space&apos;</span>] <span class="keywordflow">and</span> \
<a name="l01429"></a>01429            sim_pool[<span class="stringliteral">&apos;free_space&apos;</span>] &lt; new_size_bytes - sim_fs[<span class="stringliteral">&apos;total_space&apos;</span>]:
<a name="l01430"></a>01430             <span class="keywordflow">raise</span> LsmError(
<a name="l01431"></a>01431                 ErrorNumber.NOT_ENOUGH_SPACE, <span class="stringliteral">&quot;Insufficient space in pool&quot;</span>)
<a name="l01432"></a>01432 
<a name="l01433"></a>01433         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l01434"></a>01434             <span class="stringliteral">&apos;fss&apos;</span>, sim_fs_id, <span class="stringliteral">&quot;total_space&quot;</span>, new_size_bytes)
<a name="l01435"></a>01435         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l01436"></a>01436             <span class="stringliteral">&apos;fss&apos;</span>, sim_fs_id, <span class="stringliteral">&quot;consumed_size&quot;</span>, new_size_bytes)
<a name="l01437"></a>01437         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a901fc7c285564f888ff9b84aaaf6ecd7">_data_update</a>(
<a name="l01438"></a>01438             <span class="stringliteral">&apos;fss&apos;</span>, sim_fs_id, <span class="stringliteral">&quot;free_space&quot;</span>, new_size_bytes)
<a name="l01439"></a>01439 
<a name="l01440"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab9ff1447d4c26d7074fd4469d14f187c">01440</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab9ff1447d4c26d7074fd4469d14f187c">sim_fs_snaps</a>(self, sim_fs_id):
<a name="l01441"></a>01441         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01442"></a>01442         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01443"></a>01443             <span class="stringliteral">&apos;fs_snaps&apos;</span>, <span class="stringliteral">&apos;fs_id=&quot;%s&quot;&apos;</span> % sim_fs_id, BackStore.FS_SNAP_KEY_LIST)
<a name="l01444"></a>01444 
<a name="l01445"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">01445</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">sim_fs_snap_of_id</a>(self, sim_fs_snap_id, sim_fs_id=None):
<a name="l01446"></a>01446         sim_fs_snap = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a26cd46120d8fed1b8c45e58e38bdb23d">_sim_data_of_id</a>(
<a name="l01447"></a>01447             <span class="stringliteral">&apos;fs_snaps&apos;</span>, sim_fs_snap_id, BackStore.FS_SNAP_KEY_LIST,
<a name="l01448"></a>01448             ErrorNumber.NOT_FOUND_FS_SS, <span class="stringliteral">&apos;File system snapshot&apos;</span>)
<a name="l01449"></a>01449         <span class="keywordflow">if</span> sim_fs_id <span class="keywordflow">and</span> sim_fs_snap[<span class="stringliteral">&apos;fs_id&apos;</span>] != sim_fs_id:
<a name="l01450"></a>01450             <span class="keywordflow">raise</span> LsmError(
<a name="l01451"></a>01451                 ErrorNumber.NOT_FOUND_FS_SS,
<a name="l01452"></a>01452                 <span class="stringliteral">&quot;Defined file system snapshot ID is not belong to requested &quot;</span>
<a name="l01453"></a>01453                 <span class="stringliteral">&quot;file system&quot;</span>)
<a name="l01454"></a>01454         <span class="keywordflow">return</span> sim_fs_snap
<a name="l01455"></a>01455 
<a name="l01456"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a9e9b1cab2d405e891c9795ade173e6c0">01456</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a9e9b1cab2d405e891c9795ade173e6c0">sim_fs_snap_create</a>(self, sim_fs_id, name):
<a name="l01457"></a>01457         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01458"></a>01458         <span class="keywordflow">try</span>:
<a name="l01459"></a>01459             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01460"></a>01460                 <span class="stringliteral">&apos;fs_snaps&apos;</span>,
<a name="l01461"></a>01461                 {
<a name="l01462"></a>01462                     <span class="stringliteral">&apos;name&apos;</span>: name,
<a name="l01463"></a>01463                     <span class="stringliteral">&apos;fs_id&apos;</span>: sim_fs_id,
<a name="l01464"></a>01464                     <span class="stringliteral">&apos;timestamp&apos;</span>: int(time.time()),
<a name="l01465"></a>01465                 })
<a name="l01466"></a>01466         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l01467"></a>01467             <span class="keywordflow">raise</span> LsmError(
<a name="l01468"></a>01468                 ErrorNumber.NAME_CONFLICT,
<a name="l01469"></a>01469                 <span class="stringliteral">&quot;The name is already used by other file system snapshot&quot;</span>)
<a name="l01470"></a>01470         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l01471"></a>01471 
<a name="l01472"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae032a830b7c734a51a51c58b398e4f61">01472</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae032a830b7c734a51a51c58b398e4f61">sim_fs_snap_restore</a>(self, sim_fs_id, sim_fs_snap_id, files,
<a name="l01473"></a>01473                             restore_files, flag_all_files):
<a name="l01474"></a>01474         <span class="comment"># Currently LSM cannot query stauts of this action.</span>
<a name="l01475"></a>01475         <span class="comment"># we simply check existence</span>
<a name="l01476"></a>01476         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01477"></a>01477         <span class="keywordflow">if</span> sim_fs_snap_id:
<a name="l01478"></a>01478             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">sim_fs_snap_of_id</a>(sim_fs_snap_id, sim_fs_id)
<a name="l01479"></a>01479         <span class="keywordflow">return</span>
<a name="l01480"></a>01480 
<a name="l01481"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ac643d39d6d2b8050596f1abe89125947">01481</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ac643d39d6d2b8050596f1abe89125947">sim_fs_snap_delete</a>(self, sim_fs_snap_id, sim_fs_id):
<a name="l01482"></a>01482         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01483"></a>01483         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">sim_fs_snap_of_id</a>(sim_fs_snap_id, sim_fs_id)
<a name="l01484"></a>01484         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;fs_snaps&apos;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_fs_snap_id)
<a name="l01485"></a>01485 
<a name="l01486"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aca784cd219b0a796cd7d43b8f080284a">01486</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#aca784cd219b0a796cd7d43b8f080284a">sim_fs_snap_del_by_fs</a>(self, sim_fs_id):
<a name="l01487"></a>01487         sql_cmd = <span class="stringliteral">&quot;DELETE FROM fs_snaps WHERE fs_id=&apos;%s&apos;;&quot;</span> % sim_fs_id
<a name="l01488"></a>01488         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a3bc82a0e2f1b5687071d160787278b4a">_sql_exec</a>(sql_cmd)
<a name="l01489"></a>01489 
<a name="l01490"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#afbbc2eefa12683b25a0e6e01a4136336">01490</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#afbbc2eefa12683b25a0e6e01a4136336">sim_fs_clone</a>(self, src_sim_fs_id, dst_sim_fs_id, sim_fs_snap_id):
<a name="l01491"></a>01491         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(src_sim_fs_id)
<a name="l01492"></a>01492         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(dst_sim_fs_id)
<a name="l01493"></a>01493 
<a name="l01494"></a>01494         <span class="keywordflow">if</span> sim_fs_snap_id:
<a name="l01495"></a>01495             <span class="comment"># No need to trace state of snap id here due to lack of</span>
<a name="l01496"></a>01496             <span class="comment"># query method.</span>
<a name="l01497"></a>01497             <span class="comment"># We just check snapshot existence</span>
<a name="l01498"></a>01498             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">sim_fs_snap_of_id</a>(sim_fs_snap_id, src_sim_fs_id)
<a name="l01499"></a>01499 
<a name="l01500"></a>01500         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01501"></a>01501             <span class="stringliteral">&apos;fs_clones&apos;</span>,
<a name="l01502"></a>01502             {
<a name="l01503"></a>01503                 <span class="stringliteral">&apos;src_fs_id&apos;</span>: src_sim_fs_id,
<a name="l01504"></a>01504                 <span class="stringliteral">&apos;dst_fs_id&apos;</span>: dst_sim_fs_id,
<a name="l01505"></a>01505             })
<a name="l01506"></a>01506 
<a name="l01507"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ad311bc7ee0f18908ae732a6216c9a132">01507</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ad311bc7ee0f18908ae732a6216c9a132">sim_fs_file_clone</a>(self, sim_fs_id, src_fs_name, dst_fs_name,
<a name="l01508"></a>01508                           sim_fs_snap_id):
<a name="l01509"></a>01509         <span class="comment"># We don&apos;t have API to query file level clone.</span>
<a name="l01510"></a>01510         <span class="comment"># Simply check existence</span>
<a name="l01511"></a>01511         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01512"></a>01512         <span class="keywordflow">if</span> sim_fs_snap_id:
<a name="l01513"></a>01513             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a46f992ee61e1df4fcf9d26cced29498f">sim_fs_snap_of_id</a>(sim_fs_snap_id, sim_fs_id)
<a name="l01514"></a>01514         <span class="keywordflow">return</span>
<a name="l01515"></a>01515 
<a name="l01516"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a93264721f7f3eeb5f9470faa00b1521a">01516</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a93264721f7f3eeb5f9470faa00b1521a">clone_dst_sim_fs_ids_of_src</a>(self, src_sim_fs_id):
<a name="l01517"></a>01517         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01518"></a>01518 <span class="stringliteral">        Return a list of dst_fs_id for provided clone source fs ID.</span>
<a name="l01519"></a>01519 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01520"></a>01520         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(src_sim_fs_id)
<a name="l01521"></a>01521         <span class="keywordflow">return</span> list(
<a name="l01522"></a>01522             d[<span class="stringliteral">&apos;dst_fs_id&apos;</span>] <span class="keywordflow">for</span> d <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab608426f599e8493296973cf3bfe8891">_data_find</a>(
<a name="l01523"></a>01523                 <span class="stringliteral">&apos;fs_clones&apos;</span>, <span class="stringliteral">&apos;src_fs_id=&quot;%s&quot;&apos;</span> % src_sim_fs_id,
<a name="l01524"></a>01524                 [<span class="stringliteral">&apos;dst_fs_id&apos;</span>]))
<a name="l01525"></a>01525 
<a name="l01526"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a0e8132dfd72b1c8511aa4c2cdafa6ca2">01526</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a0e8132dfd72b1c8511aa4c2cdafa6ca2">sim_fs_src_clone_break</a>(self, src_sim_fs_id):
<a name="l01527"></a>01527         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;fs_clones&apos;</span>, <span class="stringliteral">&apos;src_fs_id=&quot;%s&quot;&apos;</span> % src_sim_fs_id)
<a name="l01528"></a>01528 
<a name="l01529"></a>01529     <span class="keyword">def </span>_sim_exp_format(self, sim_exp):
<a name="l01530"></a>01530         <span class="keywordflow">for</span> key_name <span class="keywordflow">in</span> [<span class="stringliteral">&apos;root_hosts&apos;</span>, <span class="stringliteral">&apos;rw_hosts&apos;</span>, <span class="stringliteral">&apos;ro_hosts&apos;</span>]:
<a name="l01531"></a>01531             table_name = <span class="stringliteral">&quot;exp_%s_str&quot;</span> % key_name
<a name="l01532"></a>01532             <span class="keywordflow">if</span> sim_exp[table_name]:
<a name="l01533"></a>01533                 sim_exp[key_name] = sim_exp[table_name].split(
<a name="l01534"></a>01534                     BackStore._LIST_SPLITTER)
<a name="l01535"></a>01535             <span class="keywordflow">else</span>:
<a name="l01536"></a>01536                 sim_exp[key_name] = []
<a name="l01537"></a>01537             del sim_exp[table_name]
<a name="l01538"></a>01538         <span class="keywordflow">return</span> sim_exp
<a name="l01539"></a>01539 
<a name="l01540"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#acedc7266e0ed0cc7e022ffa7cd825e85">01540</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#acedc7266e0ed0cc7e022ffa7cd825e85">sim_exps</a>(self):
<a name="l01541"></a>01541         <span class="keywordflow">return</span> list(
<a name="l01542"></a>01542             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ac1af56ac776dc268cc20bcda7ce934cd">_sim_exp_format</a>(e)
<a name="l01543"></a>01543             <span class="keywordflow">for</span> e <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;exps_view&apos;</span>, BackStore.EXP_KEY_LIST))
<a name="l01544"></a>01544 
<a name="l01545"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a8db2c521eee46475a2ab304982c5d8b0">01545</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a8db2c521eee46475a2ab304982c5d8b0">sim_exp_of_id</a>(self, sim_exp_id):
<a name="l01546"></a>01546         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ac1af56ac776dc268cc20bcda7ce934cd">_sim_exp_format</a>(
<a name="l01547"></a>01547             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a26cd46120d8fed1b8c45e58e38bdb23d">_sim_data_of_id</a>(
<a name="l01548"></a>01548                 <span class="stringliteral">&apos;exps_view&apos;</span>, sim_exp_id, BackStore.EXP_KEY_LIST,
<a name="l01549"></a>01549                 ErrorNumber.NOT_FOUND_NFS_EXPORT, <span class="stringliteral">&apos;NFS Export&apos;</span>))
<a name="l01550"></a>01550 
<a name="l01551"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a6a80b1fc9c42d8ece7f8bd1bf92acf1c">01551</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a6a80b1fc9c42d8ece7f8bd1bf92acf1c">sim_exp_create</a>(self, sim_fs_id, exp_path, root_hosts, rw_hosts,
<a name="l01552"></a>01552                        ro_hosts, anon_uid, anon_gid, auth_type, options):
<a name="l01553"></a>01553         <span class="keywordflow">if</span> exp_path <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l01554"></a>01554             exp_path = <span class="stringliteral">&quot;/nfs_exp_%s&quot;</span> % _random_vpd()[:8]
<a name="l01555"></a>01555         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a574c1428aa19004341e5aa80cfe3ee75">sim_fs_of_id</a>(sim_fs_id)
<a name="l01556"></a>01556 
<a name="l01557"></a>01557         <span class="keywordflow">try</span>:
<a name="l01558"></a>01558             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01559"></a>01559                 <span class="stringliteral">&apos;exps&apos;</span>,
<a name="l01560"></a>01560                 {
<a name="l01561"></a>01561                     <span class="stringliteral">&apos;fs_id&apos;</span>: sim_fs_id,
<a name="l01562"></a>01562                     <span class="stringliteral">&apos;exp_path&apos;</span>: exp_path,
<a name="l01563"></a>01563                     <span class="stringliteral">&apos;anon_uid&apos;</span>: anon_uid,
<a name="l01564"></a>01564                     <span class="stringliteral">&apos;anon_gid&apos;</span>: anon_gid,
<a name="l01565"></a>01565                     <span class="stringliteral">&apos;auth_type&apos;</span>: auth_type,
<a name="l01566"></a>01566                     <span class="stringliteral">&apos;options&apos;</span>: options,
<a name="l01567"></a>01567                 })
<a name="l01568"></a>01568         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l01569"></a>01569             <span class="comment"># TODO(Gris Ge): Should we create new error instead of</span>
<a name="l01570"></a>01570             <span class="comment">#                NAME_CONFLICT?</span>
<a name="l01571"></a>01571             <span class="keywordflow">raise</span> LsmError(
<a name="l01572"></a>01572                 ErrorNumber.NAME_CONFLICT,
<a name="l01573"></a>01573                 <span class="stringliteral">&quot;Export path is already used by other NFS export&quot;</span>)
<a name="l01574"></a>01574 
<a name="l01575"></a>01575         sim_exp_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a307bef61851b6b5a8d2c1d3a3ec040b3">lastrowid</a>
<a name="l01576"></a>01576 
<a name="l01577"></a>01577         <span class="keywordflow">for</span> root_host <span class="keywordflow">in</span> root_hosts:
<a name="l01578"></a>01578             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01579"></a>01579                 <span class="stringliteral">&apos;exp_root_hosts&apos;</span>,
<a name="l01580"></a>01580                 {
<a name="l01581"></a>01581                     <span class="stringliteral">&apos;host&apos;</span>: root_host,
<a name="l01582"></a>01582                     <span class="stringliteral">&apos;exp_id&apos;</span>: sim_exp_id,
<a name="l01583"></a>01583                 })
<a name="l01584"></a>01584         <span class="keywordflow">for</span> rw_host <span class="keywordflow">in</span> rw_hosts:
<a name="l01585"></a>01585             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01586"></a>01586                 <span class="stringliteral">&apos;exp_rw_hosts&apos;</span>,
<a name="l01587"></a>01587                 {
<a name="l01588"></a>01588                     <span class="stringliteral">&apos;host&apos;</span>: rw_host,
<a name="l01589"></a>01589                     <span class="stringliteral">&apos;exp_id&apos;</span>: sim_exp_id,
<a name="l01590"></a>01590                 })
<a name="l01591"></a>01591         <span class="keywordflow">for</span> ro_host <span class="keywordflow">in</span> ro_hosts:
<a name="l01592"></a>01592             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a10d014c0f43122944d8a2fcdfd007c54">_data_add</a>(
<a name="l01593"></a>01593                 <span class="stringliteral">&apos;exp_ro_hosts&apos;</span>,
<a name="l01594"></a>01594                 {
<a name="l01595"></a>01595                     <span class="stringliteral">&apos;host&apos;</span>: ro_host,
<a name="l01596"></a>01596                     <span class="stringliteral">&apos;exp_id&apos;</span>: sim_exp_id,
<a name="l01597"></a>01597                 })
<a name="l01598"></a>01598 
<a name="l01599"></a>01599         <span class="keywordflow">return</span> sim_exp_id
<a name="l01600"></a>01600 
<a name="l01601"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a7089622e15463f3789f7eec840146513">01601</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a7089622e15463f3789f7eec840146513">sim_exp_delete</a>(self, sim_exp_id):
<a name="l01602"></a>01602         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a8db2c521eee46475a2ab304982c5d8b0">sim_exp_of_id</a>(sim_exp_id)
<a name="l01603"></a>01603         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ae47dd1f0c3d4a83bd5c74a4f6d1be286">_data_delete</a>(<span class="stringliteral">&apos;exps&apos;</span>, <span class="stringliteral">&apos;id=&quot;%s&quot;&apos;</span> % sim_exp_id)
<a name="l01604"></a>01604 
<a name="l01605"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a344983b798c27d0af148fb25b11a4a4c">01605</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#a344983b798c27d0af148fb25b11a4a4c">sim_tgts</a>(self):
<a name="l01606"></a>01606         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01607"></a>01607 <span class="stringliteral">        Return a list of sim_tgt dict.</span>
<a name="l01608"></a>01608 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01609"></a>01609         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_back_store.html#ab2aed3dcf4763417fd78646af21d57f7">_get_table</a>(<span class="stringliteral">&apos;tgts&apos;</span>, BackStore.TGT_KEY_LIST)
<a name="l01610"></a>01610 
<a name="l01611"></a>01611 
<a name="l01612"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html">01612</a> <span class="keyword">class </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html">SimArray</a>(object):
<a name="l01613"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af45b94da8436b16dd03662acb2fd8516">01613</a>     SIM_DATA_FILE = os.getenv(<span class="stringliteral">&quot;LSM_SIM_DATA&quot;</span>,
<a name="l01614"></a>01614                               tempfile.gettempdir() + <span class="stringliteral">&apos;/lsm_sim_data&apos;</span>)
<a name="l01615"></a>01615 
<a name="l01616"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a43141cdc7bde12d6411b19663a0e1b3e">01616</a>     ID_FMT = 5
<a name="l01617"></a>01617 
<a name="l01618"></a>01618     @staticmethod
<a name="l01619"></a>01619     <span class="keyword">def </span>_sim_id_to_lsm_id(sim_id, prefix):
<a name="l01620"></a>01620         <span class="keywordflow">return</span> <span class="stringliteral">&quot;%s_ID_%0*d&quot;</span> % (prefix, SimArray.ID_FMT, sim_id)
<a name="l01621"></a>01621 
<a name="l01622"></a>01622     @staticmethod
<a name="l01623"></a>01623     <span class="keyword">def </span>_lsm_id_to_sim_id(lsm_id, lsm_error):
<a name="l01624"></a>01624         <span class="keywordflow">try</span>:
<a name="l01625"></a>01625             <span class="keywordflow">return</span> int(lsm_id[-SimArray.ID_FMT:])
<a name="l01626"></a>01626         <span class="keywordflow">except</span> ValueError:
<a name="l01627"></a>01627             <span class="keywordflow">raise</span> lsm_error
<a name="l01628"></a>01628 
<a name="l01629"></a>01629     @staticmethod
<a name="l01630"></a>01630     <span class="keyword">def </span>_sim_job_id_of(job_id):
<a name="l01631"></a>01631         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01632"></a>01632             job_id, LsmError(ErrorNumber.NOT_FOUND_JOB, <span class="stringliteral">&quot;Job not found&quot;</span>))
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     @staticmethod
<a name="l01635"></a>01635     <span class="keyword">def </span>_sim_pool_id_of(pool_id):
<a name="l01636"></a>01636         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01637"></a>01637             pool_id, LsmError(ErrorNumber.NOT_FOUND_POOL, <span class="stringliteral">&quot;Pool not found&quot;</span>))
<a name="l01638"></a>01638 
<a name="l01639"></a>01639     @staticmethod
<a name="l01640"></a>01640     <span class="keyword">def </span>_sim_vol_id_of(vol_id):
<a name="l01641"></a>01641         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01642"></a>01642             vol_id, LsmError(
<a name="l01643"></a>01643                 ErrorNumber.NOT_FOUND_VOLUME, <span class="stringliteral">&quot;Volume not found&quot;</span>))
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     @staticmethod
<a name="l01646"></a>01646     <span class="keyword">def </span>_sim_fs_id_of(fs_id):
<a name="l01647"></a>01647         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01648"></a>01648             fs_id, LsmError(
<a name="l01649"></a>01649                 ErrorNumber.NOT_FOUND_FS, <span class="stringliteral">&quot;File system not found&quot;</span>))
<a name="l01650"></a>01650 
<a name="l01651"></a>01651     @staticmethod
<a name="l01652"></a>01652     <span class="keyword">def </span>_sim_fs_snap_id_of(snap_id):
<a name="l01653"></a>01653         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01654"></a>01654             snap_id, LsmError(
<a name="l01655"></a>01655                 ErrorNumber.NOT_FOUND_FS_SS,
<a name="l01656"></a>01656                 <span class="stringliteral">&quot;File system snapshot not found&quot;</span>))
<a name="l01657"></a>01657 
<a name="l01658"></a>01658     @staticmethod
<a name="l01659"></a>01659     <span class="keyword">def </span>_sim_exp_id_of(exp_id):
<a name="l01660"></a>01660         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01661"></a>01661             exp_id, LsmError(
<a name="l01662"></a>01662                 ErrorNumber.NOT_FOUND_NFS_EXPORT,
<a name="l01663"></a>01663                 <span class="stringliteral">&quot;File system export not found&quot;</span>))
<a name="l01664"></a>01664 
<a name="l01665"></a>01665     @staticmethod
<a name="l01666"></a>01666     <span class="keyword">def </span>_sim_ag_id_of(ag_id):
<a name="l01667"></a>01667         <span class="keywordflow">return</span> SimArray._lsm_id_to_sim_id(
<a name="l01668"></a>01668             ag_id, LsmError(
<a name="l01669"></a>01669                 ErrorNumber.NOT_FOUND_NFS_EXPORT,
<a name="l01670"></a>01670                 <span class="stringliteral">&quot;File system export not found&quot;</span>))
<a name="l01671"></a>01671 
<a name="l01672"></a>01672     @_handle_errors
<a name="l01673"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ac775ee34451fdfa742b318538164070e">01673</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ac775ee34451fdfa742b318538164070e">__init__</a>(self, statefile, timeout):
<a name="l01674"></a>01674         <span class="keywordflow">if</span> statefile <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l01675"></a>01675             statefile = SimArray.SIM_DATA_FILE
<a name="l01676"></a>01676 
<a name="l01677"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">01677</a>         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a> = BackStore(statefile, timeout)
<a name="l01678"></a>01678         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.check_version_and_init()
<a name="l01679"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">01679</a>         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">statefile</a> = statefile
<a name="l01680"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aee145bfca8e9b2eaf3cd3c47157be9a3">01680</a>         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aee145bfca8e9b2eaf3cd3c47157be9a3">timeout</a> = timeout
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     <span class="keyword">def </span>_job_create(self, data_type=None, sim_data_id=None):
<a name="l01683"></a>01683         sim_job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_job_create(
<a name="l01684"></a>01684             data_type, sim_data_id)
<a name="l01685"></a>01685         <span class="keywordflow">return</span> SimArray._sim_id_to_lsm_id(sim_job_id, <span class="stringliteral">&apos;JOB&apos;</span>)
<a name="l01686"></a>01686 
<a name="l01687"></a>01687     @_handle_errors
<a name="l01688"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a929de62122ccee78ed9f38cb27d894bd">01688</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a929de62122ccee78ed9f38cb27d894bd">job_status</a>(self, job_id, flags=0):
<a name="l01689"></a>01689         sim_job_id = SimArray._sim_job_id_of(job_id)
<a name="l01690"></a>01690 
<a name="l01691"></a>01691         (progress, data_type, sim_data) = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_job_status(
<a name="l01692"></a>01692             sim_job_id)
<a name="l01693"></a>01693         status = JobStatus.INPROGRESS
<a name="l01694"></a>01694         <span class="keywordflow">if</span> progress == 100:
<a name="l01695"></a>01695             status = JobStatus.COMPLETE
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         data = <span class="keywordtype">None</span>
<a name="l01698"></a>01698         <span class="keywordflow">if</span> data_type == BackStore.JOB_DATA_TYPE_VOL:
<a name="l01699"></a>01699             data = SimArray._sim_vol_2_lsm(sim_data)
<a name="l01700"></a>01700         <span class="keywordflow">elif</span> data_type == BackStore.JOB_DATA_TYPE_FS:
<a name="l01701"></a>01701             data = SimArray._sim_fs_2_lsm(sim_data)
<a name="l01702"></a>01702         <span class="keywordflow">elif</span> data_type == BackStore.JOB_DATA_TYPE_FS_SNAP:
<a name="l01703"></a>01703             data = SimArray._sim_fs_snap_2_lsm(sim_data)
<a name="l01704"></a>01704 
<a name="l01705"></a>01705         <span class="keywordflow">return</span> (status, progress, data)
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     @_handle_errors
<a name="l01708"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ab524e0814347bfaae02088afc9cb45de">01708</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ab524e0814347bfaae02088afc9cb45de">job_free</a>(self, job_id, flags=0):
<a name="l01709"></a>01709         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01710"></a>01710         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_job_delete(SimArray._sim_job_id_of(job_id))
<a name="l01711"></a>01711         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01712"></a>01712         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01713"></a>01713 
<a name="l01714"></a>01714     @_handle_errors
<a name="l01715"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aefd1ea4c24b87882967a65225461f518">01715</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aefd1ea4c24b87882967a65225461f518">time_out_set</a>(self, ms, flags=0):
<a name="l01716"></a>01716         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a> = BackStore(self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a61baa1077cedcdcfbc2fa9529e5dc8f8">statefile</a>, int(ms/1000))
<a name="l01717"></a>01717         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aee145bfca8e9b2eaf3cd3c47157be9a3">timeout</a> = ms
<a name="l01718"></a>01718         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01719"></a>01719 
<a name="l01720"></a>01720     @_handle_errors
<a name="l01721"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aca86a2f78fedd0654bfb8ed9627145a4">01721</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aca86a2f78fedd0654bfb8ed9627145a4">time_out_get</a>(self, flags=0):
<a name="l01722"></a>01722         <span class="keywordflow">return</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aee145bfca8e9b2eaf3cd3c47157be9a3">timeout</a>
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     @staticmethod
<a name="l01725"></a>01725     <span class="keyword">def </span>_sim_sys_2_lsm(sim_sys):
<a name="l01726"></a>01726         <span class="keywordflow">return</span> System(
<a name="l01727"></a>01727             sim_sys[<span class="stringliteral">&apos;id&apos;</span>], sim_sys[<span class="stringliteral">&apos;name&apos;</span>], sim_sys[<span class="stringliteral">&apos;status&apos;</span>],
<a name="l01728"></a>01728             sim_sys[<span class="stringliteral">&apos;status_info&apos;</span>])
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     @_handle_errors
<a name="l01731"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a4871ed866b85a66f68d5d8bbf9bf1397">01731</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a4871ed866b85a66f68d5d8bbf9bf1397">systems</a>(self):
<a name="l01732"></a>01732         <span class="keywordflow">return</span> list(
<a name="l01733"></a>01733             SimArray._sim_sys_2_lsm(sim_sys)
<a name="l01734"></a>01734             <span class="keywordflow">for</span> sim_sys <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_syss())
<a name="l01735"></a>01735 
<a name="l01736"></a>01736     @staticmethod
<a name="l01737"></a>01737     <span class="keyword">def </span>_sim_vol_2_lsm(sim_vol):
<a name="l01738"></a>01738         vol_id = SimArray._sim_id_to_lsm_id(sim_vol[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;VOL&apos;</span>)
<a name="l01739"></a>01739         pool_id = SimArray._sim_id_to_lsm_id(sim_vol[<span class="stringliteral">&apos;pool_id&apos;</span>], <span class="stringliteral">&apos;POOL&apos;</span>)
<a name="l01740"></a>01740         <span class="keywordflow">return</span> Volume(vol_id, sim_vol[<span class="stringliteral">&apos;name&apos;</span>], sim_vol[<span class="stringliteral">&apos;vpd83&apos;</span>],
<a name="l01741"></a>01741                       BackStore.BLK_SIZE,
<a name="l01742"></a>01742                       int(sim_vol[<span class="stringliteral">&apos;total_space&apos;</span>] / BackStore.BLK_SIZE),
<a name="l01743"></a>01743                       sim_vol[<span class="stringliteral">&apos;admin_state&apos;</span>], BackStore.SYS_ID,
<a name="l01744"></a>01744                       pool_id)
<a name="l01745"></a>01745 
<a name="l01746"></a>01746     @_handle_errors
<a name="l01747"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a4b0cedfa2577c2d650f97a8827b10733">01747</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a4b0cedfa2577c2d650f97a8827b10733">volumes</a>(self):
<a name="l01748"></a>01748         <span class="keywordflow">return</span> list(
<a name="l01749"></a>01749             SimArray._sim_vol_2_lsm(v) <span class="keywordflow">for</span> v <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vols())
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     @staticmethod
<a name="l01752"></a>01752     <span class="keyword">def </span>_sim_pool_2_lsm(sim_pool):
<a name="l01753"></a>01753         pool_id = SimArray._sim_id_to_lsm_id(sim_pool[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;POOL&apos;</span>)
<a name="l01754"></a>01754         name = sim_pool[<span class="stringliteral">&apos;name&apos;</span>]
<a name="l01755"></a>01755         total_space = sim_pool[<span class="stringliteral">&apos;total_space&apos;</span>]
<a name="l01756"></a>01756         free_space = sim_pool[<span class="stringliteral">&apos;free_space&apos;</span>]
<a name="l01757"></a>01757         status = sim_pool[<span class="stringliteral">&apos;status&apos;</span>]
<a name="l01758"></a>01758         status_info = sim_pool[<span class="stringliteral">&apos;status_info&apos;</span>]
<a name="l01759"></a>01759         sys_id = BackStore.SYS_ID
<a name="l01760"></a>01760         element_type = sim_pool[<span class="stringliteral">&apos;element_type&apos;</span>]
<a name="l01761"></a>01761         unsupported_actions = sim_pool[<span class="stringliteral">&apos;unsupported_actions&apos;</span>]
<a name="l01762"></a>01762         <span class="keywordflow">return</span> Pool(
<a name="l01763"></a>01763             pool_id, name, element_type, unsupported_actions, total_space,
<a name="l01764"></a>01764             free_space, status, status_info, sys_id)
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     @_handle_errors
<a name="l01767"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a2db5ded4a3129c2d49b739f6bbcb4cbf">01767</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a2db5ded4a3129c2d49b739f6bbcb4cbf">pools</a>(self, flags=0):
<a name="l01768"></a>01768         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01769"></a>01769         sim_pools = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pools()
<a name="l01770"></a>01770         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_rollback()
<a name="l01771"></a>01771         <span class="keywordflow">return</span> list(
<a name="l01772"></a>01772             SimArray._sim_pool_2_lsm(sim_pool) <span class="keywordflow">for</span> sim_pool <span class="keywordflow">in</span> sim_pools)
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     @staticmethod
<a name="l01775"></a>01775     <span class="keyword">def </span>_sim_disk_2_lsm(sim_disk):
<a name="l01776"></a>01776         disk_status = Disk.STATUS_OK
<a name="l01777"></a>01777         <span class="keywordflow">if</span> sim_disk[<span class="stringliteral">&apos;role&apos;</span>] <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l01778"></a>01778             disk_status |= Disk.STATUS_FREE
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="keywordflow">return</span> Disk(
<a name="l01781"></a>01781             SimArray._sim_id_to_lsm_id(sim_disk[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;DISK&apos;</span>),
<a name="l01782"></a>01782             sim_disk[<span class="stringliteral">&apos;name&apos;</span>],
<a name="l01783"></a>01783             sim_disk[<span class="stringliteral">&apos;disk_type&apos;</span>], BackStore.BLK_SIZE,
<a name="l01784"></a>01784             int(sim_disk[<span class="stringliteral">&apos;total_space&apos;</span>] / BackStore.BLK_SIZE),
<a name="l01785"></a>01785             disk_status, BackStore.SYS_ID)
<a name="l01786"></a>01786 
<a name="l01787"></a>01787     @_handle_errors
<a name="l01788"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aa3388294e18ca07771eaa36dee3fd5d7">01788</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aa3388294e18ca07771eaa36dee3fd5d7">disks</a>(self):
<a name="l01789"></a>01789         <span class="keywordflow">return</span> list(
<a name="l01790"></a>01790             SimArray._sim_disk_2_lsm(sim_disk)
<a name="l01791"></a>01791             <span class="keywordflow">for</span> sim_disk <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_disks())
<a name="l01792"></a>01792 
<a name="l01793"></a>01793     @_handle_errors
<a name="l01794"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a720c825bce313b878e3d1839bbee6984">01794</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a720c825bce313b878e3d1839bbee6984">volume_create</a>(self, pool_id, vol_name, size_bytes, thinp, flags=0,
<a name="l01795"></a>01795                       _internal_use=<span class="keyword">False</span>, _is_hw_raid_vol=0):
<a name="l01796"></a>01796         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l01797"></a>01797 <span class="stringliteral">        The &apos;_internal_use&apos; parameter is only for SimArray internal use.</span>
<a name="l01798"></a>01798 <span class="stringliteral">        This method will return the new sim_vol id instead of job_id when</span>
<a name="l01799"></a>01799 <span class="stringliteral">        &apos;_internal_use&apos; marked as True.</span>
<a name="l01800"></a>01800 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01801"></a>01801         <span class="keywordflow">if</span> _internal_use <span class="keywordflow">is</span> <span class="keyword">False</span>:
<a name="l01802"></a>01802             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01803"></a>01803 
<a name="l01804"></a>01804         new_sim_vol_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_create(
<a name="l01805"></a>01805             vol_name, size_bytes, SimArray._sim_pool_id_of(pool_id),
<a name="l01806"></a>01806             thinp, is_hw_raid_vol=_is_hw_raid_vol)
<a name="l01807"></a>01807 
<a name="l01808"></a>01808         <span class="keywordflow">if</span> _internal_use:
<a name="l01809"></a>01809             <span class="keywordflow">return</span> new_sim_vol_id
<a name="l01810"></a>01810 
<a name="l01811"></a>01811         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(
<a name="l01812"></a>01812             BackStore.JOB_DATA_TYPE_VOL, new_sim_vol_id)
<a name="l01813"></a>01813         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l01816"></a>01816 
<a name="l01817"></a>01817     @_handle_errors
<a name="l01818"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ae3cdf39f9436c7f2bd0dfc6d372d17fb">01818</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ae3cdf39f9436c7f2bd0dfc6d372d17fb">volume_delete</a>(self, vol_id, flags=0):
<a name="l01819"></a>01819         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01820"></a>01820         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_delete(SimArray._sim_vol_id_of(vol_id))
<a name="l01821"></a>01821         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l01822"></a>01822         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01823"></a>01823         <span class="keywordflow">return</span> job_id
<a name="l01824"></a>01824 
<a name="l01825"></a>01825     @_handle_errors
<a name="l01826"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aaafb0e081a5a7bd012d35f53b14e1e1a">01826</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aaafb0e081a5a7bd012d35f53b14e1e1a">volume_resize</a>(self, vol_id, new_size_bytes, flags=0):
<a name="l01827"></a>01827         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01828"></a>01828 
<a name="l01829"></a>01829         sim_vol_id = SimArray._sim_vol_id_of(vol_id)
<a name="l01830"></a>01830         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_resize(sim_vol_id, new_size_bytes)
<a name="l01831"></a>01831         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(
<a name="l01832"></a>01832             BackStore.JOB_DATA_TYPE_VOL, sim_vol_id)
<a name="l01833"></a>01833         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01834"></a>01834 
<a name="l01835"></a>01835         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l01836"></a>01836 
<a name="l01837"></a>01837     @_handle_errors
<a name="l01838"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a54ffcd18c3d421dd510c033f1bcfe917">01838</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a54ffcd18c3d421dd510c033f1bcfe917">volume_replicate</a>(self, dst_pool_id, rep_type, src_vol_id, new_vol_name,
<a name="l01839"></a>01839                          flags=0):
<a name="l01840"></a>01840         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01841"></a>01841 
<a name="l01842"></a>01842         src_sim_vol_id = SimArray._sim_pool_id_of(src_vol_id)
<a name="l01843"></a>01843         <span class="comment"># Verify the existence of source volume</span>
<a name="l01844"></a>01844         src_sim_vol = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_of_id(src_sim_vol_id)
<a name="l01845"></a>01845 
<a name="l01846"></a>01846         dst_sim_vol_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a720c825bce313b878e3d1839bbee6984">volume_create</a>(
<a name="l01847"></a>01847             dst_pool_id, new_vol_name, src_sim_vol[<span class="stringliteral">&apos;total_space&apos;</span>],
<a name="l01848"></a>01848             src_sim_vol[<span class="stringliteral">&apos;thinp&apos;</span>], _internal_use=<span class="keyword">True</span>)
<a name="l01849"></a>01849 
<a name="l01850"></a>01850         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_replica(src_sim_vol_id, dst_sim_vol_id, rep_type)
<a name="l01851"></a>01851 
<a name="l01852"></a>01852         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(
<a name="l01853"></a>01853             BackStore.JOB_DATA_TYPE_VOL, dst_sim_vol_id)
<a name="l01854"></a>01854         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l01857"></a>01857 
<a name="l01858"></a>01858     @_handle_errors
<a name="l01859"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a91e16c71d64f6ff5cef2dc6d300c8550">01859</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a91e16c71d64f6ff5cef2dc6d300c8550">volume_replicate_range_block_size</a>(self, sys_id, flags=0):
<a name="l01860"></a>01860         <span class="keywordflow">if</span> sys_id != BackStore.SYS_ID:
<a name="l01861"></a>01861             <span class="keywordflow">raise</span> LsmError(
<a name="l01862"></a>01862                 ErrorNumber.NOT_FOUND_SYSTEM,
<a name="l01863"></a>01863                 <span class="stringliteral">&quot;System not found&quot;</span>)
<a name="l01864"></a>01864         <span class="keywordflow">return</span> BackStore.BLK_SIZE
<a name="l01865"></a>01865 
<a name="l01866"></a>01866     @_handle_errors
<a name="l01867"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad3b1c179c79ff051c98baddf734513a0">01867</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad3b1c179c79ff051c98baddf734513a0">volume_replicate_range</a>(self, rep_type, src_vol_id, dst_vol_id, ranges,
<a name="l01868"></a>01868                                flags=0):
<a name="l01869"></a>01869         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01870"></a>01870 
<a name="l01871"></a>01871         <span class="comment"># TODO(Gris Ge): check whether star_blk + count is out of volume</span>
<a name="l01872"></a>01872         <span class="comment">#                boundary</span>
<a name="l01873"></a>01873         <span class="comment"># TODO(Gris Ge): Should check block overlap.</span>
<a name="l01874"></a>01874 
<a name="l01875"></a>01875         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_replica(
<a name="l01876"></a>01876             SimArray._sim_pool_id_of(src_vol_id),
<a name="l01877"></a>01877             SimArray._sim_pool_id_of(dst_vol_id), rep_type, ranges)
<a name="l01878"></a>01878 
<a name="l01879"></a>01879         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l01880"></a>01880 
<a name="l01881"></a>01881         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01882"></a>01882         <span class="keywordflow">return</span> job_id
<a name="l01883"></a>01883 
<a name="l01884"></a>01884     @_handle_errors
<a name="l01885"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7dd5e96204c6df692dc9de8e6c2628d4">01885</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7dd5e96204c6df692dc9de8e6c2628d4">volume_enable</a>(self, vol_id, flags=0):
<a name="l01886"></a>01886         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01887"></a>01887         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_state_change(
<a name="l01888"></a>01888             SimArray._sim_vol_id_of(vol_id), Volume.ADMIN_STATE_ENABLED)
<a name="l01889"></a>01889         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01890"></a>01890         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     @_handle_errors
<a name="l01893"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a4800245aeca1e7f88a0725df176d87a4">01893</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a4800245aeca1e7f88a0725df176d87a4">volume_disable</a>(self, vol_id, flags=0):
<a name="l01894"></a>01894         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01895"></a>01895         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_state_change(
<a name="l01896"></a>01896             SimArray._sim_vol_id_of(vol_id), Volume.ADMIN_STATE_DISABLED)
<a name="l01897"></a>01897         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01898"></a>01898         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l01899"></a>01899 
<a name="l01900"></a>01900     @_handle_errors
<a name="l01901"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#afb5df2951874c3e674f8c7abfa1a991a">01901</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#afb5df2951874c3e674f8c7abfa1a991a">volume_child_dependency</a>(self, vol_id, flags=0):
<a name="l01902"></a>01902         <span class="comment"># TODO(Gris Ge): API defination is blur:</span>
<a name="l01903"></a>01903         <span class="comment">#       0. Should we break replication if provided volume is a</span>
<a name="l01904"></a>01904         <span class="comment">#          replication target?</span>
<a name="l01905"></a>01905         <span class="comment">#          Assuming answer is no.</span>
<a name="l01906"></a>01906         <span class="comment">#       1. _client.py comments incorrect:</span>
<a name="l01907"></a>01907         <span class="comment">#           &quot;Implies that this volume cannot be deleted or possibly</span>
<a name="l01908"></a>01908         <span class="comment">#            modified because it would affect its children&quot;</span>
<a name="l01909"></a>01909         <span class="comment">#          The &apos;modify&apos; here is incorrect. If data on source volume</span>
<a name="l01910"></a>01910         <span class="comment">#          changes, SYNC_MIRROR replication will change all target</span>
<a name="l01911"></a>01911         <span class="comment">#          volumes.</span>
<a name="l01912"></a>01912         <span class="comment">#       2. Should &apos;mask&apos; relationship included?</span>
<a name="l01913"></a>01913         <span class="comment">#           # Assuming only replication counts here.</span>
<a name="l01914"></a>01914         <span class="comment">#       3. For volume internal block replication, should we return</span>
<a name="l01915"></a>01915         <span class="comment">#          True or False.</span>
<a name="l01916"></a>01916         <span class="comment">#          # Assuming False</span>
<a name="l01917"></a>01917         <span class="comment">#       4. volume_child_dependency_rm() against volume internal</span>
<a name="l01918"></a>01918         <span class="comment">#          block replication, remove replication or raise error?</span>
<a name="l01919"></a>01919         <span class="comment">#          # Assuming remove replication</span>
<a name="l01920"></a>01920         src_sim_vol_id = SimArray._sim_vol_id_of(vol_id)
<a name="l01921"></a>01921         dst_sim_vol_ids = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.dst_sim_vol_ids_of_src(src_sim_vol_id)
<a name="l01922"></a>01922         <span class="keywordflow">for</span> dst_sim_fs_id <span class="keywordflow">in</span> dst_sim_vol_ids:
<a name="l01923"></a>01923             <span class="keywordflow">if</span> dst_sim_fs_id != src_sim_vol_id:
<a name="l01924"></a>01924                 <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l01925"></a>01925         <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l01926"></a>01926 
<a name="l01927"></a>01927     @_handle_errors
<a name="l01928"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ae036f7ff9f3cd382280b43c892e3ea91">01928</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ae036f7ff9f3cd382280b43c892e3ea91">volume_child_dependency_rm</a>(self, vol_id, flags=0):
<a name="l01929"></a>01929         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_src_replica_break(
<a name="l01932"></a>01932             SimArray._sim_vol_id_of(vol_id))
<a name="l01933"></a>01933 
<a name="l01934"></a>01934         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l01935"></a>01935         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01936"></a>01936         <span class="keywordflow">return</span> job_id
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     @staticmethod
<a name="l01939"></a>01939     <span class="keyword">def </span>_sim_fs_2_lsm(sim_fs):
<a name="l01940"></a>01940         fs_id = SimArray._sim_id_to_lsm_id(sim_fs[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;FS&apos;</span>)
<a name="l01941"></a>01941         pool_id = SimArray._sim_id_to_lsm_id(sim_fs[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;POOL&apos;</span>)
<a name="l01942"></a>01942         <span class="keywordflow">return</span> FileSystem(fs_id, sim_fs[<span class="stringliteral">&apos;name&apos;</span>],
<a name="l01943"></a>01943                           sim_fs[<span class="stringliteral">&apos;total_space&apos;</span>], sim_fs[<span class="stringliteral">&apos;free_space&apos;</span>],
<a name="l01944"></a>01944                           pool_id, BackStore.SYS_ID)
<a name="l01945"></a>01945 
<a name="l01946"></a>01946     @_handle_errors
<a name="l01947"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a236bd85213ba394f4fd2347572a16977">01947</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a236bd85213ba394f4fd2347572a16977">fs</a>(self):
<a name="l01948"></a>01948         <span class="keywordflow">return</span> list(SimArray._sim_fs_2_lsm(f) <span class="keywordflow">for</span> f <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fss())
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     @_handle_errors
<a name="l01951"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a3524bdbbe612872536d978a2c82cf02b">01951</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a3524bdbbe612872536d978a2c82cf02b">fs_create</a>(self, pool_id, fs_name, size_bytes, flags=0,
<a name="l01952"></a>01952                   _internal_use=<span class="keyword">False</span>):
<a name="l01953"></a>01953 
<a name="l01954"></a>01954         <span class="keywordflow">if</span> <span class="keywordflow">not</span> _internal_use:
<a name="l01955"></a>01955             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01956"></a>01956 
<a name="l01957"></a>01957         new_sim_fs_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_create(
<a name="l01958"></a>01958             fs_name, size_bytes, SimArray._sim_pool_id_of(pool_id))
<a name="l01959"></a>01959 
<a name="l01960"></a>01960         <span class="keywordflow">if</span> _internal_use:
<a name="l01961"></a>01961             <span class="keywordflow">return</span> new_sim_fs_id
<a name="l01962"></a>01962 
<a name="l01963"></a>01963         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(
<a name="l01964"></a>01964             BackStore.JOB_DATA_TYPE_FS, new_sim_fs_id)
<a name="l01965"></a>01965         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01966"></a>01966 
<a name="l01967"></a>01967         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l01968"></a>01968 
<a name="l01969"></a>01969     @_handle_errors
<a name="l01970"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a3d6ad99bdaf903dc771c3f82f94a812f">01970</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a3d6ad99bdaf903dc771c3f82f94a812f">fs_delete</a>(self, fs_id, flags=0):
<a name="l01971"></a>01971         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01972"></a>01972         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_delete(SimArray._sim_fs_id_of(fs_id))
<a name="l01973"></a>01973         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l01974"></a>01974         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01975"></a>01975         <span class="keywordflow">return</span> job_id
<a name="l01976"></a>01976 
<a name="l01977"></a>01977     @_handle_errors
<a name="l01978"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a59de229f82d74c0dc6c5bb890491a06d">01978</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a59de229f82d74c0dc6c5bb890491a06d">fs_resize</a>(self, fs_id, new_size_bytes, flags=0):
<a name="l01979"></a>01979         sim_fs_id = SimArray._sim_fs_id_of(fs_id)
<a name="l01980"></a>01980         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01981"></a>01981         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_resize(sim_fs_id, new_size_bytes)
<a name="l01982"></a>01982         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(BackStore.JOB_DATA_TYPE_FS, sim_fs_id)
<a name="l01983"></a>01983         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l01984"></a>01984         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l01985"></a>01985 
<a name="l01986"></a>01986     @_handle_errors
<a name="l01987"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a359ed1df01a4ef2fc9a4121583b7dfbc">01987</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a359ed1df01a4ef2fc9a4121583b7dfbc">fs_clone</a>(self, src_fs_id, dst_fs_name, snap_id, flags=0):
<a name="l01988"></a>01988         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l01989"></a>01989 
<a name="l01990"></a>01990         sim_fs_snap_id = <span class="keywordtype">None</span>
<a name="l01991"></a>01991         <span class="keywordflow">if</span> snap_id:
<a name="l01992"></a>01992             sim_fs_snap_id = SimArray._sim_fs_snap_id_of(snap_id)
<a name="l01993"></a>01993 
<a name="l01994"></a>01994         src_sim_fs_id = SimArray._sim_fs_id_of(src_fs_id)
<a name="l01995"></a>01995         src_sim_fs = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_of_id(src_sim_fs_id)
<a name="l01996"></a>01996         pool_id = SimArray._sim_id_to_lsm_id(src_sim_fs[<span class="stringliteral">&apos;pool_id&apos;</span>], <span class="stringliteral">&apos;POOL&apos;</span>)
<a name="l01997"></a>01997 
<a name="l01998"></a>01998         dst_sim_fs_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a3524bdbbe612872536d978a2c82cf02b">fs_create</a>(
<a name="l01999"></a>01999             pool_id, dst_fs_name, src_sim_fs[<span class="stringliteral">&apos;total_space&apos;</span>],
<a name="l02000"></a>02000             _internal_use=<span class="keyword">True</span>)
<a name="l02001"></a>02001 
<a name="l02002"></a>02002         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_clone(src_sim_fs_id, dst_sim_fs_id, sim_fs_snap_id)
<a name="l02003"></a>02003 
<a name="l02004"></a>02004         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(
<a name="l02005"></a>02005             BackStore.JOB_DATA_TYPE_FS, dst_sim_fs_id)
<a name="l02006"></a>02006         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02007"></a>02007 
<a name="l02008"></a>02008         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l02009"></a>02009 
<a name="l02010"></a>02010     @_handle_errors
<a name="l02011"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a77e22ffb0ae4c4984273f441c70deca3">02011</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a77e22ffb0ae4c4984273f441c70deca3">fs_file_clone</a>(self, fs_id, src_fs_name, dst_fs_name, snap_id, flags=0):
<a name="l02012"></a>02012         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02013"></a>02013         sim_fs_snap_id = <span class="keywordtype">None</span>
<a name="l02014"></a>02014         <span class="keywordflow">if</span> snap_id:
<a name="l02015"></a>02015             sim_fs_snap_id = SimArray._sim_fs_snap_id_of(snap_id)
<a name="l02016"></a>02016 
<a name="l02017"></a>02017         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_file_clone(
<a name="l02018"></a>02018             SimArray._sim_fs_id_of(fs_id), src_fs_name, dst_fs_name,
<a name="l02019"></a>02019             sim_fs_snap_id)
<a name="l02020"></a>02020 
<a name="l02021"></a>02021         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l02022"></a>02022         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02023"></a>02023         <span class="keywordflow">return</span> job_id
<a name="l02024"></a>02024 
<a name="l02025"></a>02025     @staticmethod
<a name="l02026"></a>02026     <span class="keyword">def </span>_sim_fs_snap_2_lsm(sim_fs_snap):
<a name="l02027"></a>02027         snap_id = SimArray._sim_id_to_lsm_id(sim_fs_snap[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;FS_SNAP&apos;</span>)
<a name="l02028"></a>02028         <span class="keywordflow">return</span> FsSnapshot(
<a name="l02029"></a>02029             snap_id, sim_fs_snap[<span class="stringliteral">&apos;name&apos;</span>], sim_fs_snap[<span class="stringliteral">&apos;timestamp&apos;</span>])
<a name="l02030"></a>02030 
<a name="l02031"></a>02031     @_handle_errors
<a name="l02032"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#afe5befabb920b55e493b9e7bf0b59920">02032</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#afe5befabb920b55e493b9e7bf0b59920">fs_snapshots</a>(self, fs_id, flags=0):
<a name="l02033"></a>02033         <span class="keywordflow">return</span> list(
<a name="l02034"></a>02034             SimArray._sim_fs_snap_2_lsm(s)
<a name="l02035"></a>02035             <span class="keywordflow">for</span> s <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_snaps(
<a name="l02036"></a>02036                 SimArray._sim_fs_id_of(fs_id)))
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     @_handle_errors
<a name="l02039"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7c12da3146af0006337bf4f701d27905">02039</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7c12da3146af0006337bf4f701d27905">fs_snapshot_create</a>(self, fs_id, snap_name, flags=0):
<a name="l02040"></a>02040         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02041"></a>02041         sim_fs_snap_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_snap_create(
<a name="l02042"></a>02042             SimArray._sim_fs_id_of(fs_id), snap_name)
<a name="l02043"></a>02043         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>(
<a name="l02044"></a>02044             BackStore.JOB_DATA_TYPE_FS_SNAP, sim_fs_snap_id)
<a name="l02045"></a>02045         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02046"></a>02046         <span class="keywordflow">return</span> job_id, <span class="keywordtype">None</span>
<a name="l02047"></a>02047 
<a name="l02048"></a>02048     @_handle_errors
<a name="l02049"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aabcb01babcda8c279ecaed56b8863b01">02049</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aabcb01babcda8c279ecaed56b8863b01">fs_snapshot_delete</a>(self, fs_id, snap_id, flags=0):
<a name="l02050"></a>02050         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02051"></a>02051         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_snap_delete(
<a name="l02052"></a>02052             SimArray._sim_fs_snap_id_of(snap_id),
<a name="l02053"></a>02053             SimArray._sim_fs_id_of(fs_id))
<a name="l02054"></a>02054         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l02055"></a>02055         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02056"></a>02056         <span class="keywordflow">return</span> job_id
<a name="l02057"></a>02057 
<a name="l02058"></a>02058     @_handle_errors
<a name="l02059"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a92729940c719c36671ee2735d804fcbb">02059</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a92729940c719c36671ee2735d804fcbb">fs_snapshot_restore</a>(self, fs_id, snap_id, files, restore_files,
<a name="l02060"></a>02060                             flag_all_files, flags):
<a name="l02061"></a>02061         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02062"></a>02062         sim_fs_snap_id = <span class="keywordtype">None</span>
<a name="l02063"></a>02063         <span class="keywordflow">if</span> snap_id:
<a name="l02064"></a>02064             sim_fs_snap_id = SimArray._sim_fs_snap_id_of(snap_id)
<a name="l02065"></a>02065 
<a name="l02066"></a>02066         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_snap_restore(
<a name="l02067"></a>02067             SimArray._sim_fs_id_of(fs_id),
<a name="l02068"></a>02068             sim_fs_snap_id, files, restore_files, flag_all_files)
<a name="l02069"></a>02069 
<a name="l02070"></a>02070         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l02071"></a>02071         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02072"></a>02072         <span class="keywordflow">return</span> job_id
<a name="l02073"></a>02073 
<a name="l02074"></a>02074     @_handle_errors
<a name="l02075"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af3ba7cdbfa8bfab3ffd0050e05c6357e">02075</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af3ba7cdbfa8bfab3ffd0050e05c6357e">fs_child_dependency</a>(self, fs_id, files, flags=0):
<a name="l02076"></a>02076         sim_fs_id = SimArray._sim_fs_id_of(fs_id)
<a name="l02077"></a>02077         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02078"></a>02078         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.clone_dst_sim_fs_ids_of_src(sim_fs_id) == [] <span class="keywordflow">and</span> \
<a name="l02079"></a>02079            self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_snaps(sim_fs_id) == []:
<a name="l02080"></a>02080             self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_rollback()
<a name="l02081"></a>02081             <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l02082"></a>02082         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_rollback()
<a name="l02083"></a>02083         <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l02084"></a>02084 
<a name="l02085"></a>02085     @_handle_errors
<a name="l02086"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ae6f1b29fdc7d7384f931b6f7e78f1b24">02086</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ae6f1b29fdc7d7384f931b6f7e78f1b24">fs_child_dependency_rm</a>(self, fs_id, files, flags=0):
<a name="l02087"></a>02087         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l02088"></a>02088 <span class="stringliteral">        Assuming API defination is break all clone relationship and remove</span>
<a name="l02089"></a>02089 <span class="stringliteral">        all snapshot of this source file system.</span>
<a name="l02090"></a>02090 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l02091"></a>02091         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02092"></a>02092         <span class="keywordflow">if</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af3ba7cdbfa8bfab3ffd0050e05c6357e">fs_child_dependency</a>(fs_id, files) <span class="keywordflow">is</span> <span class="keyword">False</span>:
<a name="l02093"></a>02093             <span class="keywordflow">raise</span> LsmError(
<a name="l02094"></a>02094                 ErrorNumber.NO_STATE_CHANGE,
<a name="l02095"></a>02095                 <span class="stringliteral">&quot;No snapshot or fs clone target found for this file system&quot;</span>)
<a name="l02096"></a>02096 
<a name="l02097"></a>02097         src_sim_fs_id = SimArray._sim_fs_id_of(fs_id)
<a name="l02098"></a>02098         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_src_clone_break(src_sim_fs_id)
<a name="l02099"></a>02099         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_fs_snap_del_by_fs(src_sim_fs_id)
<a name="l02100"></a>02100         job_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a7be96ebb3acbaf2b8552845c74f9134c">_job_create</a>()
<a name="l02101"></a>02101         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02102"></a>02102         <span class="keywordflow">return</span> job_id
<a name="l02103"></a>02103 
<a name="l02104"></a>02104     @staticmethod
<a name="l02105"></a>02105     <span class="keyword">def </span>_sim_exp_2_lsm(sim_exp):
<a name="l02106"></a>02106         exp_id = SimArray._sim_id_to_lsm_id(sim_exp[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;EXP&apos;</span>)
<a name="l02107"></a>02107         fs_id = SimArray._sim_id_to_lsm_id(sim_exp[<span class="stringliteral">&apos;fs_id&apos;</span>], <span class="stringliteral">&apos;FS&apos;</span>)
<a name="l02108"></a>02108         <span class="keywordflow">return</span> NfsExport(exp_id, fs_id, sim_exp[<span class="stringliteral">&apos;exp_path&apos;</span>],
<a name="l02109"></a>02109                          sim_exp[<span class="stringliteral">&apos;auth_type&apos;</span>], sim_exp[<span class="stringliteral">&apos;root_hosts&apos;</span>],
<a name="l02110"></a>02110                          sim_exp[<span class="stringliteral">&apos;rw_hosts&apos;</span>], sim_exp[<span class="stringliteral">&apos;ro_hosts&apos;</span>],
<a name="l02111"></a>02111                          sim_exp[<span class="stringliteral">&apos;anon_uid&apos;</span>], sim_exp[<span class="stringliteral">&apos;anon_gid&apos;</span>],
<a name="l02112"></a>02112                          sim_exp[<span class="stringliteral">&apos;options&apos;</span>])
<a name="l02113"></a>02113 
<a name="l02114"></a>02114     @_handle_errors
<a name="l02115"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a78cec8d7471da45634f0dcd747419427">02115</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a78cec8d7471da45634f0dcd747419427">exports</a>(self, flags=0):
<a name="l02116"></a>02116         <span class="keywordflow">return</span> [SimArray._sim_exp_2_lsm(e) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_exps()]
<a name="l02117"></a>02117 
<a name="l02118"></a>02118     @_handle_errors
<a name="l02119"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a9b6b556b2f796d4a8868d33c8ae0d423">02119</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a9b6b556b2f796d4a8868d33c8ae0d423">fs_export</a>(self, fs_id, exp_path, root_hosts, rw_hosts, ro_hosts,
<a name="l02120"></a>02120                   anon_uid, anon_gid, auth_type, options, flags=0):
<a name="l02121"></a>02121         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02122"></a>02122         sim_exp_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_exp_create(
<a name="l02123"></a>02123             SimArray._sim_fs_id_of(fs_id), exp_path, root_hosts, rw_hosts,
<a name="l02124"></a>02124             ro_hosts, anon_uid, anon_gid, auth_type, options)
<a name="l02125"></a>02125         sim_exp = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_exp_of_id(sim_exp_id)
<a name="l02126"></a>02126         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02127"></a>02127         <span class="keywordflow">return</span> SimArray._sim_exp_2_lsm(sim_exp)
<a name="l02128"></a>02128 
<a name="l02129"></a>02129     @_handle_errors
<a name="l02130"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a0e6566740210e44dc3c101e7859fedc7">02130</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a0e6566740210e44dc3c101e7859fedc7">fs_unexport</a>(self, exp_id, flags=0):
<a name="l02131"></a>02131         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02132"></a>02132         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_exp_delete(SimArray._sim_exp_id_of(exp_id))
<a name="l02133"></a>02133         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02134"></a>02134         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l02135"></a>02135 
<a name="l02136"></a>02136     @staticmethod
<a name="l02137"></a>02137     <span class="keyword">def </span>_sim_ag_2_lsm(sim_ag):
<a name="l02138"></a>02138         ag_id = SimArray._sim_id_to_lsm_id(sim_ag[<span class="stringliteral">&apos;id&apos;</span>], <span class="stringliteral">&apos;AG&apos;</span>)
<a name="l02139"></a>02139         <span class="keywordflow">return</span> AccessGroup(ag_id, sim_ag[<span class="stringliteral">&apos;name&apos;</span>], sim_ag[<span class="stringliteral">&apos;init_ids&apos;</span>],
<a name="l02140"></a>02140                            sim_ag[<span class="stringliteral">&apos;init_type&apos;</span>], BackStore.SYS_ID)
<a name="l02141"></a>02141 
<a name="l02142"></a>02142     @_handle_errors
<a name="l02143"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a672f35e578043e24a07b1174f4b82618">02143</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a672f35e578043e24a07b1174f4b82618">ags</a>(self):
<a name="l02144"></a>02144         <span class="keywordflow">return</span> list(SimArray._sim_ag_2_lsm(a) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ags())
<a name="l02145"></a>02145 
<a name="l02146"></a>02146     @_handle_errors
<a name="l02147"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af63a602f74f6962c3e221f95139b6ec9">02147</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af63a602f74f6962c3e221f95139b6ec9">access_group_create</a>(self, name, init_id, init_type, sys_id, flags=0):
<a name="l02148"></a>02148         <span class="keywordflow">if</span> sys_id != BackStore.SYS_ID:
<a name="l02149"></a>02149             <span class="keywordflow">raise</span> LsmError(
<a name="l02150"></a>02150                 ErrorNumber.NOT_FOUND_SYSTEM,
<a name="l02151"></a>02151                 <span class="stringliteral">&quot;System not found&quot;</span>)
<a name="l02152"></a>02152         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02153"></a>02153         new_sim_ag_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_create(name, init_type, init_id)
<a name="l02154"></a>02154         new_sim_ag = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_of_id(new_sim_ag_id)
<a name="l02155"></a>02155         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02156"></a>02156         <span class="keywordflow">return</span> SimArray._sim_ag_2_lsm(new_sim_ag)
<a name="l02157"></a>02157 
<a name="l02158"></a>02158     @_handle_errors
<a name="l02159"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aba0f6f045f87fd8f6fe322a8793e6a69">02159</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aba0f6f045f87fd8f6fe322a8793e6a69">access_group_delete</a>(self, ag_id, flags=0):
<a name="l02160"></a>02160         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02161"></a>02161         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_delete(SimArray._sim_ag_id_of(ag_id))
<a name="l02162"></a>02162         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02163"></a>02163         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     @_handle_errors
<a name="l02166"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a9ec73fc0bf18a45d5221412927a08996">02166</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a9ec73fc0bf18a45d5221412927a08996">access_group_initiator_add</a>(self, ag_id, init_id, init_type, flags=0):
<a name="l02167"></a>02167         sim_ag_id = SimArray._sim_ag_id_of(ag_id)
<a name="l02168"></a>02168         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02169"></a>02169         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_init_add(sim_ag_id, init_id, init_type)
<a name="l02170"></a>02170         new_sim_ag = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_of_id(sim_ag_id)
<a name="l02171"></a>02171         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02172"></a>02172         <span class="keywordflow">return</span> SimArray._sim_ag_2_lsm(new_sim_ag)
<a name="l02173"></a>02173 
<a name="l02174"></a>02174     @_handle_errors
<a name="l02175"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a8919bfb998058b96205c27c05246c62d">02175</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a8919bfb998058b96205c27c05246c62d">access_group_initiator_delete</a>(self, ag_id, init_id, init_type,
<a name="l02176"></a>02176                                       flags=0):
<a name="l02177"></a>02177         sim_ag_id = SimArray._sim_ag_id_of(ag_id)
<a name="l02178"></a>02178         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02179"></a>02179         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_init_delete(sim_ag_id, init_id)
<a name="l02180"></a>02180         sim_ag = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ag_of_id(sim_ag_id)
<a name="l02181"></a>02181         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02182"></a>02182         <span class="keywordflow">return</span> SimArray._sim_ag_2_lsm(sim_ag)
<a name="l02183"></a>02183 
<a name="l02184"></a>02184     @_handle_errors
<a name="l02185"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a11e89b0a224501a5633ff3976b26b974">02185</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a11e89b0a224501a5633ff3976b26b974">volume_mask</a>(self, ag_id, vol_id, flags=0):
<a name="l02186"></a>02186         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02187"></a>02187         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_mask(
<a name="l02188"></a>02188             SimArray._sim_vol_id_of(vol_id),
<a name="l02189"></a>02189             SimArray._sim_ag_id_of(ag_id))
<a name="l02190"></a>02190         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02191"></a>02191         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l02192"></a>02192 
<a name="l02193"></a>02193     @_handle_errors
<a name="l02194"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af7608f5de545237cfa4f0b24e82387b9">02194</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#af7608f5de545237cfa4f0b24e82387b9">volume_unmask</a>(self, ag_id, vol_id, flags=0):
<a name="l02195"></a>02195         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02196"></a>02196         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_unmask(
<a name="l02197"></a>02197             SimArray._sim_vol_id_of(vol_id),
<a name="l02198"></a>02198             SimArray._sim_ag_id_of(ag_id))
<a name="l02199"></a>02199         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02200"></a>02200         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     @_handle_errors
<a name="l02203"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a0a2e95aefb436c1ed984032e3653461b">02203</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a0a2e95aefb436c1ed984032e3653461b">volumes_accessible_by_access_group</a>(self, ag_id, flags=0):
<a name="l02204"></a>02204         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02205"></a>02205 
<a name="l02206"></a>02206         sim_vols = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vols(
<a name="l02207"></a>02207             sim_ag_id=SimArray._sim_ag_id_of(ag_id))
<a name="l02208"></a>02208 
<a name="l02209"></a>02209         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_rollback()
<a name="l02210"></a>02210         <span class="keywordflow">return</span> [SimArray._sim_vol_2_lsm(v) <span class="keywordflow">for</span> v <span class="keywordflow">in</span> sim_vols]
<a name="l02211"></a>02211 
<a name="l02212"></a>02212     @_handle_errors
<a name="l02213"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aa753a9c96673070b38e6ae79f31bd51f">02213</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aa753a9c96673070b38e6ae79f31bd51f">access_groups_granted_to_volume</a>(self, vol_id, flags=0):
<a name="l02214"></a>02214         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02215"></a>02215         sim_ags = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_ags(
<a name="l02216"></a>02216             sim_vol_id=SimArray._sim_vol_id_of(vol_id))
<a name="l02217"></a>02217         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_rollback()
<a name="l02218"></a>02218         <span class="keywordflow">return</span> [SimArray._sim_ag_2_lsm(a) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> sim_ags]
<a name="l02219"></a>02219 
<a name="l02220"></a>02220     @_handle_errors
<a name="l02221"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ab61c233e2e6bb835df18d92cd38b526b">02221</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ab61c233e2e6bb835df18d92cd38b526b">iscsi_chap_auth</a>(self, init_id, in_user, in_pass, out_user, out_pass,
<a name="l02222"></a>02222                         flags=0):
<a name="l02223"></a>02223         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02224"></a>02224         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.iscsi_chap_auth_set(
<a name="l02225"></a>02225             init_id, in_user, in_pass, out_user, out_pass)
<a name="l02226"></a>02226         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02227"></a>02227         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l02228"></a>02228 
<a name="l02229"></a>02229     @staticmethod
<a name="l02230"></a>02230     <span class="keyword">def </span>_sim_tgt_2_lsm(sim_tgt):
<a name="l02231"></a>02231         tgt_id = <span class="stringliteral">&quot;TGT_PORT_ID_%0*d&quot;</span> % (SimArray.ID_FMT, sim_tgt[<span class="stringliteral">&apos;id&apos;</span>])
<a name="l02232"></a>02232         <span class="keywordflow">return</span> TargetPort(
<a name="l02233"></a>02233             tgt_id, sim_tgt[<span class="stringliteral">&apos;port_type&apos;</span>], sim_tgt[<span class="stringliteral">&apos;service_address&apos;</span>],
<a name="l02234"></a>02234             sim_tgt[<span class="stringliteral">&apos;network_address&apos;</span>], sim_tgt[<span class="stringliteral">&apos;physical_address&apos;</span>],
<a name="l02235"></a>02235             sim_tgt[<span class="stringliteral">&apos;physical_name&apos;</span>],
<a name="l02236"></a>02236             BackStore.SYS_ID)
<a name="l02237"></a>02237 
<a name="l02238"></a>02238     @_handle_errors
<a name="l02239"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aaff72e64ca31adf18ea2b5897de86e2e">02239</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#aaff72e64ca31adf18ea2b5897de86e2e">target_ports</a>(self):
<a name="l02240"></a>02240         <span class="keywordflow">return</span> list(SimArray._sim_tgt_2_lsm(t) <span class="keywordflow">for</span> t <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_tgts())
<a name="l02241"></a>02241 
<a name="l02242"></a>02242     @_handle_errors
<a name="l02243"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a167642e25ed4505c71839563c08f4ea2">02243</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a167642e25ed4505c71839563c08f4ea2">volume_raid_info</a>(self, lsm_vol):
<a name="l02244"></a>02244         sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_of_id(
<a name="l02245"></a>02245             SimArray._lsm_id_to_sim_id(
<a name="l02246"></a>02246                 lsm_vol.pool_id,
<a name="l02247"></a>02247                 LsmError(ErrorNumber.NOT_FOUND_POOL, <span class="stringliteral">&quot;Pool not found&quot;</span>)))
<a name="l02248"></a>02248 
<a name="l02249"></a>02249         raid_type = sim_pool[<span class="stringliteral">&apos;raid_type&apos;</span>]
<a name="l02250"></a>02250         strip_size = Volume.STRIP_SIZE_UNKNOWN
<a name="l02251"></a>02251         min_io_size = BackStore.BLK_SIZE
<a name="l02252"></a>02252         opt_io_size = Volume.OPT_IO_SIZE_UNKNOWN
<a name="l02253"></a>02253         disk_count = Volume.DISK_COUNT_UNKNOWN
<a name="l02254"></a>02254 
<a name="l02255"></a>02255         <span class="keywordflow">if</span> sim_pool[<span class="stringliteral">&apos;member_type&apos;</span>] == Pool.MEMBER_TYPE_POOL:
<a name="l02256"></a>02256             parent_sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_of_id(
<a name="l02257"></a>02257                 sim_pool[<span class="stringliteral">&apos;parent_pool_id&apos;</span>])
<a name="l02258"></a>02258             raid_type = parent_sim_pool[<span class="stringliteral">&apos;raid_type&apos;</span>]
<a name="l02259"></a>02259 
<a name="l02260"></a>02260             disk_count = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_disks_count(
<a name="l02261"></a>02261                 parent_sim_pool[<span class="stringliteral">&apos;id&apos;</span>])
<a name="l02262"></a>02262             data_disk_count = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_data_disks_count(
<a name="l02263"></a>02263                 parent_sim_pool[<span class="stringliteral">&apos;id&apos;</span>])
<a name="l02264"></a>02264         <span class="keywordflow">else</span>:
<a name="l02265"></a>02265             disk_count = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_disks_count(
<a name="l02266"></a>02266                 sim_pool[<span class="stringliteral">&apos;id&apos;</span>])
<a name="l02267"></a>02267             data_disk_count = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_data_disks_count(
<a name="l02268"></a>02268                 sim_pool[<span class="stringliteral">&apos;id&apos;</span>])
<a name="l02269"></a>02269 
<a name="l02270"></a>02270         <span class="keywordflow">if</span> raid_type == Volume.RAID_TYPE_UNKNOWN <span class="keywordflow">or</span> \
<a name="l02271"></a>02271            raid_type == Volume.RAID_TYPE_OTHER:
<a name="l02272"></a>02272             <span class="keywordflow">return</span> [
<a name="l02273"></a>02273                 raid_type, strip_size, disk_count, min_io_size,
<a name="l02274"></a>02274                 opt_io_size]
<a name="l02275"></a>02275 
<a name="l02276"></a>02276         <span class="keywordflow">if</span> raid_type == Volume.RAID_TYPE_MIXED:
<a name="l02277"></a>02277             <span class="keywordflow">raise</span> LsmError(
<a name="l02278"></a>02278                 ErrorNumber.PLUGIN_BUG,
<a name="l02279"></a>02279                 <span class="stringliteral">&quot;volume_raid_info(): Got unsupported RAID_TYPE_MIXED pool &quot;</span>
<a name="l02280"></a>02280                 <span class="stringliteral">&quot;%s&quot;</span> % sim_pool[<span class="stringliteral">&apos;id&apos;</span>])
<a name="l02281"></a>02281 
<a name="l02282"></a>02282         <span class="keywordflow">if</span> raid_type == Volume.RAID_TYPE_RAID1 <span class="keywordflow">or</span> \
<a name="l02283"></a>02283            raid_type == Volume.RAID_TYPE_JBOD:
<a name="l02284"></a>02284             strip_size = BackStore.BLK_SIZE
<a name="l02285"></a>02285             min_io_size = BackStore.BLK_SIZE
<a name="l02286"></a>02286             opt_io_size = BackStore.BLK_SIZE
<a name="l02287"></a>02287         <span class="keywordflow">else</span>:
<a name="l02288"></a>02288             strip_size = sim_pool[<span class="stringliteral">&apos;strip_size&apos;</span>]
<a name="l02289"></a>02289             min_io_size = strip_size
<a name="l02290"></a>02290             opt_io_size = int(data_disk_count * strip_size)
<a name="l02291"></a>02291 
<a name="l02292"></a>02292         <span class="keywordflow">return</span> [raid_type, strip_size, disk_count, min_io_size, opt_io_size]
<a name="l02293"></a>02293 
<a name="l02294"></a>02294     @_handle_errors
<a name="l02295"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a491c490a0a0d1d9a4cf537d3330a6168">02295</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a491c490a0a0d1d9a4cf537d3330a6168">pool_member_info</a>(self, lsm_pool):
<a name="l02296"></a>02296         sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_of_id(
<a name="l02297"></a>02297             SimArray._lsm_id_to_sim_id(
<a name="l02298"></a>02298                 lsm_pool.id,
<a name="l02299"></a>02299                 LsmError(ErrorNumber.NOT_FOUND_POOL, <span class="stringliteral">&quot;Pool not found&quot;</span>)))
<a name="l02300"></a>02300         member_type = sim_pool[<span class="stringliteral">&apos;member_type&apos;</span>]
<a name="l02301"></a>02301         member_ids = []
<a name="l02302"></a>02302         <span class="keywordflow">if</span> member_type == Pool.MEMBER_TYPE_POOL:
<a name="l02303"></a>02303             member_ids = [
<a name="l02304"></a>02304                 SimArray._sim_id_to_lsm_id(
<a name="l02305"></a>02305                     sim_pool[<span class="stringliteral">&apos;parent_pool_id&apos;</span>], <span class="stringliteral">&apos;POOL&apos;</span>)]
<a name="l02306"></a>02306         <span class="keywordflow">elif</span> member_type == Pool.MEMBER_TYPE_DISK:
<a name="l02307"></a>02307             member_ids = list(
<a name="l02308"></a>02308                 SimArray._sim_id_to_lsm_id(sim_disk_id, <span class="stringliteral">&apos;DISK&apos;</span>)
<a name="l02309"></a>02309                 <span class="keywordflow">for</span> sim_disk_id <span class="keywordflow">in</span> self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_disk_ids_of_pool(
<a name="l02310"></a>02310                     sim_pool[<span class="stringliteral">&apos;id&apos;</span>]))
<a name="l02311"></a>02311         <span class="keywordflow">else</span>:
<a name="l02312"></a>02312             member_type = Pool.MEMBER_TYPE_UNKNOWN
<a name="l02313"></a>02313 
<a name="l02314"></a>02314         <span class="keywordflow">return</span> sim_pool[<span class="stringliteral">&apos;raid_type&apos;</span>], member_type, member_ids
<a name="l02315"></a>02315 
<a name="l02316"></a>02316     @_handle_errors
<a name="l02317"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a64187e9b20c52957b3cc4de4ca20f616">02317</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a64187e9b20c52957b3cc4de4ca20f616">volume_raid_create_cap_get</a>(self, system):
<a name="l02318"></a>02318         <span class="keywordflow">if</span> system.id != BackStore.SYS_ID:
<a name="l02319"></a>02319             <span class="keywordflow">raise</span> LsmError(
<a name="l02320"></a>02320                 ErrorNumber.NOT_FOUND_SYSTEM,
<a name="l02321"></a>02321                 <span class="stringliteral">&quot;System not found&quot;</span>)
<a name="l02322"></a>02322         <span class="keywordflow">return</span> (
<a name="l02323"></a>02323             BackStore.SUPPORTED_VCR_RAID_TYPES,
<a name="l02324"></a>02324             BackStore.SUPPORTED_VCR_STRIP_SIZES)
<a name="l02325"></a>02325 
<a name="l02326"></a>02326     @_handle_errors
<a name="l02327"></a><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ac4bb3abaf692612c6c73aab2b95b70fe">02327</a>     <span class="keyword">def </span><a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ac4bb3abaf692612c6c73aab2b95b70fe">volume_raid_create</a>(self, name, raid_type, disks, strip_size):
<a name="l02328"></a>02328         <span class="keywordflow">if</span> raid_type <span class="keywordflow">not</span> <span class="keywordflow">in</span> BackStore.SUPPORTED_VCR_RAID_TYPES:
<a name="l02329"></a>02329             <span class="keywordflow">raise</span> LsmError(
<a name="l02330"></a>02330                 ErrorNumber.NO_SUPPORT,
<a name="l02331"></a>02331                 <span class="stringliteral">&quot;Provided &apos;raid_type&apos; is not supported&quot;</span>)
<a name="l02332"></a>02332 
<a name="l02333"></a>02333         <span class="keywordflow">if</span> strip_size == Volume.VCR_STRIP_SIZE_DEFAULT:
<a name="l02334"></a>02334             strip_size = BackStore.DEFAULT_STRIP_SIZE
<a name="l02335"></a>02335         <span class="keywordflow">elif</span> strip_size <span class="keywordflow">not</span> <span class="keywordflow">in</span> BackStore.SUPPORTED_VCR_STRIP_SIZES:
<a name="l02336"></a>02336             <span class="keywordflow">raise</span> LsmError(
<a name="l02337"></a>02337                 ErrorNumber.NO_SUPPORT,
<a name="l02338"></a>02338                 <span class="stringliteral">&quot;Provided &apos;strip_size&apos; is not supported&quot;</span>)
<a name="l02339"></a>02339 
<a name="l02340"></a>02340         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_begin()
<a name="l02341"></a>02341         pool_name = <span class="stringliteral">&quot;Pool for volume %s&quot;</span> % name
<a name="l02342"></a>02342         sim_disk_ids = [
<a name="l02343"></a>02343             SimArray._lsm_id_to_sim_id(
<a name="l02344"></a>02344                 d.id,
<a name="l02345"></a>02345                 LsmError(ErrorNumber.NOT_FOUND_DISK, <span class="stringliteral">&quot;Disk not found&quot;</span>))
<a name="l02346"></a>02346             <span class="keywordflow">for</span> d <span class="keywordflow">in</span> disks]
<a name="l02347"></a>02347 
<a name="l02348"></a>02348         <span class="keywordflow">for</span> disk <span class="keywordflow">in</span> disks:
<a name="l02349"></a>02349             <span class="keywordflow">if</span> <span class="keywordflow">not</span> disk.status &amp; Disk.STATUS_FREE:
<a name="l02350"></a>02350                 <span class="keywordflow">raise</span> LsmError(
<a name="l02351"></a>02351                     ErrorNumber.DISK_NOT_FREE,
<a name="l02352"></a>02352                     <span class="stringliteral">&quot;Disk %s is not in DISK.STATUS_FREE mode&quot;</span> % disk.id)
<a name="l02353"></a>02353         <span class="keywordflow">try</span>:
<a name="l02354"></a>02354             sim_pool_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_create_from_disk(
<a name="l02355"></a>02355                 name=pool_name,
<a name="l02356"></a>02356                 raid_type=raid_type,
<a name="l02357"></a>02357                 sim_disk_ids=sim_disk_ids,
<a name="l02358"></a>02358                 element_type=Pool.ELEMENT_TYPE_VOLUME,
<a name="l02359"></a>02359                 unsupported_actions=Pool.UNSUPPORTED_VOLUME_GROW |
<a name="l02360"></a>02360                 Pool.UNSUPPORTED_VOLUME_SHRINK,
<a name="l02361"></a>02361                 strip_size=strip_size)
<a name="l02362"></a>02362         <span class="keywordflow">except</span> sqlite3.IntegrityError <span class="keyword">as</span> sql_error:
<a name="l02363"></a>02363             <span class="keywordflow">raise</span> LsmError(
<a name="l02364"></a>02364                 ErrorNumber.NAME_CONFLICT,
<a name="l02365"></a>02365                 <span class="stringliteral">&quot;Name &apos;%s&apos; is already in use by other volume&quot;</span> % name)
<a name="l02366"></a>02366 
<a name="l02367"></a>02367         sim_pool = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_pool_of_id(sim_pool_id)
<a name="l02368"></a>02368         sim_vol_id = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#a720c825bce313b878e3d1839bbee6984">volume_create</a>(
<a name="l02369"></a>02369             SimArray._sim_id_to_lsm_id(sim_pool_id, <span class="stringliteral">&apos;POOL&apos;</span>), name,
<a name="l02370"></a>02370             sim_pool[<span class="stringliteral">&apos;free_space&apos;</span>], Volume.PROVISION_FULL,
<a name="l02371"></a>02371             _internal_use=<span class="keyword">True</span>, _is_hw_raid_vol=1)
<a name="l02372"></a>02372         sim_vol = self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.sim_vol_of_id(sim_vol_id)
<a name="l02373"></a>02373         self.<a class="code" href="classplugin_1_1sim_1_1simarray_1_1_sim_array.html#ad997f907dc97b4002f0f288e15c918fc">bs_obj</a>.trans_commit()
<a name="l02374"></a>02374         <span class="keywordflow">return</span> SimArray._sim_vol_2_lsm(sim_vol)
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 9 Jul 2015 for libStorageMgmt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
